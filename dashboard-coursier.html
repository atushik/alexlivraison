<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>AlexLivraison Pro</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
  :root{
    --primary:#6b23ff;
    --primary-dark:#501cbd;
    --accent:#00e676;
    --bg:#f8f9fa;
    --text:#1d1d1f;
    --surface:#ffffff;
    --shadow:0 4px 20px rgba(0,0,0,0.08);
  }
  * {box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
  body {
    font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background:var(--bg);
    margin:0; padding:0;
    color:var(--text);
    height:100vh;
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }
  #map-layer {
    position:absolute; top:0; left:0; width:100%; height:100%;
    z-index:0;
  }
  .map-logo {
      position: absolute; top: 20px; left: 20px; width: 45px; height: 45px;
      border-radius: 50%; border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 5; object-fit: cover;
  }
  .ui-layer {
    position:absolute; top:0; left:0; width:100%; height:100%;
    z-index:10;
    pointer-events:none;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
    padding-bottom: 80px;
  }
  .top-status-bar {
    pointer-events:auto;
    background:rgba(255,255,255,0.95);
    backdrop-filter:blur(10px);
    margin:15px; margin-top: 70px;
    padding:15px;
    border-radius:20px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    box-shadow:var(--shadow);
    transition:0.3s;
    width: 90%; align-self: center;
  }
  .top-status-bar.offline { background:#222; color:#fff; }
  .status-pill { display:flex; align-items:center; gap:8px; font-weight:700; }
  .dot {width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 8px var(--accent);}
  .dot.off {background:#ff4d4d; box-shadow:none;}
  .money-pill {
    background:var(--bg); padding:8px 15px; border-radius:15px; font-weight:800; color:var(--primary);
  }
  .go-btn-container {
    pointer-events:auto;
    display:flex; justify-content:center; margin-bottom:20px;
    transition: 0.3s;
  }
  .go-btn {
    width:80px; height:80px;
    border-radius:50%;
    background:var(--primary);
    color:#fff;
    border:4px solid #fff;
    font-weight:900; font-size:1.5em;
    display:flex; align-items:center; justify-content:center;
    box-shadow:0 10px 30px rgba(107,35,255,0.4);
    cursor:pointer;
    transition:0.3s;
  }
  .go-btn.active { background:#ff4d4d; transform:scale(0.9); content: "OFF"; }
  .bottom-sheet {
    pointer-events:auto;
    background:var(--surface);
    border-radius:25px 25px 0 0;
    padding:20px;
    box-shadow:0 -5px 30px rgba(0,0,0,0.1);
    transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    height: 50vh;
    transform: translateY(100%);
    position: absolute; bottom: 0; left: 0; width: 100%;
    display: flex; flex-direction: column;
  }
  .bottom-sheet.visible { transform: translateY(0); bottom: 80px; }
  .sheet-handle { width:40px; height:5px; background:#ddd; border-radius:5px; margin:0 auto 15px auto; flex-shrink: 0; }
  .sheet-content { overflow-y: auto; flex: 1; }
  .order-card {
    background:#fff; border:1px solid #eee; border-radius:18px; padding:15px; margin-bottom:15px;
    box-shadow:0 2px 10px rgba(0,0,0,0.03); position:relative; overflow:hidden;
  }
  .order-card::before { content:''; position:absolute; left:0; top:0; bottom:0; width:5px; background:var(--primary); }
  .order-head {display:flex; justify-content:space-between; margin-bottom:10px;}
  .shop-name {font-weight:800; font-size:1.1em;}
  .order-price {font-weight:800; color:var(--primary); font-size:1.2em;}
  .route-prev {display:flex; align-items:center; gap:10px; margin-bottom:10px; font-size:0.9em; color:#555;}
  .dist-badge {background:#f0f0f0; padding:4px 8px; border-radius:6px; font-size:0.8em; font-weight:700;}
  .btn-accept {
    width:100%; padding:14px; border-radius:12px; border:none; background:var(--primary); color:#fff;
    font-weight:700; font-size:1em; cursor:pointer; margin-top:10px;
  }
  .mission-overlay {
    position:absolute; top:0; left:0; width:100%; height:100%;
    background:#fff; z-index:20; display:none; flex-direction:column;
  }
  .mission-header {
    padding:20px; background:var(--surface); border-bottom:1px solid #eee;
    display:flex; justify-content:space-between; align-items:center;
  }
  .mission-body { flex:1; padding:20px; overflow-y:auto; }
  .step-card {
    background:#f8f9fa; padding:20px; border-radius:15px; text-align:center; margin-bottom:20px;
    border:2px dashed #ddd;
  }
  .step-card.active { border:2px solid var(--primary); background:#f3e5f5; }
  .actions-row { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px; }
  .act-btn {
    padding:15px; border-radius:12px; border:none; font-weight:bold; color:#fff; cursor:pointer;
    display:flex; flex-direction:column; align-items:center; gap:5px;
  }
  .full-view {
    position:absolute; top:0; left:0; width:100%; height:100%;
    background:#f4f6f8; z-index:30; display:none; overflow-y:auto;
    padding-bottom:90px;
  }
  .fv-header { padding:40px 20px 20px; background:#fff; }
  .fv-title { font-size:2em; font-weight:900; margin:0; }
  .chart-box {
    background:#fff; margin:20px; padding:20px; border-radius:20px; box-shadow:var(--shadow);
    display:flex; justify-content:space-between; align-items:flex-end; height:150px;
  }
  .bar { width:10%; background:#eee; border-radius:5px; position:relative; transition:height 1s; }
  .bar.fill { background:var(--primary); }
  .bar::after { content:attr(data-day); position:absolute; bottom:-20px; left:50%; transform:translateX(-50%); font-size:10px; color:#999; }
  .goal-card {
    background:linear-gradient(45deg, #11998e, #38ef7d);
    margin:20px; padding:20px; border-radius:20px; color:#fff;
    display:flex; align-items:center; justify-content:space-between;
  }
  .nav-bar {
    position:fixed; bottom:0; left:0; width:100%; background:rgba(255,255,255,0.95);
    backdrop-filter:blur(10px); border-top:1px solid rgba(0,0,0,0.05);
    display:flex; justify-content:space-around; padding:10px 0; padding-bottom:20px; z-index:50;
  }
  .nav-item {
    display:flex; flex-direction:column; align-items:center; gap:3px; color:#bbb; font-size:0.65em; font-weight:700; cursor:pointer; transition:0.2s; width: 20%;
  }
  .nav-item.active { color:var(--primary); transform:translateY(-2px); }
  .nav-icon { font-size:1.4em; }
  
  .help-item {
      background: #fff; padding: 20px; border-radius: 15px; margin: 15px 20px;
      display: flex; align-items: center; gap: 15px; box-shadow: var(--shadow);
      text-decoration: none; color: var(--text);
  }

  .history-item {
      background: #fff; padding: 15px; border-radius: 15px; margin: 10px 20px;
      display: flex; justify-content: space-between; align-items: center;
      border-left: 4px solid var(--accent);
  }

  .hidden { display:none !important; }
  .anim-pulse { animation: pulse 2s infinite; }
  @keyframes pulse { 0% {transform:scale(1);} 50% {transform:scale(1.05);} 100% {transform:scale(1);} }
  @keyframes stickerFloat {
    0% { transform: translateY(0); } 50% { transform: translateY(-4px); } 100% { transform: translateY(0); }
  }
  .emoji-anim { display: inline-block; animation: stickerFloat 3s ease-in-out infinite; }
</style>
</head>
<body>

<div id="map-layer"></div>
<img src="logo.jpg" class="map-logo">

<div class="ui-layer" id="main-ui">
  <div class="top-status-bar offline" id="topBar">
    <div class="status-pill">
      <div class="dot off" id="statusDot"></div>
      <span id="statusText">Hors ligne</span>
    </div>
    <div class="money-pill" id="todayEarnings">0.00 ‚Ç¨</div>
  </div>

  <div style="margin-top:auto">
    <div class="go-btn-container">
      <div class="go-btn" id="goBtn" onclick="toggleOnline()">GO</div>
    </div>

    <div class="bottom-sheet" id="ordersSheet">
      <div class="sheet-handle"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
          <h3 style="margin:0;color:#888;font-size:0.9em;text-transform:uppercase">Commandes</h3>
          <span id="orderCountBadge" style="background:var(--primary);color:#fff;padding:2px 8px;border-radius:10px;font-size:0.8em">0</span>
      </div>
      <div id="orders-container" class="sheet-content">
        <div style="text-align:center;padding:30px;color:#999;font-weight:500">
          <span class="emoji-anim" style="font-size:2em;display:block;margin-bottom:10px">üí§</span>
          Aucune commande...
        </div>
      </div>
    </div>
  </div>
</div>

<div class="mission-overlay" id="missionView">
  <div class="mission-header">
    <div style="font-weight:bold;font-size:1.2em">Commande #<span id="m-id"></span></div>
    <div style="background:#e3f2fd;color:#1565c0;padding:5px 10px;border-radius:8px;font-weight:bold" id="m-timer">00:00</div>
  </div>
  <div id="map-mission" style="height:30vh;background:#eee"></div>
  <div class="mission-body">
    <div class="step-card active" id="step-box">
      <div style="font-size:2em;margin-bottom:10px" id="step-icon"><span class="emoji-anim">üè™</span></div>
      <h2 style="margin:0" id="step-title">Aller au restaurant</h2>
      <p style="color:#666;margin:5px 0" id="step-addr">Adresse...</p>
    </div>
    <div class="actions-row">
      <button class="act-btn" style="background:#2962ff" onclick="openNav()"><span class="emoji-anim">üó∫Ô∏è</span> GPS</button>
      <button class="act-btn" style="background:#00c853" onclick="callPhone()"><span class="emoji-anim">üìû</span> Appeler</button>
    </div>
    <button class="btn-accept" style="margin-top:20px;background:#333" id="btn-step" onclick="nextStep()">J'arrive</button>
  </div>
</div>

<div class="full-view" id="view-history">
  <div class="fv-header"><h1 class="fv-title">Mes Livraisons <span class="emoji-anim">üì¶</span></h1></div>
  <div id="history-container" style="padding-bottom:20px">
     <div style="text-align:center;padding:40px;color:#999">Historique vide</div>
  </div>
</div>

<div class="full-view" id="view-help">
  <div class="fv-header"><h1 class="fv-title">Aide <span class="emoji-anim">üÜò</span></h1></div>
  <a href="https://wa.me/33677171188" class="help-item">
      <span style="font-size:2em">üí¨</span>
      <div><h3>Support WhatsApp</h3><p>R√©ponse rapide 7j/7</p></div>
  </a>
  <a href="tel:+33677171188" class="help-item">
      <span style="font-size:2em">üìû</span>
      <div><h3>Urgence</h3><p>Appeler le support</p></div>
  </a>
  <div class="help-item">
      <span style="font-size:2em">‚ùì</span>
      <div><h3>FAQ</h3><p>Questions fr√©quentes</p></div>
  </div>
</div>

<div class="full-view" id="view-profile">
  <div class="fv-header"><h1 class="fv-title">Profil <span class="emoji-anim">üë§</span></h1></div>
  <div style="text-align:center;padding:20px">
    <div style="width:80px;height:80px;background:#ddd;border-radius:50%;margin:0 auto 15px;display:flex;align-items:center;justify-content:center;font-size:2em"><span class="emoji-anim">üö¥</span></div>
    <h2 id="profileName">Coursier</h2>
    <div style="display:flex;justify-content:center;gap:10px;margin-top:10px">
      <span style="background:#fff;padding:5px 10px;border-radius:8px;font-weight:bold"><span class="emoji-anim">‚≠ê</span> 4.9</span>
      <span style="background:#fff;padding:5px 10px;border-radius:8px;font-weight:bold"><span class="emoji-anim">üëç</span> 98%</span>
    </div>
  </div>
  <div class="chart-box">
    <div class="bar fill" style="height:40%" data-day="L"></div>
    <div class="bar fill" style="height:60%" data-day="M"></div>
    <div class="bar fill" style="height:30%" data-day="M"></div>
    <div class="bar fill" style="height:80%" data-day="J"></div>
    <div class="bar" style="height:10%" data-day="V"></div>
    <div class="bar" style="height:0%" data-day="S"></div>
    <div class="bar" style="height:0%" data-day="D"></div>
  </div>
  <div style="padding:20px">
    <button class="btn-accept" style="background:#ff4d4d" onclick="logout()">D√©connexion</button>
  </div>
</div>

<div class="nav-bar">
  <div class="nav-item active" onclick="switchTab('home')">
    <div class="nav-icon"><span class="emoji-anim">‚ö°</span></div>
    <div>Courses</div>
  </div>
  <div class="nav-item" onclick="switchTab('mission')">
    <div class="nav-icon"><span class="emoji-anim">üéí</span></div>
    <div>En cours</div>
  </div>
  <div class="nav-item" onclick="switchTab('history')">
    <div class="nav-icon"><span class="emoji-anim">üì¶</span></div>
    <div>Livraisons</div>
  </div>
  <div class="nav-item" onclick="switchTab('help')">
    <div class="nav-icon"><span class="emoji-anim">üÜò</span></div>
    <div>Aide</div>
  </div>
  <div class="nav-item" onclick="switchTab('profile')">
    <div class="nav-icon"><span class="emoji-anim">üë§</span></div>
    <div>Profil</div>
  </div>
</div>

<script>
const firebaseConfig={apiKey:"AIzaSyAWagPwv5Skh_EHfdcnFTYeG-xltRM7yPc",authDomain:"alex-livraison.firebaseapp.com",projectId:"alex-livraison",storageBucket:"alex-livraison.firebasestorage.app",messagingSenderId:"937475497279",appId:"1:937475497279:web:62dc9eba8e77a5113ec78a"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

if(!localStorage.getItem('alex_courier_logged')) window.location.href='login-coursier.html';
document.getElementById('profileName').innerText = localStorage.getItem('alex_courier_name') || 'Partenaire';

let map, isOnline = false, currentStep = 0, currentOrder = null;
let earnings = 0;

function initMap() {
  map = L.map('map-layer', {zoomControl: false, attributionControl: false}).setView([43.1242, 5.928], 13);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
  const icon = L.divIcon({
      html: '<div style="font-size:24px;transform:translate(-10px,-10px)"><span class="emoji-anim">üö¥</span></div>',
      className: 'marker-c', iconSize: [30, 30]
  });
  L.marker([43.1242, 5.928], {icon: icon}).addTo(map);
}

function toggleOnline() {
    isOnline = !isOnline;
    const btn = document.getElementById('goBtn');
    const bar = document.getElementById('topBar');
    const dot = document.getElementById('statusDot');
    const txt = document.getElementById('statusText');
    const sheet = document.getElementById('ordersSheet');
    
    if (isOnline) {
        btn.innerText = "ON";
        btn.classList.remove('active');
        bar.classList.remove('offline');
        dot.classList.remove('off');
        txt.innerText = "En ligne";
        sheet.classList.add('visible');
        loadOrders();
    } else {
        btn.innerText = "GO";
        btn.classList.add('active');
        bar.classList.add('offline');
        dot.classList.add('off');
        txt.innerText = "Hors ligne";
        sheet.classList.remove('visible');
    }
}
document.getElementById('goBtn').classList.add('active');

function loadOrders() {
    if(!isOnline) return;
    db.collection('orders').where('status', '==', 'pending').onSnapshot(snap => {
        const container = document.getElementById('orders-container');
        const badge = document.getElementById('orderCountBadge');
        container.innerHTML = '';
        badge.innerText = snap.size;
        
        if (snap.empty) {
            container.innerHTML = '<div style="text-align:center;padding:30px;color:#999"><span class="emoji-anim" style="font-size:2em">üí§</span><br>En attente...</div>';
            return;
        }

        snap.forEach(doc => {
            const o = doc.data();
            const card = document.createElement('div');
            card.className = 'order-card anim-pulse';
            card.innerHTML = `
                <div class="order-head">
                    <div class="shop-name">${o.shopName}</div>
                    <div class="order-price">${o.price} ‚Ç¨</div>
                </div>
                <div class="route-prev">
                    <span class="dist-badge">2.5 km</span>
                    <span>${o.from} ‚ûù ${o.to}</span>
                </div>
                <button class="btn-accept">ACCEPTER LA COURSE</button>
            `;
            card.querySelector('button').onclick = () => startMission(doc.id, o);
            container.appendChild(card);
        });
    });
}

function startMission(id, data) {
    currentOrder = {id, ...data};
    
    db.collection('orders').doc(id).update({
        status: 'accepted',
        courier: localStorage.getItem('alex_courier_name')
    });

    document.getElementById('main-ui').classList.add('hidden');
    document.getElementById('missionView').style.display = 'flex';
    switchTab('mission');
    
    const missionMap = L.map('map-mission').setView([43.1242, 5.928], 14);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(missionMap);
    
    document.getElementById('m-id').innerText = id.substr(0,4);
    updateStep(1);
}

function updateStep(step) {
    currentStep = step;
    const title = document.getElementById('step-title');
    const addr = document.getElementById('step-addr');
    const icon = document.getElementById('step-icon');
    const btn = document.getElementById('btn-step');

    if (step === 1) {
        title.innerText = "Aller au restaurant";
        addr.innerText = currentOrder.from;
        icon.innerHTML = '<span class="emoji-anim">üè™</span>';
        btn.innerText = "Je suis arriv√©";
    } else if (step === 2) {
        title.innerText = "R√©cup√©rer la commande";
        addr.innerText = "V√©rifiez le num√©ro #" + currentOrder.id.substr(0,4);
        icon.innerHTML = '<span class="emoji-anim">üéí</span>';
        btn.innerText = "Commande r√©cup√©r√©e";
        btn.style.background = "#ff9800";
    } else if (step === 3) {
        title.innerText = "Livrer au client";
        addr.innerText = currentOrder.to;
        icon.innerHTML = '<span class="emoji-anim">üè†</span>';
        btn.innerText = "Confirmer la livraison";
        btn.style.background = "#00c853";
    } else {
        finishMission();
    }
}

function nextStep() {
    updateStep(currentStep + 1);
}

function finishMission() {
    alert("Course termin√©e ! + " + currentOrder.price + "‚Ç¨");
    earnings += currentOrder.price;
    document.getElementById('todayEarnings').innerText = earnings.toFixed(2) + " ‚Ç¨";
    
    const historyCont = document.getElementById('history-container');
    if(historyCont.innerHTML.includes('vide')) historyCont.innerHTML = '';
    
    const item = `
    <div class="history-item">
        <div>
           <div style="font-weight:bold">${currentOrder.shopName}</div>
           <div style="font-size:0.8em;color:#999">Termin√© √† l'instant</div>
        </div>
        <div style="color:#00c853;font-weight:bold">+${currentOrder.price} ‚Ç¨</div>
    </div>`;
    historyCont.innerHTML = item + historyCont.innerHTML;

    document.getElementById('missionView').style.display = 'none';
    document.getElementById('main-ui').classList.remove('hidden');
    switchTab('home');
    currentOrder = null;
}

function openNav() {
    const dest = currentStep === 3 ? currentOrder.to : currentOrder.from;
    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(dest)}`, '_blank');
}
function callPhone() { window.location.href = "tel:0600000000"; }

function switchTab(tab) {
    document.querySelectorAll('.full-view').forEach(e => e.style.display = 'none');
    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
    
    if (tab === 'home') {
       document.getElementById('missionView').style.display = currentOrder ? 'flex' : 'none';
    } else if (tab === 'mission') {
       if(currentOrder) document.getElementById('missionView').style.display = 'flex';
       else alert("Aucune mission en cours");
    } else {
        document.getElementById('view-' + tab).style.display = 'block';
    }
    
    const mapIdx = {'home':0, 'mission':1, 'history':2, 'help':3, 'profile':4};
    if(document.querySelectorAll('.nav-item')[mapIdx[tab]]) {
        document.querySelectorAll('.nav-item')[mapIdx[tab]].classList.add('active');
    }
}

function logout() {
    if(confirm("D√©connexion ?")) {
        localStorage.removeItem('alex_courier_logged');
        window.location.href = 'login-coursier.html';
    }
}

window.onload = initMap;
</script>
</body>
</html> 
