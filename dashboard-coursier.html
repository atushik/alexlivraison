<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>AlexLivraison Pro</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
  :root{
    --primary:#6b23ff;
    --primary-dark:#501cbd;
    --accent:#00e676;
    --bg:#f8f9fa;
    --text:#1d1d1f;
    --gray:#8e8e93;
    --surface:#ffffff;
    --shadow:0 4px 20px rgba(0,0,0,0.08);
  }
  * {box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
  body {
    font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background:var(--bg);
    margin:0; padding:0;
    color:var(--text);
    height:100vh;
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }

  #map-layer {
    position:absolute; top:0; left:0; width:100%; height:100%;
    z-index:0;
  }

  .ui-layer {
    position:absolute; top:0; left:0; width:100%; height:100%;
    z-index:10;
    pointer-events:none;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }

  .top-status-bar {
    pointer-events:auto;
    background:rgba(255,255,255,0.95);
    backdrop-filter:blur(10px);
    margin:15px;
    padding:15px;
    border-radius:20px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    box-shadow:var(--shadow);
    transition:0.3s;
  }
  .top-status-bar.offline { background:#333; color:#fff; }
  
  .status-pill {
    display:flex; align-items:center; gap:8px;
    font-weight:700; font-size:1em;
  }
  .dot {width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 8px var(--accent);}
  .dot.off {background:#ff4d4d; box-shadow:none;}
  
  .money-pill {
    background:var(--bg); padding:8px 15px; border-radius:15px; font-weight:800; color:var(--primary);
  }

  .go-btn-container {
    pointer-events:auto;
    display:flex; justify-content:center; margin-bottom:20px;
  }
  .go-btn {
    width:80px; height:80px;
    border-radius:50%;
    background:var(--primary);
    color:#fff;
    border:4px solid #fff;
    font-weight:900; font-size:1.2em;
    display:flex; align-items:center; justify-content:center;
    box-shadow:0 10px 30px rgba(107,35,255,0.4);
    cursor:pointer;
    transition:0.3s;
  }
  .go-btn.active { background:#ff4d4d; transform:scale(0.9); }

  .bottom-sheet {
    pointer-events:auto;
    background:var(--surface);
    border-radius:25px 25px 0 0;
    padding:20px;
    padding-bottom:90px; 
    box-shadow:0 -5px 30px rgba(0,0,0,0.1);
    transition:transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    max-height:60vh;
    overflow-y:auto;
  }
  .sheet-handle {
    width:40px; height:5px; background:#ddd; border-radius:5px; margin:0 auto 15px auto;
  }

  .order-card {
    background:#fff; border:1px solid #eee; border-radius:18px; padding:15px; margin-bottom:15px;
    box-shadow:0 2px 10px rgba(0,0,0,0.03); position:relative; overflow:hidden;
  }
  .order-card::before {
    content:''; position:absolute; left:0; top:0; bottom:0; width:5px; background:var(--primary);
  }
  .order-head {display:flex; justify-content:space-between; margin-bottom:10px;}
  .shop-name {font-weight:800; font-size:1.1em;}
  .order-price {font-weight:800; color:var(--primary); font-size:1.2em;}
  
  .route-prev {display:flex; align-items:center; gap:10px; margin-bottom:10px; font-size:0.9em; color:#555;}
  .dist-badge {background:#f0f0f0; padding:4px 8px; border-radius:6px; font-size:0.8em; font-weight:700;}

  .btn-accept {
    width:100%; padding:14px; border-radius:12px; border:none; background:var(--primary); color:#fff;
    font-weight:700; font-size:1em; cursor:pointer; margin-top:10px;
  }

  .mission-overlay {
    position:absolute; top:0; left:0; width:100%; height:100%;
    background:#fff; z-index:20; display:none; flex-direction:column;
  }
  .mission-header {
    padding:20px; background:var(--surface); border-bottom:1px solid #eee;
    display:flex; justify-content:space-between; align-items:center;
  }
  .mission-body { flex:1; padding:20px; overflow-y:auto; }
  .step-card {
    background:#f8f9fa; padding:20px; border-radius:15px; text-align:center; margin-bottom:20px;
    border:2px dashed #ddd;
  }
  .step-card.active { border:2px solid var(--primary); background:#f3e5f5; }
  
  .actions-row { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px; }
  .act-btn {
    padding:15px; border-radius:12px; border:none; font-weight:bold; color:#fff; cursor:pointer;
    display:flex; flex-direction:column; align-items:center; gap:5px;
  }

  .full-view {
    position:absolute; top:0; left:0; width:100%; height:100%;
    background:#f4f6f8; z-index:30; display:none; overflow-y:auto;
    padding-bottom:80px;
  }
  .fv-header { padding:40px 20px 20px; background:#fff; }
  .fv-title { font-size:2em; font-weight:900; margin:0; }
  
  .chart-box {
    background:#fff; margin:20px; padding:20px; border-radius:20px; box-shadow:var(--shadow);
    display:flex; justify-content:space-between; align-items:flex-end; height:150px;
  }
  .bar { width:10%; background:#eee; border-radius:5px; position:relative; transition:height 1s; }
  .bar.fill { background:var(--primary); }
  .bar::after { content:attr(data-day); position:absolute; bottom:-20px; left:50%; transform:translateX(-50%); font-size:10px; color:#999; }

  .goal-card {
    background:linear-gradient(45deg, #11998e, #38ef7d);
    margin:20px; padding:20px; border-radius:20px; color:#fff;
    display:flex; align-items:center; justify-content:space-between;
  }

  .nav-bar {
    position:absolute; bottom:0; left:0; width:100%; background:rgba(255,255,255,0.95);
    backdrop-filter:blur(10px); border-top:1px solid rgba(0,0,0,0.05);
    display:flex; justify-content:space-around; padding:12px 0; padding-bottom:25px; z-index:50;
  }
  .nav-item {
    display:flex; flex-direction:column; align-items:center; gap:4px; color:#bbb; font-size:0.7em; font-weight:700; cursor:pointer; transition:0.2s;
  }
  .nav-item.active { color:var(--primary); transform:translateY(-2px); }
  .nav-icon { font-size:1.6em; }

  .hidden { display:none !important; }
  .anim-pulse { animation: pulse 2s infinite; }
  @keyframes pulse { 0% {transform:scale(1);} 50% {transform:scale(1.05);} 100% {transform:scale(1);} }
</style>
</head>
<body>

<div id="map-layer"></div>

<div class="ui-layer" id="main-ui">
  <div class="top-status-bar" id="topBar">
    <div class="status-pill">
      <div class="dot" id="statusDot"></div>
      <span id="statusText">En ligne</span>
    </div>
    <div class="money-pill" id="todayEarnings">0.00 ‚Ç¨</div>
  </div>

  <div style="margin-top:auto">
    <div class="go-btn-container">
      <div class="go-btn" id="goBtn" onclick="toggleOnline()">GO</div>
    </div>

    <div class="bottom-sheet" id="ordersSheet">
      <div class="sheet-handle"></div>
      <h3 style="margin:0 0 15px 0;color:#888;font-size:0.9em;text-transform:uppercase">Commandes disponibles</h3>
      <div id="orders-container">
        <div style="text-align:center;padding:30px;color:#999;font-weight:500">
          <span style="font-size:2em;display:block;margin-bottom:10px">üí§</span>
          En attente de commandes...
        </div>
      </div>
    </div>
  </div>
</div>

<div class="mission-overlay" id="missionView">
  <div class="mission-header">
    <div style="font-weight:bold;font-size:1.2em">Commande #<span id="m-id"></span></div>
    <div style="background:#e3f2fd;color:#1565c0;padding:5px 10px;border-radius:8px;font-weight:bold" id="m-timer">00:00</div>
  </div>
  <div id="map-mission" style="height:30vh;background:#eee"></div>
  <div class="mission-body">
    <div class="step-card active" id="step-box">
      <div style="font-size:2em;margin-bottom:10px" id="step-icon">üè™</div>
      <h2 style="margin:0" id="step-title">Aller au restaurant</h2>
      <p style="color:#666;margin:5px 0" id="step-addr">Adresse...</p>
    </div>

    <div class="actions-row">
      <button class="act-btn" style="background:#2962ff" onclick="openNav()">
        <span>üó∫Ô∏è</span> GPS
      </button>
      <button class="act-btn" style="background:#00c853" onclick="callPhone()">
        <span>üìû</span> Appeler
      </button>
    </div>
    
    <button class="btn-accept" style="margin-top:20px;background:#333" id="btn-step" onclick="nextStep()">
      J'arrive au restaurant
    </button>
  </div>
</div>

<div class="full-view" id="view-wallet">
  <div class="fv-header">
    <h1 class="fv-title">Gains</h1>
  </div>
  <div class="goal-card">
    <div>
      <div style="font-size:0.9em;opacity:0.9">Objectif du jour</div>
      <div style="font-size:1.5em;font-weight:800">85‚Ç¨ / 100‚Ç¨</div>
    </div>
    <div style="font-size:2.5em">üéØ</div>
  </div>
  <div class="chart-box">
    <div class="bar fill" style="height:40%" data-day="L"></div>
    <div class="bar fill" style="height:60%" data-day="M"></div>
    <div class="bar fill" style="height:30%" data-day="M"></div>
    <div class="bar fill" style="height:80%" data-day="J"></div>
    <div class="bar" style="height:10%" data-day="V"></div>
    <div class="bar" style="height:0%" data-day="S"></div>
    <div class="bar" style="height:0%" data-day="D"></div>
  </div>
  <div style="padding:20px">
    <h3>Historique</h3>
    <div id="wallet-history"></div>
  </div>
</div>

<div class="full-view" id="view-profile">
  <div class="fv-header">
    <h1 class="fv-title">Profil</h1>
  </div>
  <div style="text-align:center;padding:20px">
    <div style="width:80px;height:80px;background:#ddd;border-radius:50%;margin:0 auto 15px;display:flex;align-items:center;justify-content:center;font-size:2em">üö¥</div>
    <h2 id="profileName">Coursier</h2>
    <div style="display:flex;justify-content:center;gap:10px;margin-top:10px">
      <span style="background:#fff;padding:5px 10px;border-radius:8px;font-weight:bold">‚≠ê 4.9</span>
      <span style="background:#fff;padding:5px 10px;border-radius:8px;font-weight:bold">üëç 98%</span>
    </div>
  </div>
  <div style="padding:20px">
    <div class="order-card">
      <div class="order-head"><span>V√©hicule</span><span>üõµ Scooter</span></div>
    </div>
    <div class="order-card">
      <div class="order-head"><span>Documents</span><span style="color:green">Valid√©s</span></div>
    </div>
    <button class="btn-accept" style="background:#ff4d4d" onclick="logout()">D√©connexion</button>
  </div>
</div>

<div class="nav-bar">
  <div class="nav-item active" onclick="switchTab('home')">
    <div class="nav-icon">‚ö°</div>
    <div>Mission</div>
  </div>
  <div class="nav-item" onclick="switchTab('wallet')">
    <div class="nav-icon">üìä</div>
    <div>Gains</div>
  </div>
  <div class="nav-item" onclick="switchTab('profile')">
    <div class="nav-icon">üë§</div>
    <div>Profil</div>
  </div>
</div>

<script>
const firebaseConfig={apiKey:"AIzaSyAWagPwv5Skh_EHfdcnFTYeG-xltRM7yPc",authDomain:"alex-livraison.firebaseapp.com",projectId:"alex-livraison",storageBucket:"alex-livraison.firebasestorage.app",messagingSenderId:"937475497279",appId:"1:937475497279:web:62dc9eba8e77a5113ec78a"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

if(!localStorage.getItem('alex_courier_logged')) window.location.href='login-coursier.html';
document.getElementById('profileName').innerText = localStorage.getItem('alex_courier_name') || 'Partenaire';

let map, isOnline = true, currentStep = 0, currentOrder = null;
let earnings = 0;

function initMap() {
  map = L.map('map-layer', {zoomControl: false}).setView([43.1242, 5.928], 13);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
  const icon = L.divIcon({
      html: '<div style="font-size:24px;transform:translate(-10px,-10px)">üö¥</div>',
      className: 'marker-c', iconSize: [30, 30]
  });
  L.marker([43.1242, 5.928], {icon: icon}).addTo(map);
}

function toggleOnline() {
    isOnline = !isOnline;
    const btn = document.getElementById('goBtn');
    const bar = document.getElementById('topBar');
    const dot = document.getElementById('statusDot');
    const txt = document.getElementById('statusText');
    
    if (isOnline) {
        btn.innerText = "GO";
        btn.classList.remove('active');
        bar.classList.remove('offline');
        dot.classList.remove('off');
        txt.innerText = "En ligne";
        loadOrders();
    } else {
        btn.innerText = "OFF";
        btn.classList.add('active');
        bar.classList.add('offline');
        dot.classList.add('off');
        txt.innerText = "Hors ligne";
        document.getElementById('orders-container').innerHTML = '<div style="text-align:center;padding:30px;opacity:0.5">Vous √™tes hors ligne</div>';
    }
}

function loadOrders() {
    if(!isOnline) return;
    db.collection('orders').where('status', '==', 'pending').onSnapshot(snap => {
        const container = document.getElementById('orders-container');
        container.innerHTML = '';
        
        if (snap.empty) {
            container.innerHTML = '<div style="text-align:center;padding:30px;color:#999">Recherche de commandes...<br>Rapprochez-vous du centre.</div>';
            return;
        }

        snap.forEach(doc => {
            const o = doc.data();
            const card = document.createElement('div');
            card.className = 'order-card anim-pulse';
            card.innerHTML = `
                <div class="order-head">
                    <div class="shop-name">${o.shopName}</div>
                    <div class="order-price">${o.price} ‚Ç¨</div>
                </div>
                <div class="route-prev">
                    <span class="dist-badge">2.5 km</span>
                    <span>${o.from} ‚ûù ${o.to}</span>
                </div>
                <button class="btn-accept">ACCEPTER</button>
            `;
            card.querySelector('button').onclick = () => startMission(doc.id, o);
            container.appendChild(card);
        });
    });
}

function startMission(id, data) {
    currentOrder = {id, ...data};
    
    db.collection('orders').doc(id).update({
        status: 'accepted',
        courier: localStorage.getItem('alex_courier_name')
    });

    document.getElementById('main-ui').classList.add('hidden');
    document.getElementById('missionView').style.display = 'flex';
    
    const missionMap = L.map('map-mission').setView([43.1242, 5.928], 14);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(missionMap);
    
    document.getElementById('m-id').innerText = id.substr(0,4);
    updateStep(1);
}

function updateStep(step) {
    currentStep = step;
    const title = document.getElementById('step-title');
    const addr = document.getElementById('step-addr');
    const icon = document.getElementById('step-icon');
    const btn = document.getElementById('btn-step');

    if (step === 1) {
        title.innerText = "Aller au restaurant";
        addr.innerText = currentOrder.from;
        icon.innerText = "üè™";
        btn.innerText = "Je suis arriv√©";
    } else if (step === 2) {
        title.innerText = "R√©cup√©rer la commande";
        addr.innerText = "V√©rifiez le num√©ro #" + currentOrder.id.substr(0,4);
        icon.innerText = "üéí";
        btn.innerText = "Commande r√©cup√©r√©e";
        btn.style.background = "#ff9800";
    } else if (step === 3) {
        title.innerText = "Livrer au client";
        addr.innerText = currentOrder.to;
        icon.innerText = "üè†";
        btn.innerText = "Confirmer la livraison";
        btn.style.background = "#00c853";
    } else {
        finishMission();
    }
}

function nextStep() {
    updateStep(currentStep + 1);
}

function finishMission() {
    alert("Course termin√©e ! + " + currentOrder.price + "‚Ç¨");
    earnings += currentOrder.price;
    document.getElementById('todayEarnings').innerText = earnings.toFixed(2) + " ‚Ç¨";
    
    const list = document.getElementById('wallet-history');
    list.innerHTML = `<div class="history-item"><span>${currentOrder.shopName}</span><b>+${currentOrder.price}‚Ç¨</b></div>` + list.innerHTML;

    document.getElementById('missionView').style.display = 'none';
    document.getElementById('main-ui').classList.remove('hidden');
    currentOrder = null;
}

function openNav() {
    const dest = currentStep === 3 ? currentOrder.to : currentOrder.from;
    window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}`, '_blank');
}
function callPhone() { window.location.href = "tel:0600000000"; }

function switchTab(tab) {
    document.querySelectorAll('.full-view').forEach(e => e.style.display = 'none');
    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
    
    if (tab === 'home') {
    } else {
        document.getElementById('view-' + tab).style.display = 'block';
    }
    const idx = ['home','wallet','profile'].indexOf(tab);
    document.querySelectorAll('.nav-item')[idx].classList.add('active');
}

function logout() {
    if(confirm("D√©connexion ?")) {
        localStorage.removeItem('alex_courier_logged');
        window.location.href = 'login-coursier.html';
    }
}

window.onload = initMap;
</script>
</body>
</html> 
