<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Produits des Partenaires | AlexLivraison</title>
  <meta name="description" content="Catalogue des produits de nos partenaires. Commandez en 30 secondes avec AlexLivraison."/>
  <meta name="theme-color" content="#6b23ff"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="apple-touch-icon" href="logo.jpg"/>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='32' fill='%236b23ff'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='34' fill='white'%3E‚ö°%3C/text%3E%3C/svg%3E"/>
  <style>
    :root{--violet:#6b23ff;--violet-2:#5b18ff;--violet-dark:#32006b;--bg:linear-gradient(180deg,#32006b,#7a2cf5);--ring:#ffffff2e;--ink:#1e1b2d}
    html,body{height:100%;margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#fff}
    *{box-sizing:border-box}
    .wrap{max-width:1120px;margin:0 auto;padding:16px}
    .topbar{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(20,0,45,.86),rgba(20,0,45,.52));backdrop-filter:saturate(160%) blur(12px);border-bottom:1px solid var(--ring)}
    .topbar-inner{display:flex;align-items:center;justify-content:space-between;padding:10px 12px}
    .brand{display:flex;gap:10px;align-items:center}
    .brand img{width:120px;height:auto;cursor:pointer;border-radius:8px}
    .actions{display:flex;gap:8px}
    .btn{display:inline-flex;align-items:center;justify-content:center;border:none;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--violet);color:#fff}
    .btn-primary:hover{background:var(--violet-2)}
    .btn-ghost{background:#ffffff18;color:#fff;border:1px solid #ffffff2e}
    .btn-ghost:hover{background:#ffffff28}
    .hero{padding:22px 12px 6px 12px;text-align:center}
    .h1{margin:4px 0 6px 0;font-weight:900}
    .muted{color:#d9d0ff}
    .controls{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin:14px 0 6px}
    .filters{display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:#ffffff18;border:1px solid #ffffff33;color:#fff;padding:8px 12px;border-radius:999px;font-weight:700;cursor:pointer}
    .chip.active{background:#fff;color:#32006b}
    .bar{display:flex;gap:8px;flex-wrap:wrap}
    .input{flex:1;min-width:200px}
    .input input, .select select{width:100%;padding:12px;border-radius:12px;border:1px solid #d7d7e4;outline:none}
    .select select{background:#fff}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin:14px 0 24px}
    .card{background:#fff;color:var(--ink);border-radius:14px;overflow:hidden;box-shadow:0 10px 34px rgba(0,0,0,.18);display:flex;flex-direction:column}
    .pic{height:170px;background:#f2f1f8;display:grid;place-items:center}
    .pic img{width:100%;height:100%;object-fit:cover}
    .body{padding:12px 14px;display:flex;flex-direction:column;gap:8px}
    .title{font-weight:900}
    .desc{opacity:.8;font-size:14px;min-height:34px}
    .meta{display:flex;gap:6px;flex-wrap:wrap}
    .tag{font-size:12px;background:#eef0ff;border:1px solid #dfe3ff;color:#2b2a44;border-radius:999px;padding:4px 8px}
    .row{display:flex;align-items:center;justify-content:space-between;margin-top:2px}
    .price{font-weight:900}
    .footer{color:#d9d0ff;text-align:center;margin:16px 0 36px}
    .toast{position:fixed;bottom:18px;right:18px;background:#22c55e;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.35);opacity:0;transform:translateY(10px);transition:.3s;z-index:80;font-weight:700}
    .toast.show{opacity:1;transform:translateY(0)}
    .modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:70}
    .modal.show{display:flex}
    .sheet{background:#fff;color:#1d1b2b;border-radius:16px;max-width:560px;width:92%;padding:16px;box-shadow:0 30px 70px rgba(0,0,0,.35)}
    .sheet h3{margin:0 0 8px 0}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .sheet label{display:block;margin-top:8px;font-weight:700}
    .sheet input,.sheet textarea,.sheet select{width:100%;padding:10px;border:1px solid #cfd0d8;border-radius:10px;outline:none}
    .actionsX{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .loader{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:90;align-items:center;justify-content:center;color:#fff;font-size:20px}
    @media(max-width:820px){.controls{grid-template-columns:1fr}.grid2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner wrap">
      <div class="brand">
        <img src="logo.jpg" alt="AlexLivraison" onclick="window.location.href='index.html'"/>
        <div class="muted">Produits des partenaires</div>
      </div>
      <div class="actions">
        <button class="btn btn-ghost" id="btn-fr">FR</button>
        <button class="btn btn-ghost" id="btn-en">EN</button>
        <a class="btn btn-primary" href="https://t.me/alexlivraison_bot" target="_blank" rel="noopener">Ouvrir le chat</a>
      </div>
    </div>
  </div>

  <header class="hero wrap">
    <div class="muted" id="eyebrow">Catalogue</div>
    <h1 class="h1" id="title">Produits & Boutiques partenaires</h1>
    <div class="muted" id="desc">Trouvez vos produits et commandez en 30 secondes.</div>
  </header>

  <main class="wrap">
    <div class="controls">
      <div class="filters" id="filters"></div>
      <div class="bar">
        <div class="input"><input id="q" placeholder="Rechercher un produit‚Ä¶"></div>
        <div class="select">
          <select id="partnerSelect">
            <option value="all">Tous les partenaires</option>
          </select>
        </div>
        <div class="select">
          <select id="sort">
            <option value="default">Trier</option>
            <option value="asc">Prix croissant</option>
            <option value="desc">Prix d√©croissant</option>
            <option value="new">Nouveaut√©s</option>
          </select>
        </div>
      </div>
    </div>

    <div class="grid" id="grid"></div>
  </main>

  <div class="footer wrap">¬© 2025 AlexLivraison ‚Äî Livraison locale rapide</div>

  <div class="modal" id="orderModal" aria-modal="true" role="dialog">
    <div class="sheet">
      <h3 id="m_title">Commander</h3>
      <div class="muted" id="m_sub">Compl√©tez vos informations pour finaliser la demande.</div>
      <div class="grid2">
        <div>
          <label id="m_label_name" for="m_name">Nom du client</label>
          <input id="m_name" autocomplete="name" placeholder="Jean Dupont">
        </div>
        <div>
          <label id="m_label_phone" for="m_phone">T√©l√©phone</label>
          <input id="m_phone" autocomplete="tel" placeholder="+33 6 12 34 56 78">
        </div>
      </div>
      <label id="m_label_from" for="m_from">Adresse de d√©part (magasin)</label>
      <input id="m_from" placeholder="Ex: Carrefour Mayol, Toulon">
      <label id="m_label_to" for="m_to">Adresse de destination</label>
      <input id="m_to" placeholder="Ex: 241 Rue Le Corbusier, La Seyne">
      <label id="m_label_note" for="m_note">Remarque</label>
      <textarea id="m_note" placeholder="Code porte, √©tage, etc."></textarea>
      <div class="muted" id="m_hint" style="font-size:12px;margin-top:6px">Un r√©capitulatif sera envoy√© √† AlexLivraison (Telegram).</div>
      <div class="actionsX">
        <button class="btn btn-ghost" id="m_cancel">Annuler</button>
        <button class="btn btn-primary" id="m_send">Envoyer</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <div class="loader" id="loader">‚è≥ Envoi en cours‚Ä¶</div>

  <script>
    const API="https://alexlivraison-api.onrender.com";
    const grid=document.getElementById("grid");
    const q=document.getElementById("q");
    const sort=document.getElementById("sort");
    const filters=document.getElementById("filters");
    const partnerSelect=document.getElementById("partnerSelect");
    const toast=document.getElementById("toast");
    const loader=document.getElementById("loader");
    const btnFR=document.getElementById("btn-fr");
    const btnEN=document.getElementById("btn-en");

    const orderModal=document.getElementById("orderModal");
    const mTitle=document.getElementById("m_title");
    const mName=document.getElementById("m_name");
    const mPhone=document.getElementById("m_phone");
    const mFrom=document.getElementById("m_from");
    const mTo=document.getElementById("m_to");
    const mNote=document.getElementById("m_note");
    const mCancel=document.getElementById("m_cancel");
    const mSend=document.getElementById("m_send");

    const i18n={
      fr:{eyebrow:"Catalogue",title:"Produits & Boutiques partenaires",desc:"Trouvez vos produits et commandez en 30 secondes.",all:"Tous",search:"Rechercher un produit‚Ä¶",orderBtn:"Commander",modalTitle:"Commander",modalSub:"Compl√©tez vos informations pour finaliser la demande.",name:"Nom du client",phone:"T√©l√©phone",from:"Adresse de d√©part (magasin)",to:"Adresse de destination",note:"Remarque",hint:"Un r√©capitulatif sera envoy√© √† AlexLivraison (Telegram).",cancel:"Annuler",send:"Envoyer",fillAll:"Veuillez compl√©ter tous les champs obligatoires.",sentOk:"Commande envoy√©e ‚úÖ",sentErr:"Erreur lors de l‚Äôenvoi ‚ùå"},
      en:{eyebrow:"Catalog",title:"Partner Products & Shops",desc:"Find items and order in 30 seconds.",all:"All",search:"Search a product‚Ä¶",orderBtn:"Order",modalTitle:"Order",modalSub:"Fill in your details to finalize.",name:"Customer name",phone:"Phone",from:"Pickup address (shop)",to:"Delivery address",note:"Note",hint:"A summary will be sent to AlexLivraison (Telegram).",cancel:"Cancel",send:"Send",fillAll:"Please fill in all required fields.",sentOk:"Order sent ‚úÖ",sentErr:"Sending error ‚ùå"}
    };
    let strings=i18n.fr;
    function setLang(lang){
      strings=lang==="en"?i18n.en:i18n.fr;
      document.getElementById("eyebrow").textContent=strings.eyebrow;
      document.getElementById("title").textContent=strings.title;
      document.getElementById("desc").textContent=strings.desc;
      q.placeholder=strings.search;
      document.getElementById("m_sub").textContent=strings.modalSub;
      document.getElementById("m_label_name").textContent=strings.name;
      document.getElementById("m_label_phone").textContent=strings.phone;
      document.getElementById("m_label_from").textContent=strings.from;
      document.getElementById("m_label_to").textContent=strings.to;
      document.getElementById("m_label_note").textContent=strings.note;
      document.getElementById("m_hint").textContent=strings.hint;
      render();
    }
    btnFR.onclick=()=>setLang("fr");
    btnEN.onclick=()=>setLang("en");

    function toastShow(msg,color="#22c55e"){toast.textContent=msg;toast.style.background=color;toast.classList.add("show");setTimeout(()=>toast.classList.remove("show"),2800)}
    function fmtPrice(v){return (Number(v).toFixed(2)+" ‚Ç¨").replace(".",",")}
    function imgFallback(img){img.onerror=null;img.src="https://source.unsplash.com/featured/600x400?grocery,store"}

    let allProducts=[];
    let categories=[];
    let partners=[];

    async function loadProducts(){
      try{
        const r=await fetch(API+"/products",{headers:{accept:"application/json"}});
        if(!r.ok) throw new Error("bad status");
        const json=await r.json();
        allProducts=Array.isArray(json)?json:json.products||[];
        if(!allProducts.length) throw new Error("empty");
      }catch(e){
        allProducts=[
          {id:"d1",name:"Panier fruits frais",price:9.9,img:"https://source.unsplash.com/featured/600x400?fruits",desc:"S√©lection de fruits de saison.",category:"Supermarch√©s",partner:"Carrefour Mayol",createdAt:Date.now()-86400000*1},
          {id:"d2",name:"Baguette tradition x3",price:3.2,img:"https://source.unsplash.com/featured/600x400?baguette",desc:"Farine locale, croustillante.",category:"Boulangeries",partner:"Boulangerie Paul",createdAt:Date.now()-86400000*2},
          {id:"d3",name:"Parac√©tamol 500mg",price:2.99,img:"https://source.unsplash.com/featured/600x400?pharmacy",desc:"Respect de la d√©livrance.",category:"Pharmacies",partner:"Pharmacie Mayol",createdAt:Date.now()-86400000*3},
          {id:"d4",name:"Sushi mix 18 pcs",price:14.9,img:"https://source.unsplash.com/featured/600x400?sushi",desc:"Assortiment du chef.",category:"Restaurants",partner:"Sushi Lab Toulon",createdAt:Date.now()-86400000*0}
        ];
      }
      categories=[...new Set(allProducts.map(p=>p.category||"Autres"))];
      partners=[...new Set(allProducts.map(p=>p.partner||"Partenaire"))];
      renderFilters();
      renderPartners();
      render();
    }

    function renderFilters(){
      filters.innerHTML="";
      const allBtn=document.createElement("button");
      allBtn.className="chip active";allBtn.dataset.cat="all";allBtn.textContent=strings.all;
      filters.appendChild(allBtn);
      categories.forEach(c=>{
        const b=document.createElement("button");
        b.className="chip";b.dataset.cat=c;b.textContent=c;filters.appendChild(b);
      });
    }
    function renderPartners(){
      partnerSelect.innerHTML='<option value="all">Tous les partenaires</option>';
      partners.forEach(p=>{
        const o=document.createElement("option");o.value=p;o.textContent=p;partnerSelect.appendChild(o);
      });
    }

    let activeCat="all";
    function render(){
      grid.innerHTML="";
      const term=q.value.trim().toLowerCase();
      const partner=partnerSelect.value;
      let data=allProducts.slice();
      if(activeCat!=="all") data=data.filter(p=>(p.category||"Autres")===activeCat);
      if(partner!=="all") data=data.filter(p=>(p.partner||"")===partner);
      if(term) data=data.filter(p=>[p.name,p.desc,p.partner,p.category].join(" ").toLowerCase().includes(term));
      if(sort.value==="asc") data.sort((a,b)=>a.price-b.price);
      else if(sort.value==="desc") data.sort((a,b)=>b.price-a.price);
      else if(sort.value==="new") data.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      if(!data.length){grid.innerHTML='<div class="muted" style="text-align:center;width:100%">Aucun produit trouv√©.</div>';return}
      data.forEach(p=>{
        const card=document.createElement("div");card.className="card";
        const img=p.img||"https://source.unsplash.com/featured/600x400?store";
        card.innerHTML=`
          <div class="pic"><img src="${img}" alt="${p.name}" onerror="imgFallback(this)"></div>
          <div class="body">
            <div class="title">${p.name}</div>
            <div class="desc">${p.desc||""}</div>
            <div class="meta">
              <span class="tag">${p.category||"Autres"}</span>
              <span class="tag">üë§ ${p.partner||"Partenaire"}</span>
            </div>
            <div class="row">
              <div class="price">${fmtPrice(p.price)}</div>
              <button class="btn btn-primary" data-id="${p.id}">${strings.orderBtn}</button>
            </div>
          </div>`;
        grid.appendChild(card);
      });
    }

    filters.addEventListener("click",e=>{
      if(e.target.classList.contains("chip")){
        document.querySelectorAll(".chip").forEach(c=>c.classList.remove("active"));
        e.target.classList.add("active");
        activeCat=e.target.dataset.cat||"all";
        render();
      }
    });
    q.oninput=render;
    sort.onchange=render;
    partnerSelect.onchange=render;

    let currentProduct=null;
    grid.addEventListener("click",e=>{
      if(e.target.matches(".btn-primary")){
        const id=e.target.dataset.id;
        currentProduct=allProducts.find(p=>String(p.id)===String(id));
        if(!currentProduct) return;
        document.getElementById("m_title").textContent=strings.modalTitle+" ‚Äî "+currentProduct.name;
        mName.value="";mPhone.value="";mFrom.value="";mTo.value="";mNote.value="";
        orderModal.classList.add("show");
      }
    });
    mCancel.onclick=()=>orderModal.classList.remove("show");

    async function sendOrder(payload){
      loader.style.display="flex";
      try{
        const r=await fetch(API+"/order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
        loader.style.display="none";
        return r.ok;
      }catch(_){
        loader.style.display="none";
        return false;
      }
    }

    mSend.onclick=async()=>{
      if(!currentProduct) return;
      const name=mName.value.trim(), phone=mPhone.value.trim(), from=mFrom.value.trim(), to=mTo.value.trim();
      if(!name||!phone||!from||!to){toastShow(strings.fillAll,"#ef4444");return}
      mSend.disabled=true; setTimeout(()=>{mSend.disabled=false},2000);
      const now=new Date().toLocaleString("fr-FR");
      const ok=await sendOrder({
        type:"product",
        product:currentProduct,
        customer:{name,phone,from,to,note:mNote.value.trim()||"‚Äî"},
        createdAt:Date.now(),
        humanTime:now
      });
      toastShow(ok?strings.sentOk:strings.sentErr, ok?"#22c55e":"#ef4444");
      if(ok){orderModal.classList.remove("show")}
    };

    if("serviceWorker" in navigator){
      window.addEventListener("load",()=>{navigator.serviceWorker.register("/service-worker.js").catch(()=>{})});
    }

    loadProducts();
  </script>
</body>
</html>
