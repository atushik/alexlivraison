<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Espace Partenaire - Boulangeries</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root{--violet:#6b23ff;--violet-dark:#32006b;--green:#4caf50;--red:#ff4d4d;--glass:rgba(255,255,255,0.95)}
  html,body{height:100%;margin:0;padding:0;overflow-x:hidden}
  body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,#32006b 0%,#7a2cf5 50%,#43dfb8 100%);color:#222;min-height:100vh}
  *{box-sizing:border-box}
  .topbar{position:sticky;top:0;z-index:100;background:rgba(20,0,45,0.9);backdrop-filter:blur(10px);padding:10px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 4px 15px rgba(0,0,0,0.3)}
  .logo-img{width:45px;height:45px;object-fit:cover;border-radius:50%;border:2px solid #fff}
  .hamburger{width:40px;height:40px;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:5px;background:rgba(255,255,255,0.1);border-radius:8px;cursor:pointer;border:1px solid rgba(255,255,255,0.2)}
  .hamburger span{width:20px;height:2px;background:#fff;border-radius:2px}
  .menu{position:fixed;top:0;right:-100%;width:280px;height:100vh;background:#1a0033;padding:20px;transition:0.3s;z-index:200;display:flex;flex-direction:column;box-shadow:-5px 0 20px rgba(0,0,0,0.5)}
  .menu.open{right:0}
  .menu-header{display:flex;justify-content:flex-end;margin-bottom:30px}
  .close-btn{color:#fff;font-size:24px;background:none;border:none;cursor:pointer}
  .menu a{display:block;color:#fff;text-decoration:none;padding:15px;border-bottom:1px solid rgba(255,255,255,0.1);font-weight:500;transition:.2s}
  .menu a:hover{background:rgba(255,255,255,0.1);padding-left:20px;color:#b88aff}
  .menu .highlight{color:#43dfb8;font-weight:700}
  .lang-switch{margin-top:auto;display:flex;gap:10px;padding-top:20px}
  .lang-btn{flex:1;padding:10px;background:transparent;border:1px solid rgba(255,255,255,0.3);color:#fff;border-radius:6px;cursor:pointer}
  .lang-btn.active{background:#6b23ff;border-color:#6b23ff}
  .wrap{max-width:800px;margin:0 auto;padding:20px}
  h1{color:#fff;text-align:center;margin:30px 0;font-size:2em;text-shadow:0 2px 10px rgba(0,0,0,0.3)}
  .card{background:var(--glass);border-radius:20px;padding:25px;margin-bottom:25px;box-shadow:0 10px 30px rgba(0,0,0,0.2);animation:fadeIn 0.5s ease-out}
  @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
  h2{color:#32006b;margin-top:0;border-bottom:2px solid #eee;padding-bottom:10px;margin-bottom:20px;font-size:1.4em}
  .input-group{margin-bottom:15px}
  label{display:block;margin-bottom:5px;font-weight:700;color:#444;font-size:0.9em}
  input,textarea,select{width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;font-size:16px;background:#f8f9fa;transition:.3s}
  input:focus,textarea:focus{border-color:#6b23ff;background:#fff;box-shadow:0 0 0 3px rgba(107,35,255,0.1);outline:none}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:15px}
  .btn-primary{width:100%;padding:15px;background:linear-gradient(90deg,#6b23ff,#8e5aff);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:bold;cursor:pointer;transition:.3s;margin-top:10px;box-shadow:0 5px 15px rgba(107,35,255,0.3)}
  .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(107,35,255,0.4)}
  .btn-success{width:100%;display:block;text-align:center;text-decoration:none;padding:15px;background:linear-gradient(90deg,#4caf50,#66bb6a);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:bold;cursor:pointer;transition:.3s;margin-top:15px;box-shadow:0 5px 15px rgba(76,175,80,0.3)}
  .btn-success:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(76,175,80,0.4)}
  .hidden{display:none}
  canvas#signature{width:100%;height:180px;border:2px dashed #ccc;border-radius:10px;background:#fff;cursor:crosshair;touch-action: none;}
  .prod-list{margin-top:20px}
  .prod-item{display:flex;flex-wrap:wrap;align-items:center;gap:15px;background:#fff;padding:15px;border-radius:15px;margin-bottom:15px;box-shadow:0 4px 10px rgba(0,0,0,0.05);transition:.3s;border:1px solid #eee}
  .prod-item:hover{transform:translateY(-2px);box-shadow:0 8px 15px rgba(0,0,0,0.1)}
  .prod-img{width:60px;height:60px;object-fit:cover;border-radius:10px;background:#eee;flex-shrink:0}
  .prod-info{flex:1;min-width:150px}
  .prod-info h4{margin:0 0 5px 0;color:#32006b;font-size:1.1em}
  .prod-info p{margin:0;color:#666;font-size:0.9em}
  .prod-actions{display:flex;gap:10px;width:100%;margin-top:5px}
  .btn-action{flex:1;padding:10px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:0.9em;display:flex;align-items:center;justify-content:center;gap:5px;border:none;transition:.2s}
  .btn-edit{background:#fff3cd;color:#856404;border:1px solid #ffeeba}
  .btn-delete{background:#ffebeb;color:#ff4d4d;border:1px solid #ffcccc}
  .info-box {background: #eef2ff;border-left: 5px solid #6b23ff;padding: 15px;border-radius: 8px;margin-bottom: 25px;font-size: 0.95em;line-height: 1.5;color: #333;}
  .info-box strong { color: #6b23ff; }
  .promo-badge{display:inline-block;background:#ff4d4d;color:#fff;font-size:10px;padding:3px 6px;border-radius:4px;margin-left:5px;vertical-align:middle}
  @media(max-width:600px){.grid2{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="topbar">
  <img src="logo.jpg" class="logo-img" alt="Logo">
  <div class="hamburger" id="menuBtn"><span></span><span></span><span></span></div>
</div>
<div class="menu" id="sideMenu">
  <div class="menu-header"><button class="close-btn" id="closeMenu">‚úï</button></div>
  <nav>
    <a href="index.html" id="link-home">üè† Retour Accueil</a>
    <a href="produits.html" id="link-shop">üõçÔ∏è Vitrine G√©n√©rale</a>
    <a href="boulangeries.html" class="highlight" id="link-cat">ü•ñ Vitrine Boulangerie</a>
    <a href="index.html#contact">üìû Contact Support</a>
  </nav>
  <div class="lang-switch">
    <button class="lang-btn active" id="langFr">FR</button>
    <button class="lang-btn" id="langEn">EN</button>
  </div>
</div>
<main class="wrap">
  <h1 id="page-title">Espace Boulangerie</h1>

  <div class="card">
      <div class="info-box">
          <h3>üì¢ Proc√©dure Partenaire</h3>
          <ol style="margin-left:15px;padding-left:0">
              <li><strong>Cr√©ez votre Code PIN Secret</strong> dans le formulaire ci-dessous.</li>
              <li>Signez le contrat (Votre PIN y sera inscrit pour m√©moire).</li>
              <li>Chargez vos produits. Le syst√®me <strong>utilisera automatiquement</strong> ce PIN pour s√©curiser vos ajouts.</li>
          </ol>
      </div>
  </div>

  <section id="step1" class="card">
    <h2 id="t-step1">1. Inscription & S√©curit√©</h2>
    <div class="grid2">
      <div class="input-group"><label>Nom de l'enseigne</label><input id="f_enseigne" placeholder="Ex: Boulangerie D√©lices"></div>
      <div class="input-group"><label>Cat√©gorie</label><input id="f_cat" value="Boulangerie" readonly style="background:#eee;color:#666"></div>
    </div>
    
    <div class="input-group" style="background:#fff0f0; padding:15px; border-radius:10px; border:1px solid #ffcccc;">
        <label style="color:#d32f2f;">üîê CR√âEZ VOTRE CODE PIN (Obligatoire)</label>
        <input id="f_master_pin" type="text" placeholder="Ex: 1234" maxlength="8" style="font-weight:bold; letter-spacing:1px;">
        <small style="color:#555;display:block;margin-top:5px">Ce code sera sauvegard√© dans votre contrat PDF. Il servira √† supprimer vos produits plus tard.</small>
    </div>

    <div class="input-group"><label>Nom du Responsable</label><input id="f_resp"></div>
    <div class="grid2">
      <div class="input-group"><label>SIREN (9 chiffres)</label><input id="f_siren" type="tel" maxlength="9" placeholder="123456789" oninput="this.value=this.value.replace(/[^0-9]/g,'')"></div>
      <div class="input-group"><label>SIRET (14 chiffres)</label><input id="f_siret" type="tel" maxlength="14" placeholder="12345678900011" oninput="this.value=this.value.replace(/[^0-9]/g,'')"></div>
    </div>
    <div class="input-group"><label>Adresse compl√®te</label><input id="f_addr"></div>
    <div class="grid2">
      <div class="input-group"><label>T√©l√©phone</label><input id="f_tel" type="tel"></div>
      <div class="input-group"><label>E-mail</label><input id="f_mail" type="email"></div>
    </div>
    <button id="btn_step1" class="btn-primary">Suivant</button>
  </section>

  <section id="step2" class="card hidden">
    <h2 id="t-step2">2. Contrat de Collaboration</h2>
    <p style="font-size:14px;color:#666;margin-bottom:15px">Le Code PIN que vous avez d√©fini sera inscrit dans ce document.</p>
    <div class="grid2">
      <div class="input-group"><label>Signataire</label><input id="sign_name"></div>
      <div class="input-group"><label>Date</label><input id="sign_date" type="date"></div>
    </div>
    <label>Votre signature :</label>
    <canvas id="signature"></canvas>
    <button onclick="clearSig()" style="margin-top:5px;padding:5px 10px;background:#eee;border:none;border-radius:4px;cursor:pointer;font-size:12px">Effacer</button>
    <div style="margin-top:20px;display:flex;align-items:center;gap:10px">
      <input type="checkbox" id="agree" style="width:auto">
      <label for="agree" style="margin:0">J'accepte les conditions</label>
    </div>
    <button id="gen_pdf" class="btn-primary">Signer & Valider</button>
  </section>

  <section id="step3" class="card hidden">
    <h2 id="t-step3">3. Gestion de vos produits</h2>
    
    <div class="info-box" style="background:#f0fff4; border-color:#4caf50;">
        <p>‚úÖ <strong>Mode Connect√© :</strong> Votre Code PIN est m√©moris√©. <br>‚ÑπÔ∏è <strong>Commission :</strong> 3% pour les Promos, 5% pour le Standard.</p>
    </div>

    <form id="product-form" style="margin-bottom:30px;padding-bottom:20px;border-bottom:1px dashed #ccc;">
      <div class="input-group"><label>Nom du produit</label><input id="p_name" required placeholder="Ex: Baguette Tradition"></div>
      <div class="input-group"><label>Prix de base Partenaire (‚Ç¨)</label><input id="p_price" type="number" step="0.01" required placeholder="1.00"></div>
      <div class="input-group"><label>Photo du produit</label><input id="p_photo" type="file" accept="image/*" required></div>
      <div class="input-group"><label>Description</label><textarea id="p_desc" rows="2" required placeholder="Ingr√©dients, d√©tails..."></textarea></div>
      
      <div class="input-group" style="display:flex; align-items:center; gap:10px; background:#fff; padding:15px; border-radius:10px; border:1px solid #ffcccc;">
        <input type="checkbox" id="p_promo" style="width:20px; height:20px; accent-color:#ff4d4d;">
        <label for="p_promo" style="margin:0; color:#ff4d4d; font-weight:bold;">üî• Produit en Promotion (Pour la Vitrine G√©n√©rale)</label>
      </div>
      
      <button type="submit" class="btn-primary">üì§ Mettre en ligne</button>
    </form>

    <div id="upload-status" style="text-align:center;margin-bottom:20px;font-weight:bold"></div>

    <div id="success-actions" class="hidden">
        <a href="boulangeries.html" class="btn-success">üëÅÔ∏è Voir le produit charg√© (Aller √† la boutique)</a>
        <br>
    </div>

    <h3 style="color:#32006b;margin-bottom:15px;">Vos produits r√©cents :</h3>
    <div id="my-products-list" class="prod-list">
      <div style="text-align:center;color:#666">Chargement...</div>
    </div>
  </section>
</main>
<img src="logo.jpg" id="img-logo" style="display:none">
<img src="alex444.jpg" id="img-stamp" style="display:none">
<img src="sinature-alex.jpg" id="img-alex-sig" style="display:none">

<script>
const firebaseConfig={apiKey:"AIzaSyAWagPwv5Skh_EHfdcnFTYeG-xltRM7yPc",authDomain:"alex-livraison.firebaseapp.com",projectId:"alex-livraison",storageBucket:"alex-livraison.firebasestorage.app",messagingSenderId:"937475497279",appId:"1:937475497279:web:62dc9eba8e77a5113ec78a"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();const storage=firebase.storage();
const BOT="8003065650:AAGJH_PRNHQ7jVDm9q96G6zlHt-IXkxKHnA",CHAT="7129872491";
const CURRENT_CATEGORY='boulangerie';
const menu=document.getElementById('sideMenu');
document.getElementById('menuBtn').onclick=()=>menu.classList.add('open');
document.getElementById('closeMenu').onclick=()=>menu.classList.remove('open');

window.SESSION_PIN = "";
window.productsMap = {};

const langData={
  fr:{t1:"Espace Boulangerie",btn1:"Suivant",btn2:"Signer & Valider",btn3:"Mettre en ligne",del:"Supprimer",edit:"√âditer",pinPrompt:"Pour SUPPRIMER, entrez le PIN de votre contrat :"},
  en:{t1:"Bakery Area",btn1:"Next",btn2:"Sign & Validate",btn3:"Upload Product",del:"Delete",edit:"Edit",pinPrompt:"To DELETE, enter the PIN from your contract :"}
};
let curLang='fr';
document.getElementById('langFr').onclick=()=>{curLang='fr';updateLang()};
document.getElementById('langEn').onclick=()=>{curLang='en';updateLang()};
function updateLang(){
  const d=langData[curLang];
  document.getElementById('page-title').innerText=d.t1;
  document.getElementById('btn_step1').innerText=d.btn1;
  document.getElementById('gen_pdf').innerText=d.btn2;
  document.querySelector('#step3 button[type="submit"]').innerText=d.btn3;
  document.getElementById('langFr').classList.toggle('active',curLang==='fr');
  document.getElementById('langEn').classList.toggle('active',curLang==='en');
}

const s1=document.getElementById('step1'),s2=document.getElementById('step2'),s3=document.getElementById('step3');
const inp=['f_enseigne','f_resp','f_siren','f_siret','f_addr','f_tel','f_mail', 'f_master_pin'].map(id=>document.getElementById(id));

document.getElementById('btn_step1').onclick=()=>{
    for(let i of inp){if(!i.value.trim()){alert("Veuillez remplir tous les champs et cr√©er le Code PIN.");i.focus();return;}}
    
    const siren = document.getElementById('f_siren').value;
    if(siren.length !== 9) { alert("Le SIREN doit comporter exactement 9 chiffres."); return; }
    
    const siret = document.getElementById('f_siret').value;
    if(siret.length !== 14) { alert("Le SIRET doit comporter exactement 14 chiffres."); return; }

    window.SESSION_PIN = document.getElementById('f_master_pin').value;
    s1.classList.add('hidden');s2.classList.remove('hidden');window.scrollTo(0,0);
};

const cvs=document.getElementById('signature'),ctx=cvs.getContext('2d');
let dr=false;
function rs(){const r=cvs.getBoundingClientRect();cvs.width=r.width;cvs.height=180;ctx.fillStyle='#fff';ctx.fillRect(0,0,cvs.width,cvs.height)}
window.onresize=rs;rs();

function gP(e){
    const r=cvs.getBoundingClientRect();
    let x,y;
    if(e.touches && e.touches.length>0){
        x = e.touches[0].clientX - r.left;
        y = e.touches[0].clientY - r.top;
    } else {
        x = e.clientX - r.left;
        y = e.clientY - r.top;
    }
    return {x,y};
}

cvs.onmousedown=e=>{dr=true;ctx.beginPath();ctx.moveTo(gP(e).x,gP(e).y)};
cvs.onmousemove=e=>{if(dr){ctx.lineTo(gP(e).x,gP(e).y);ctx.stroke()}};
cvs.onmouseup=()=>dr=false;
cvs.onmouseout=()=>dr=false;

cvs.ontouchstart=e=>{e.preventDefault();dr=true;ctx.beginPath();ctx.moveTo(gP(e).x,gP(e).y)};
cvs.ontouchmove=e=>{e.preventDefault();if(dr){ctx.lineTo(gP(e).x,gP(e).y);ctx.stroke()}};
cvs.ontouchend=()=>dr=false;

window.clearSig=()=>{ctx.fillStyle='#fff';ctx.fillRect(0,0,cvs.width,cvs.height);ctx.beginPath()};

const dateInput = document.getElementById('sign_date');
const today = new Date().toISOString().split('T')[0];
dateInput.min = today;
dateInput.value = today;

function makeCircle(imgId){
    const img=document.getElementById(imgId);const c=document.createElement('canvas');
    const s=Math.min(img.width,img.height);c.width=s;c.height=s;const x=c.getContext('2d');
    x.fillStyle='#ffffff';x.fillRect(0,0,s,s);x.beginPath();x.arc(s/2,s/2,s/2,0,Math.PI*2);
    x.closePath();x.save();x.clip();x.drawImage(img,(img.width-s)/2,(img.height-s)/2,s,s,0,0,s,s);x.restore();
    return c.toDataURL('image/jpeg',0.95);
}

document.getElementById('gen_pdf').onclick=async()=>{
    if(!document.getElementById('sign_name').value)return alert("Nom du signataire requis");
    if(!document.getElementById('agree').checked)return alert("Veuillez accepter les conditions");
    
    if(!window.SESSION_PIN) window.SESSION_PIN = document.getElementById('f_master_pin').value;

    const {jsPDF}=window.jspdf,doc=new jsPDF();
    try{doc.addImage(makeCircle('img-logo'),'JPEG',15,10,20,20)}catch(e){}
    doc.setFontSize(18);doc.setFont("helvetica","bold");doc.text("Convention de Collaboration",20,40);
    doc.setLineWidth(0.5);doc.line(20,50,190,50);
    doc.setFontSize(11);doc.setFont("helvetica","normal");
    let y=60;
    const addL=(l,b=false,color=null)=>{doc.setFont("helvetica",b?"bold":"normal");if(color) doc.setTextColor(color); else doc.setTextColor(0,0,0);doc.text(l,20,y);y+=6;};
    addL("Entre AlexLivraison (Atabek Zakirov) et "+document.getElementById('f_enseigne').value+" ("+CURRENT_CATEGORY+").",true);
    y+=5;
    addL("Responsable: "+document.getElementById('f_resp').value);
    addL("SIREN: "+document.getElementById('f_siren').value+" ‚Äî SIRET: "+document.getElementById('f_siret').value);
    addL("Adresse: "+document.getElementById('f_addr').value);
    addL("Contact: "+document.getElementById('f_tel').value+" / "+document.getElementById('f_mail').value);
    y+=5;
    
    doc.setDrawColor(255, 0, 0); doc.setLineWidth(0.5); doc.rect(18, y-5, 100, 10);
    addL("CODE PIN DE S√âCURIT√â (Sauvegard√©) : " + window.SESSION_PIN, true, "red");
    
    doc.setTextColor(0,0,0);y+=8;
    doc.setFontSize(10);
    const legalText = [
        "CONDITIONS DE PARTENARIAT & TARIFICATION :",
        "1. Transparence : Une commission de 3% (Promo) √† 5% (Standard) est ajout√©e",
        "   automatiquement au prix fix√© par le Partenaire.",
        "2. Offre de Bienvenue : Les 5 premi√®res livraisons sont GRATUITES.",
        "3. Responsabilit√© : Le Partenaire est seul responsable de l'exactitude des informations",
        "   produits. AlexLivraison d√©cline toute responsabilit√© en cas d'erreur.",
        "4. L√©gal : Toute fausse d√©claration d'identit√© ou d'entreprise (SIREN/SIRET)",
        "   expose le Partenaire √† des poursuites p√©nales selon la l√©gislation fran√ßaise."
    ];
    legalText.forEach(line => addL(line));

    y+=10;
    doc.setFontSize(11);
    doc.text("Fait le "+document.getElementById('sign_date').value,20,y);y+=15;
    doc.text("Le Partenaire:",20,y);doc.text("AlexLivraison:",120,y);y+=10;
    doc.addImage(cvs.toDataURL('image/jpeg'),'JPEG',20,y,50,30);
    doc.text(document.getElementById('sign_name').value,20,y+35);
    try{doc.addImage(document.getElementById('img-alex-sig'),'JPEG',100,y-5,50,30)}catch(e){}
    try{doc.addImage(makeCircle('img-stamp'),'JPEG',150,y-5,40,40)}catch(e){}
    const blob=doc.output('blob');
    doc.save("Contrat_AlexLivraison_"+CURRENT_CATEGORY+".pdf");
    const fd=new FormData();fd.append('chat_id',CHAT);fd.append('document',new File([blob],'Contrat.pdf',{type:'application/pdf'}));
    fd.append('caption', `Contrat sign√©: ${document.getElementById('f_enseigne').value}. PIN: ${window.SESSION_PIN}`);
    fetch(`https://api.telegram.org/bot${BOT}/sendDocument`,{method:'POST',body:fd});
    s2.classList.add('hidden');s3.classList.remove('hidden');window.scrollTo(0,0);
    loadMyProducts();
};

document.getElementById('product-form').onsubmit=async(e)=>{
    e.preventDefault();
    const st=document.getElementById('upload-status'),bn=e.target.querySelector('button');
    
    if(!window.SESSION_PIN || window.SESSION_PIN === ""){
        alert("Session expir√©e. Veuillez recharger la page et recommencer l'inscription pour d√©finir le PIN.");
        return;
    }

    bn.disabled=true;st.innerText="Calcul et chargement en cours...";st.style.color="blue";
    const name=document.getElementById('p_name').value;
    const rawPrice=parseFloat(document.getElementById('p_price').value);
    const shop=document.getElementById('f_enseigne').value;
    const isPromo = document.getElementById('p_promo').checked;
    
    const multiplier = isPromo ? 1.03 : 1.05;
    const finalPrice = (rawPrice * multiplier).toFixed(2);

    try{
        const f=document.getElementById('p_photo').files[0],ref=storage.ref(`products/${Date.now()}_${f.name}`);
        await ref.put(f);const u=await ref.getDownloadURL();
        
        await db.collection('products').add({name:name,price:parseFloat(finalPrice),desc:document.getElementById('p_desc').value,pin:window.SESSION_PIN,imageUrl:u,category:CURRENT_CATEGORY,isPromo:isPromo,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
        
        const percent = isPromo ? "3%" : "5%";
        const promoText = isPromo ? "üî• OUI (Vitrine G√©n√©rale)" : "Non";
        const msg=`üì¶ <b>Nouveau Produit!</b>\nüè¨ ${shop}\nüçî ${name}\nüí∞ Base: ${rawPrice}‚Ç¨ + ${percent} -> ${finalPrice}‚Ç¨\n‚ú® Promo: ${promoText}\nüîë PIN: ${window.SESSION_PIN}`;
        await fetch(`https://api.telegram.org/bot${BOT}/sendMessage`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id:CHAT,text:msg,parse_mode:'HTML'})});
        st.innerText=`‚úÖ Produit charg√© ! Prix affich√© : ${finalPrice}‚Ç¨`;st.style.color="green";
        document.getElementById('success-actions').classList.remove('hidden');
        document.getElementById('product-form').reset();
        document.getElementById('p_promo').checked = false;
    }catch(err){st.innerText="‚ùå Erreur: "+err.message;st.style.color="red";bn.disabled=false;}
};

function loadMyProducts(){
    db.collection('products').where('category','==',CURRENT_CATEGORY).onSnapshot(snap=>{
        const div=document.getElementById('my-products-list');div.innerHTML='';
        window.productsMap = {};
        if(snap.empty){div.innerHTML='<p style="text-align:center;opacity:0.6">Aucun produit en ligne.</p>';return}
        
        let docs = snap.docs.map(d => ({id: d.id, ...d.data()}));
        docs.sort((a,b) => (b.createdAt && a.createdAt) ? b.createdAt.seconds - a.createdAt.seconds : 0);
        
        docs.forEach(p=>{
            window.productsMap[p.id] = p;
            const safePin = p.pin || 'undefined';
            const promoLabel = p.isPromo ? '<span class="promo-badge">üî• Promo</span>' : '';
            div.innerHTML+=`
            <div class="prod-item">
                <img src="${p.imageUrl}" class="prod-img">
                <div class="prod-info"><h4>${p.name} ${promoLabel}</h4><p>${p.price} ‚Ç¨</p></div>
                <div class="prod-actions">
                    <button class="btn-action btn-edit" type="button" onclick="editProd('${p.id}')">‚úèÔ∏è √âditer</button>
                    <button class="btn-action btn-delete" type="button" onclick="del('${p.id}','${safePin}')">üóëÔ∏è Supprimer</button>
                </div>
            </div>`;
        });
    })
}

window.editProd=async(id)=>{
    const p = window.productsMap[id];
    if(!p) return;
    const currentPin = p.pin || window.SESSION_PIN;
    
    if(currentPin !== window.SESSION_PIN) return alert("Ce produit appartient √† une autre session.");
    if(!confirm("Modifier ce produit ? L'ancienne version sera supprim√©e.")) return;
    
    try{
        await db.collection('products').doc(id).delete();
        const multiplier = p.isPromo ? 1.03 : 1.05;
        const basePrice = (p.price / multiplier).toFixed(2);
        document.getElementById('p_name').value = p.name;
        document.getElementById('p_price').value = basePrice;
        document.getElementById('p_desc').value = p.desc;
        document.getElementById('p_promo').checked = p.isPromo || false;
        document.querySelector('#step3').scrollIntoView({behavior:'smooth'});
        alert(`Donn√©es r√©cup√©r√©es. Prix de base remis √† ${basePrice}‚Ç¨.`);
    } catch(e){ alert("Erreur: " + e.message); }
}

window.del=async(id,prodPin)=>{
    const userPin=prompt(langData[curLang].pinPrompt);if(!userPin)return;
    const validPin = (prodPin === 'undefined') ? window.SESSION_PIN : prodPin;
    
    if(userPin.toString() === validPin.toString()){
        try{await db.collection('products').doc(id).delete();alert("Produit supprim√© ! Pensez √† actualiser la boutique.");}catch(e){alert("Erreur : "+e.message)}
    }else{
        alert("‚ùå Code PIN incorrect !");
    }
}
</script>
</body>
</html> 
