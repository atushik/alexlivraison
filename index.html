<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alex Livraison ‚Äî Calcul & Paiement</title>
<style>
  :root{--violet:#5a2d82;--violet-2:#7c43a8;--bg:#faf7ff}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,#ffffff 0%,#faf7ff 55%,#f2edff 100%);color:#222}
  header{background:var(--violet);color:#fff;text-align:center;padding:16px 12px;font-weight:700}
  .wrap{max-width:1000px;margin:28px auto;padding:0 16px}
  .card{background:#fff;border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.08);padding:22px;margin:auto;max-width:620px}
  label{font-weight:600;margin:10px 0 6px;display:block}
  input,select{width:100%;padding:12px 14px;border:1px solid #ddd;border-radius:10px;font-size:16px;background:#fff}
  .row{display:grid;grid-template-columns:1fr;gap:14px}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  button{background:var(--violet);color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
  button[disabled]{opacity:.6;cursor:not-allowed}
  button:hover{background:var(--violet-2)}
  .muted{color:#666;font-size:14px}
  .pill{display:inline-flex;gap:8px;align-items:center;background:#f5f0ff;border:1px solid #e6dcff;border-radius:999px;padding:8px 12px}
  .stack{display:grid;gap:8px;margin-top:10px}
  .tooltip{position:relative;cursor:help;display:inline-block;margin-left:6px}
  .tooltip .tip{position:absolute;left:0;top:130%;background:#111;color:#fff;border-radius:8px;padding:10px;max-width:320px;font-size:13px;visibility:hidden;opacity:0;transition:.15s;z-index:5}
  .tooltip:hover .tip{visibility:visible;opacity:1}
  footer{margin:36px 0 48px}
  .hero{margin-top:28px;background:linear-gradient(135deg,#5a2d82 0%,#7c43a8 55%,#8d5bd1 100%);color:#fff;border-radius:18px;padding:22px}
  .hero h3{margin:0 0 8px}
  .hero p{margin:0;opacity:.95}
  .icons{font-size:22px;display:flex;gap:14px;margin-top:12px}
  .contactbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  .ghost{background:#fff;color:#5a2d82;border:2px solid #fff}
</style>
</head>
<body>
<header>üö¥‚Äç‚ôÇÔ∏è Alex Livraison ‚Äî Calculateur & Paiement</header>

<div class="wrap">
  <div class="card">
    <div class="row">
      <div>
        <label for="from">Adresse de d√©part</label>
        <input id="from" placeholder="ex: 241 Rue Le Corbusier, La Seyne-sur-Mer" autocomplete="street-address" />
      </div>
      <div>
        <label for="to">Adresse de destination</label>
        <input id="to" placeholder="ex: 1267 Avenue ..., La Seyne" autocomplete="street-address" />
      </div>
      <div>
        <label for="size">
          Taille du colis
          <span class="tooltip">‚ÑπÔ∏è
            <span class="tip">
              <b>S</b> ‚Äî jusqu‚Äô√† 2 kg (documents, m√©dicaments)<br/>
              <b>M</b> ‚Äî jusqu‚Äô√† 10 kg (repas, petites courses)<br/>
              <b>L</b> ‚Äî jusqu‚Äô√† 25 kg (cartons moyens, sacs lourds)<br/>
              <b>XL</b> ‚Äî jusqu‚Äô√† 50 kg (colis volumineux, valises)
            </span>
          </span>
        </label>
        <select id="size">
          <option value="S">Petit (S)</option>
          <option value="M">Moyen (M)</option>
          <option value="L">Grand (L)</option>
          <option value="XL">Tr√®s grand (XL)</option>
        </select>
      </div>

      <div>
        <label for="when">Heure de livraison souhait√©e</label>
        <input type="datetime-local" id="when"/>
        <div class="muted">Intervalle minimal entre commandes : 30 minutes.</div>
      </div>
    </div>

    <div class="stack" id="liveInfo" style="display:none;">
      <div class="pill" id="kmLine">üìè Distance estim√©e : ‚Äî</div>
      <div class="pill" id="priceLine">üí∞ Prix estim√© : ‚Äî</div>
      <div class="pill" id="summaryLine">üßæ R√©sum√© : ‚Äî</div>
    </div>

    <div class="actions">
      <button id="payBtn" disabled>Payer via Revolut üí≥</button>
      <a class="pill muted" id="limitNote" style="display:none;">‚ùå En dehors de la zone (max 22 km).</a>
    </div>

    <div class="muted" style="margin-top:8px;">
      Tarification : 2,50 ‚Ç¨ / km + suppl√©ment selon la taille (S/M/L/XL). Zone jusqu‚Äô√† 22 km.
    </div>
  </div>

  <div class="hero">
    <h3>Pourquoi Alex Livraison ?</h3>
    <p>Nous travaillons <b>24 h/24 et 7 j/7</b> ‚Äî repas, courses, m√©dicaments et colis dans tout le Var (Toulon, La Seyne, Solli√®s, Ollioules, etc.).</p>
    <div class="icons">üö¥‚Äç‚ôÇÔ∏è üöó üì¶ üïì üí≥ üåô üåû</div>
    <div class="contactbar">
      <a href="tel:+33677171188"><button class="ghost">üìû Contacter Alex Livraison</button></a>
      <span class="pill" style="background:#fff1; border-color:#fff2;">üí≥ Paiement s√©curis√© par Revolut</span>
    </div>
  </div>
</div>

<footer class="wrap muted">
  ¬© Alex Livraison ‚Äî Service local. Sans interm√©diaires.
</footer>

<script>
// ========= CONFIG =========
const PRICE_PER_KM = 2.50;                        // ‚Ç¨/km
const SIZE_SURCHARGE = { S:0, M:2, L:4, XL:6 };   // ‚Ç¨
const MAX_KM = 22;
const SLOT_GAP_MIN = 30;                          // —Ä–∞–∑—Ä—ã–≤ –º–µ–∂–¥—É –∑–∞–∫–∞–∑–∞–º–∏ (–º–∏–Ω)
const REVOLUT_LINK = "https://checkout.revolut.com/pay/10d5b369-d7f0-43cb-a810-af4c7afe9d27";

// ========= UTILS =========
const $ = s => document.querySelector(s);
const show = el => el.style.display = 'block';
const hide = el => el.style.display = 'none';
const debounce = (fn,ms=400)=>{let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}

function isoNowPlus(minutes){
  const d = new Date(Date.now()+minutes*60000);
  const pad = n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

// –ø—Ä–æ—Å—Ç–∞—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è ¬´–±–∞–∑–∞¬ª –∑–∞–Ω—è—Ç—ã—Ö —Å–ª–æ—Ç–æ–≤ (–¥–ª—è —Ä–µ–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏–º –≤–µ–±—Ö—É–∫/–ë–î)
const storeKey = 'alex_orders_slots';
const getSlots = () => JSON.parse(localStorage.getItem(storeKey)||'[]');
const addSlot  = (iso) => localStorage.setItem(storeKey, JSON.stringify([...getSlots(), iso]));

// ========= GEO & DISTANCE (OpenStreetMap + OSRM) =========
async function geocode(q){
  const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
  const res = await fetch(url,{headers:{'Accept-Language':'fr'}});
  const data = await res.json();
  if(!data || !data[0]) throw new Error("Adresse introuvable");
  return {lat:+data[0].lat, lon:+data[0].lon, label:data[0].display_name};
}
async function osrmDistanceKm(a,b){
  const url = `https://router.project-osrm.org/route/v1/driving/${a.lon},${a.lat};${b.lon},${b.lat}?overview=false`;
  const res = await fetch(url);
  const data = await res.json();
  if(!data?.routes?.[0]) throw new Error("Route introuvable");
  return data.routes[0].distance/1000;
}

// ========= STATE =========
let state = { from:'', to:'', size:'S', km:0, price:0, when:'' };

function calcPrice(km,size){
  const p = Math.max(km*PRICE_PER_KM + (SIZE_SURCHARGE[size]||0), 1);
  return +p.toFixed(2);
}

async function updateAll(){
  try{
    const from = $('#from').value.trim();
    const to   = $('#to').value.trim();
    const size = $('#size').value;
    const when = $('#when').value;

    state.size = size; state.when = when;

    if(!from || !to){ $('#payBtn').disabled = true; hide($('#liveInfo')); return; }

    const [A,B] = await Promise.all([geocode(from), geocode(to)]);
    const km = await osrmDistanceKm(A,B);
    state.from = from; state.to = to; state.km = km;
    state.price = calcPrice(km,size);

    show($('#liveInfo'));
    $('#kmLine').innerHTML = `üìè Distance estim√©e : <b>${km.toFixed(1)} km</b>`;
    $('#priceLine').innerHTML = `üí∞ Prix estim√© : <b>${state.price.toFixed(2)} ‚Ç¨</b>`;
    $('#summaryLine').innerHTML = `üßæ De: ${from} ‚Üí √Ä: ${to} ¬∑ Taille: ${size}${when?` ¬∑ Heure: ${new Date(when).toLocaleString('fr-FR')}`:''}`;

    if(km > MAX_KM){ $('#payBtn').disabled = true; show($('#limitNote')); return; }
    hide($('#limitNote'));

    // –≤–∞–ª–∏–¥–∏—Ä—É–µ–º —Å–ª–æ—Ç –≤—Ä–µ–º–µ–Ω–∏
    const validTime = validateSlot(when);
    $('#payBtn').disabled = !validTime;

  }catch(e){
    $('#payBtn').disabled = true;
    show($('#liveInfo'));
    $('#kmLine').innerHTML = `‚ùå ${e.message || 'Erreur de calcul'}`;
    $('#priceLine').innerHTML = `‚Äî`;
    $('#summaryLine').innerHTML = `‚Äî`;
  }
}

function validateSlot(iso){
  if(!iso) return false;
  const chosen = new Date(iso).getTime();
  const now    = Date.now();
  // –º–∏–Ω–∏–º—É–º +30 –º–∏–Ω –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
  if(chosen < now + SLOT_GAP_MIN*60000) return false;
  // –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫ —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ —Å–ª–æ—Ç–∞–º–∏
  for(const s of getSlots()){
    const t = new Date(s).getTime();
    if(Math.abs(t - chosen) < SLOT_GAP_MIN*60000) return false;
  }
  return true;
}

// ========= PAY =========
$('#payBtn').addEventListener('click', async ()=>{
  // —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
  if(!state.price || !state.from || !state.to || !state.when){
    await updateAll(); if(!state.price || !state.when) return;
  }
  if(!validateSlot(state.when)){ alert("Cr√©neau non disponible. Choisissez un autre horaire."); return; }

  // –±—Ä–æ–Ω–∏—Ä—É–µ–º —Å–ª–æ—Ç –ª–æ–∫–∞–ª—å–Ω–æ (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ ‚Äî –≤–µ–±—Ö—É–∫/–ë–î)
  addSlot(state.when);

  const url = `${REVOLUT_LINK}?amount=${encodeURIComponent(state.price)}&currency=EUR`;
  window.open(url,'_blank');
});

// ========= INIT =========
$('#size').addEventListener('change', updateAll);
$('#from').addEventListener('input', debounce(updateAll,400));
$('#to').addEventListener('input', debounce(updateAll,400));
$('#when').addEventListener('change', updateAll);

// min –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ ‚Äî —Å–µ–π—á–∞—Å + 30 –º–∏–Ω
$('#when').min = isoNowPlus(SLOT_GAP_MIN);
</script>
</body>
</html>

</html>
