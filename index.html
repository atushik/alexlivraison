<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alex Livraison üööüö¥</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet:#5b15d6; --violet2:#6d2ae8; --bg:#3b0aa3; --card:#fff; --muted:#6b6b6b;
      --success:#0bb07b; --danger:#d64545;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, #6d2ae8 0, #3b0aa3 40%, #2a0b75 100%) fixed;
      color:#fff; min-height:100vh; display:flex; flex-direction:column; align-items:center;
    }
    h1{font-weight:800; letter-spacing:.3px; margin:28px 16px}
    .card{
      width:clamp(320px, 90vw, 720px);
      background:var(--card); color:#111; border-radius:24px; padding:22px 22px 16px;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
    }
    .row{display:flex; flex-direction:column; gap:10px; margin-bottom:16px}
    label{font-size:14px; color:#444; font-weight:600}
    input, select{
      width:100%; border:1px solid #e7e7e7; border-radius:12px; padding:14px 14px;
      font-size:16px; outline:none; transition: .2s border-color; background:#fff;
    }
    input:focus, select:focus{border-color:#b8a2ff}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:14px 18px; border-radius:14px; border:none; cursor:pointer;
      font-size:16px; font-weight:700; width:100%;
      background:linear-gradient(135deg,var(--violet2),var(--violet));
      color:#fff; box-shadow:0 10px 30px rgba(91,21,214,.35);
      transition:transform .05s ease-in-out, filter .2s;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{
      background:#f5f6ff; color:#312e81; box-shadow:none; border:1px solid #e6e6ff;
    }
    .stack{display:grid; gap:10px; grid-template-columns:1fr}
    @media (min-width:640px){ .stack{ grid-template-columns:1fr 1fr } }
    .result{
      margin-top:14px; background:#f7f7ff; color:#1f1648; border:1px dashed #c9b8ff;
      padding:12px 14px; border-radius:12px; font-weight:600; display:none;
    }
    .note{color:#ddd; font-size:14px; margin:18px 16px 8px; text-align:center; max-width:900px}
    footer{color:#eee; font-size:14px; margin:0 16px 30px; text-align:center}
    .ok{color:var(--success); font-weight:700}
    .err{color:var(--danger); font-weight:700}
    .disabled input, .disabled select, .disabled button { opacity:0.6; pointer-events:none; }
  </style>
</head>
<body>
  <h1>Alex Livraison üööüö¥</h1>

  <div class="card" id="order-card">
    <div class="row">
      <label for="from">Adresse de d√©part</label>
      <input id="from" placeholder="Adresse d'enl√®vement" autocomplete="off" />
    </div>

    <div class="row">
      <label for="to">Adresse de destination</label>
      <input id="to" placeholder="Adresse de destination" autocomplete="off" />
    </div>

    <div class="row">
      <label for="size">Taille du colis üì¶</label>
      <select id="size">
        <option value="S">Petit (S)</option>
        <option value="M">Moyen (M)</option>
        <option value="L">Grand (L)</option>
        <option value="XL">Tr√®s grand (XL)</option>
      </select>
    </div>

    <div class="row">
      <label for="time">Heure de livraison souhait√©e</label>
      <input id="time" type="datetime-local"/>
    </div>

    <button id="calc" class="btn">Calculer le prix</button>
    <div id="result" class="result"></div>

    <div class="row" style="margin-top:14px">
      <div class="stack">
        <button id="pay-card" class="btn">üí≥ Paiement par carte (Revolut)</button>
        <button id="pay-cash" class="btn secondary">üíµ Paiement en esp√®ces √† la livraison</button>
      </div>
      <div id="send-status" style="margin-top:8px; font-size:14px;"></div>
    </div>
  </div>

  <p class="note">üö¥ Livraison locale 24h/24 et 7j/7 ‚Äî repas, courses, m√©dicaments et colis dans tout le Var (Toulon, La Seyne, Ollioules, etc.)</p>
  <footer>üíú Nous livrons vos commandes jusqu'√† votre porte üíú<br/>¬© 2025 Alex Livraison</footer>

  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places&language=fr" defer></script>

  <script>
    const API_BASE = 'https://alexlivraison-api.onrender.com';
    const REVOLUT_CHECKOUT_URL = 'https://checkout.revolut.com/pay/10d5b369-d7f0-43cb-a810-af4c7afe9d27';

    const PRICING = { BASE_FEE:3.0, PER_KM:0.8, SIZE_MULT:{S:1,M:1.2,L:1.5,XL:1.8}, MIN_PRICE:5.0 };

    const $from=document.getElementById('from');
    const $to=document.getElementById('to');
    const $size=document.getElementById('size');
    const $time=document.getElementById('time');
    const $calc=document.getElementById('calc');
    const $result=document.getElementById('result');
    const $status=document.getElementById('send-status');
    const $payCard=document.getElementById('pay-card');
    const $payCash=document.getElementById('pay-cash');
    const $card=document.getElementById('order-card');

    (function initTime(){
      const dt=new Date(Date.now()+30*60000);
      const pad=n=>String(n).padStart(2,'0');
      $time.value=`${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}T${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    })();

    window.addEventListener('load',()=>{
      if(window.google && google.maps){
        new google.maps.places.Autocomplete($from,{componentRestrictions:{country:"fr"}});
        new google.maps.places.Autocomplete($to,{componentRestrictions:{country:"fr"}});
      }
    });

    const euros=n=>(Math.round(n*100)/100).toFixed(2);
    const computeDistanceKm=(origin,dest)=>new Promise((res,rej)=>{
      const svc=new google.maps.DistanceMatrixService();
      svc.getDistanceMatrix({
        origins:[origin],destinations:[dest],
        travelMode:google.maps.TravelMode.BICYCLING,
        unitSystem:google.maps.UnitSystem.METRIC
      },(r,s)=>{
        if(s!=="OK"||!r.rows?.[0]?.elements?.[0])return rej("Erreur DistanceMatrix");
        const el=r.rows[0].elements[0];
        if(el.status!=="OK")return rej("√âl√©ment invalide");
        res(el.distance.value/1000.0);
      });
    });

    function calcPrice(km,size){const m=PRICING.SIZE_MULT[size]??1;return Math.max((PRICING.BASE_FEE+km*PRICING.PER_KM)*m,PRICING.MIN_PRICE);}

    async function calculate(){
      const o=$from.value.trim(),d=$to.value.trim();
      if(!o||!d){$result.style.display='block';$result.innerHTML='‚ö†Ô∏è Merci de saisir les deux adresses.';return null;}
      try{
        const km=await computeDistanceKm(o,d),p=calcPrice(km,$size.value);
        $result.style.display='block';$result.innerHTML=`üöö Distance estim√©e : <b>${km.toFixed(2)} km</b> | üí∂ Prix estim√© : <b>${euros(p)} ‚Ç¨</b>`;
        return{km,p};
      }catch(e){$result.style.display='block';$result.innerHTML='‚ùå Erreur Google Maps.';return null;}
    }

    async function sendOrder(payType){
      const calc=await calculate(); if(!calc)return false;
      const payload={to:'+33677171188',de:$from.value,a:$to.value,
        distance_km:Number(calc.km.toFixed(2)),prix_eur:Number(euros(calc.p)),
        heure:new Date($time.value).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}),
        payment_method:payType};
      $status.className='';$status.textContent='Envoi WhatsApp en cours‚Ä¶';
      try{
        const r=await fetch(`${API_BASE}/api/notify-whatsapp`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        if(!r.ok)throw new Error(await r.text());
        $status.className='ok';$status.textContent='‚úÖ Notification WhatsApp envoy√©e.';
        return true;
      }catch(err){console.error(err);$status.className='err';$status.textContent='‚ùå √âchec de l‚Äôenvoi WhatsApp.';return false;}
    }

    function lockForm(){
      $card.classList.add('disabled');
    }
    function showSuccess(msg){
      $status.className='ok';
      $status.innerHTML=`<br><b>${msg}</b>`;
    }
    function openRevolut(){
      const a=document.createElement('a');
      a.href=REVOLUT_CHECKOUT_URL; a.target='_blank'; a.rel='noopener'; document.body.appendChild(a); a.click(); a.remove();
    }

    $calc.addEventListener('click',calculate);
    $payCard.addEventListener('click',async()=>{
      await sendOrder('carte (Revolut)');
      openRevolut();
      lockForm();
      showSuccess('üü¢ Commande pay√©e avec succ√®s. Merci pour votre confiance !');
    });
    $payCash.addEventListener('click',async()=>{
      await sendOrder('esp√®ces √† la livraison');
      lockForm();
      showSuccess('üü¢ Commande confirm√©e. Paiement √† la livraison.');
    });
  </script>
</body>
</html>
