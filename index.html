<script>
  let map;
  let markerA, markerB;
  const mapKey = "AIzaSyC6bP1-fake-key-for-demo"; // Ð·Ð°Ð¼ÐµÐ½Ð¸ Ð½Ð° ÑÐ²Ð¾Ð¹ Google Maps ÐºÐ»ÑŽÑ‡

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 43.118, lng: 5.933 },
      zoom: 11,
    });
  }

  async function calculatePrice() {
    const start = document.getElementById("start").value;
    const end = document.getElementById("end").value;
    if (!start || !end) {
      alert("Veuillez entrer les deux adresses !");
      return;
    }

    const size = document.getElementById("size").value;
    const floor = parseInt(document.getElementById("floor").value);
    const extras = Array.from(document.querySelectorAll(".extra:checked")).map(e => parseFloat(e.value));
    const extraCost = extras.reduce((a, b) => a + b, 0);

    const url = https://maps.googleapis.com/maps/api/distancematrix/json?origins=${encodeURIComponent(start)}&destinations=${encodeURIComponent(end)}&key=${mapKey};
    const response = await fetch(https://api.allorigins.win/get?url=${encodeURIComponent(url)});
    const data = await response.json();
    const result = JSON.parse(data.contents);

    if (!result.rows[0] || !result.rows[0].elements[0].distance) {
      alert("Erreur lors du calcul. VÃ©rifiez les adresses.");
      return;
    }

    const distanceKm = result.rows[0].elements[0].distance.value / 1000;
    let basePrice = 1.5 + distanceKm * 0.8;

    if (size === "M") basePrice += 0.8;
    else if (size === "L") basePrice += 1.5;
    else if (size === "XL") basePrice += 2.5;

    const floorCost = floor === 0 ? 0 : floor <= 4 ? 2 : floor <= 10 ? 3 : 4;
    const total = (basePrice + extraCost + floorCost).toFixed(2);

    document.getElementById("result").innerHTML = ðŸ“ Distance : ${distanceKm.toFixed(2)} km<br>ðŸ’° Prix total : ${total} â‚¬;
    document.getElementById("payCard").style.display = "block";
    document.getElementById("payCash").style.display = "block";

    if (map) {
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ address: start }, (res1) => {
        geocoder.geocode({ address: end }, (res2) => {
          if (res1[0] && res2[0]) {
            const locA = res1[0].geometry.location;
            const locB = res2[0].geometry.location;
            if (markerA) markerA.setMap(null);
            if (markerB) markerB.setMap(null);
            markerA = new google.maps.Marker({ position: locA, map, label: "A" });
            markerB = new google.maps.Marker({ position: locB, map, label: "B" });
            map.setCenter(locA);
          }
        });
      });
    }
  }

  function payByCard() {
    const totalText = document.getElementById("result").innerText.match(/(\d+(\.\d+)?)/);
    const amount = totalText ? totalText[0] : 0;
    window.open(https://checkout.revolut.com/pay/10d5b369-d7f0-43cb-a810-af4c7afe9d27?amount=${amount}&currency=EUR, "_blank");
  }
</script>
