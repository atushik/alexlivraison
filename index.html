<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alex Livraison üöóüö¥‚Äç‚ôÇÔ∏è</title>
  <style>
    :root{
      --violet:#6a0dad; --violet2:#8a2be2; --bg1:#4b0082; --bg2:#7b2cbf;
      --card:#fff; --text:#111; --ok:#0bb07b; --err:#d64545;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      color:#fff; min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:20px;
    }
    h1{margin:10px 0 18px}
    .card{
      width:clamp(320px, 92vw, 480px);
      background:var(--card); color:var(--text); border-radius:22px; padding:18px;
      box-shadow:0 18px 50px rgba(0,0,0,.30);
    }
    label{display:block; font-size:14px; font-weight:700; color:#333; margin:8px 0 6px}
    input, select{
      width:100%; border:1px solid #e7e7e7; border-radius:12px; padding:13px 14px;
      font-size:16px; outline:none; background:#fff;
    }
    input:focus, select:focus{border-color:#c8b3ff}
    .btn{
      width:100%; margin-top:12px; padding:14px 16px; border-radius:14px; border:none; cursor:pointer;
      font-weight:800; font-size:16px; color:#fff;
      background:linear-gradient(135deg,var(--violet2),var(--violet));
      box-shadow:0 12px 30px rgba(138,43,226,.35);
    }
    .btn.secondary{ background:#eef; color:#241a5a; border:1px solid #dfe2ff; box-shadow:none }
    .result{
      display:none; margin-top:12px; background:#f6f5ff; color:#241a5a; border:1px dashed #c9b8ff;
      padding:12px 14px; border-radius:12px; font-weight:700;
    }
    .status{margin-top:10px; font-size:15px; font-weight:800}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .note{color:#eee; font-size:14px; text-align:center; max-width:900px; margin:18px 8px 0}
  </style>

  <!-- Autocomplete init -->
  <script>
    window.initMap = function(){
      try{
        const from = document.getElementById('from');
        const to   = document.getElementById('to');
        if (window.google && google.maps?.places) {
          new google.maps.places.Autocomplete(from, { componentRestrictions:{ country: "fr" } });
          new google.maps.places.Autocomplete(to,   { componentRestrictions:{ country: "fr" } });
        }
      }catch(e){ console.warn('Autocomplete init warning:', e); }
    };
  </script>

  <!-- GOOGLE MAPS: utilise ton vrai cl√© -->
  <script defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDaUyjOAjx9TNonfUF5psKSpxunrgr2h6g&libraries=places&language=fr&callback=initMap">
  </script>
</head>

<body>
  <h1>Alex Livraison üöóüö¥‚Äç‚ôÇÔ∏è</h1>

  <div class="card">
    <label for="from">Adresse de d√©part</label>
    <input id="from" placeholder="241 Rue le Corbusier, La Seyne-sur-Mer"/>

    <label for="to">Adresse de destination</label>
    <input id="to" placeholder="2 Rue Beaussier, Toulon"/>

    <label for="size">Taille du colis üì¶</label>
    <select id="size">
      <option value="S">Petit (S)</option>
      <option value="M">Moyen (M)</option>
      <option value="L">Grand (L)</option>
      <option value="XL">Tr√®s grand (XL)</option>
    </select>

    <label for="time">Heure de livraison souhait√©e</label>
    <input id="time" type="datetime-local"/>

    <button class="btn" id="calc">Calculer le prix</button>
    <div id="result" class="result"></div>

    <button class="btn" id="pay-card">üí≥ Paiement par carte (Revolut)</button>
    <button class="btn secondary" id="pay-cash">üí∂ Paiement en esp√®ces √† la livraison</button>

    <div id="status" class="status"></div>
  </div>

  <p class="note">üö¥ Livraison locale 24h/24 et 7j/7 ‚Äî repas, courses, m√©dicaments et colis dans tout le Var (Toulon, La Seyne, Ollioules, etc.)<br/>üíú ¬© 2025 Alex Livraison</p>

  <script>
    // Pr√©remplir +30 min
    (function(){
      const t = new Date(Date.now()+30*60000);
      const pad = n => String(n).padStart(2,'0');
      document.getElementById('time').value =
        ${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}T${pad(t.getHours())}:${pad(t.getMinutes())};
    })();

    // Tarifs
    const PRICING = { BASE: 3.0, PER_KM: 0.80, MULT:{S:1,M:1.2,L:1.5,XL:1.8}, MIN: 5.0 };
    const API_BASE = 'https://alexlivraison-api.onrender.com';
    const REVOLUT_LINK = 'https://checkout.revolut.com/pay/10d5b369-d7f0-43cb-a810-af4c7afe9d27';

    let lastCalc = null;

    const $from   = document.getElementById('from');
    const $to     = document.getElementById('to');
    const $size   = document.getElementById('size');
    const $time   = document.getElementById('time');
    const $calc   = document.getElementById('calc');
    const $result = document.getElementById('result');
    const $status = document.getElementById('status');
    const $payC   = document.getElementById('pay-card');
    const $payX   = document.getElementById('pay-cash');

    function euros(n){ return (Math.round(n*100)/100).toFixed(2); }
    function calcPrice(km, size){
      const mult = PRICING.MULT[size] ?? 1;
      const raw = (PRICING.BASE + km*PRICING.PER_KM) * mult;
      return Math.max(raw, PRICING.MIN);
    }

    async function computeDistanceKm(origin, destination){
      return new Promise((resolve, reject)=>{
        try{
          const svc = new google.maps.DistanceMatrixService();
          svc.getDistanceMatrix({
            origins:[origin], destinations:[destination],
            travelMode: google.maps.TravelMode.DRIVING,
            unitSystem: google.maps.UnitSystem.METRIC
          }, (res, s)=>{
            if (s!=='OK' || !res?.rows?.[0]?.elements?.[0]) {
              reject(new Error('DistanceMatrix error')); return;
            }
            const el = res.rows[0].elements[0];
            if (el.status!=='OK'){ reject(new Error('Element status '+el.status)); return; }
            resolve(el.distance.value/1000);
          });
        }catch(e){ reject(e); }
      });
    }

    async function calculate(){
      $status.textContent = '';
      const origin = $from.value.trim();
      const dest   = $to.value.trim();
      if(!origin || !dest){
        $result.style.display='block';
        $result.innerHTML='‚ö†Ô∏è Merci de saisir les deux adresses.';
        lastCalc=null; return;
      }
      try{
        const km = await computeDistanceKm(origin, dest);
        const price = calcPrice(km, $size.value);
        lastCalc = { km, price };
        $result.style.display='block';
        $result.innerHTML = üìè Distance estim√©e : <b>${km.toFixed(2)} km</b> &nbsp; | &nbsp; üí∂ Prix estim√© : <b>${euros(price)} ‚Ç¨</b>;
      }catch(e){
        $result.style.display='block';
        $result.innerHTML='‚ùå Erreur Google Distance Matrix.';
        lastCalc=null;
      }
    }

    async function sendWhatsApp(paymentMethod){
      // –ë–µ–∑–æ–ø–∞—Å–Ω–æ: –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, UI –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º
      try{
        const payload = {
          to: '+33677171188',
          de: $from.value.trim(),
          a:  $to.value.trim(),
          distance_km: lastCalc ? Number(lastCalc.km.toFixed(2)) : null,
          prix_eur:    lastCalc ? Number(euros(lastCalc.price)) : null,
          heure: new Date($time.value).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}),
          payment_method: paymentMethod
        };
        await fetch(${API_BASE}/api/notify-whatsapp,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
      }catch(e){
        console.warn('WhatsApp notify failed:', e);
      }
    }

    function activateOrderOk(msg){
      $status.className='status ok';
      $status.textContent=msg;
    }
    function showError(msg){
      $status.className='status err';
      $status.textContent=msg;
    }

    $calc.addEventListener('click', calculate);

    $payC.addEventListener('click', async ()=>{
      if(!lastCalc){ showError('‚ö†Ô∏è Calculez d‚Äôabord le prix.'); return; }
      // 1) –û—Ç–∫—Ä—ã–≤–∞–µ–º Revolut (—Å—É–º–º–∞ –≤ note ‚Äî —É Revolut Business –Ω–µ–ª—å–∑—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å amount –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –≤ —Å—Å—ã–ª–∫–µ)
      const amount = euros(lastCalc.price);
      const note = encodeURIComponent(AlexLivraison: ${$from.value} ‚Üí ${$to.value} (${amount}‚Ç¨));
      window.open(${REVOLUT_LINK}?note=${note},'_blank');

      // 2) –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∑–∞–∫–∞–∑ –∏ —à–ª—ë–º WhatsApp
      activateOrderOk('‚úÖ Paiement confirm√© ! Votre commande est activ√©e.');
      await sendWhatsApp('carte (Revolut)');
    });

    $payX.addEventListener('click', async ()=>{
      activateOrderOk('üíµ Commande confirm√©e ! Merci de payer en esp√®ces √† la livraison.');
      await sendWhatsApp('esp√®ces √† la livraison');
    });
  </script>
</body>
</html>
