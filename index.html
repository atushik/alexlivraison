<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🚗 AlexLivraison 🚴🏻‍♂️</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: linear-gradient(135deg, #4e00b8, #2a006f);
      background-attachment: fixed;
      color: #222;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 25px;
    }
    .title {
      color: #fff;
      font-size: 36px;
      text-align: center;
      font-weight: 800;
      margin-bottom: 20px;
    }
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }
    .label { font-weight: bold; margin-top: 12px; }
    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      margin-top: 5px;
    }
    .services {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .services label {
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 6px;
      background: #f9f9f9;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .btn {
      width: 100%;
      padding: 14px;
      font-size: 17px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      margin-top: 12px;
      font-weight: bold;
      color: #fff;
    }
    .btn-main { background: #5f0fb6; }
    .btn-main:hover { background: #4a0a8f; }
    .btn-alt { background: #eee; color: #000; }
    #result {
      margin-top: 15px;
      background: #fff;
      padding: 12px;
      border-radius: 10px;
      border: 1px dashed #bbb;
      font-weight: 600;
    }
    #map {
      height: 300px;
      margin-top: 10px;
      border-radius: 10px;
    }
    .hidden { display: none; }
    .footer {
      text-align: center;
      color: #fff;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title">🚗 AlexLivraison 🚴🏻‍♂️</div>
    <div class="card">
      <div class="label">Adresse de départ</div>
      <input id="from" placeholder="Ex : 2 Rue Beaussier, Toulon">

      <div class="label">Adresse de destination</div>
      <input id="to" placeholder="Ex : 241 Rue Le Corbusier, La Seyne-sur-Mer">

      <div class="label">Taille du colis 📦</div>
      <select id="size">
        <option value="S">Petit (S)</option>
        <option value="M">Moyen (M)</option>
        <option value="L">Grand (L)</option>
        <option value="XL">Très grand (XL)</option>
      </select>

      <div class="label">Étage</div>
      <select id="floor">
        <option value="0">RDC / 1er (0 €)</option>
        <option value="1">2e — 4e (+2 €)</option>
        <option value="2">5e — 10e (+3 €)</option>
        <option value="3">11e — 15e (+4 €)</option>
      </select>

      <div class="label">Services additionnels</div>
      <div class="services">
        <label><input type="checkbox" value="2" class="extra">Colis fragile (+2 €)</label>
        <label><input type="checkbox" value="3" class="extra">Livraison urgente (+3 €)</label>
        <label><input type="checkbox" value="1" class="extra">Attente 5 min (+1 €)</label>
        <label><input type="checkbox" value="2" class="extra">Attente 10 min (+2 €)</label>
      </div>

      <div class="label">Heure de livraison</div>
      <select id="time"></select>

      <button id="calc" class="btn btn-main">🧮 Calculer le prix</button>
      <button id="payCard" class="btn btn-main">💳 Paiement par carte</button>
      <button id="payCash" class="btn btn-alt">💶 Paiement en espèces</button>

      <div id="result" class="hidden"></div>
      <div id="map" class="hidden"></div>
    </div>
    <div class="footer">💜 Nous livrons vos commandes jusqu’à votre porte 💜<br>© 2025 Alex Livraison</div>
  </div>

  <script>
    const PRICE_KM = 0.9;
    const REVOLUT_LINK = "https://checkout.revolut.com/pay/10d5b369-d7f0-43cb-a810-af4c7afe9d27";
    const TG_TOKEN = "8003065650:AAGJH_PRNHQ7jVDm9q96G6zlHt-IXkxKHnA";
    const TG_CHAT_ID = "7129872491";
    let lastCalc = null, map, routeLayer;

    const $ = s => document.querySelector(s);
    const euro = n => n.toFixed(2).replace('.', ',') + " €";

    (function(){
      const sel = $("#time");
      const now = new Date();
      for(let i=0;i<36;i++){
        const t = new Date(now.getTime() + i*30*60000);
        const label = t.toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"});
        const opt = document.createElement("option");
        opt.value = label; opt.textContent = label;
        sel.appendChild(opt);
      }
    })();

    async function geocode(q){
      const url = https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)};
      const res = await fetch(url);
      const js = await res.json();
      if(!js.length) throw new Error("Adresse introuvable");
      return {lat:+js[0].lat, lon:+js[0].lon};
    }

    async function route(lat1,lon1,lat2,lon2){
      const url = https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson;
      const res = await fetch(url);
      const js = await res.json();
      if(!js.routes || !js.routes.length) throw new Error("Itinéraire introuvable");
      return {km: js.routes[0].distance/1000, geojson: js.routes[0].geometry};
    }

    async function telegram(msg){
      const url = https://api.telegram.org/bot${TG_TOKEN}/sendMessage;
      const body = new URLSearchParams({chat_id: TG_CHAT_ID, text: msg});
      await fetch(url,{method:"POST",body});
    }

    $("#calc").addEventListener("click", async ()=>{
      const from = $("#from").value.trim(), to = $("#to").value.trim();
      if(!from || !to){ alert("Veuillez saisir les deux adresses."); return; }
      const size = $("#size").value, floor = +$("#floor").value, extras = document.querySelectorAll(".extra:checked");
      const when = $("#time").value;
      const result = $("#result"), mapBox = $("#map");
      result.classList.remove("hidden");
      result.textContent = "Calcul en cours...";

      try{
        const [A,B] = await Promise.all([geocode(from), geocode(to)]);
        const r = await route(A.lat,A.lon,B.lat,B.lon);
        if(!map){ map = L.map("map"); L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map); }
        if(routeLayer) routeLayer.remove();
        routeLayer = L.geoJSON(r.geojson,{style:{color:"#5f0fb6",weight:6}}).addTo(map);
        map.fitBounds([[A.lat,A.lon],[B.lat,B.lon]]);
        mapBox.classList.remove("hidden");

        let price = r.km * PRICE_KM;
        if(size==="M") price += 1;
        if(size==="L") price += 2;
        if(size==="XL") price += 3;
        if(floor===1) price += 2;
        if(floor===2) price += 3;
        if(floor===3) price += 4;
        extras.forEach(x=> price += +x.value);

        lastCalc = {from,to,km:r.km,price,size,floor,when};
        result.innerHTML = 🚚 Distance : ${r.km.toFixed(2)} km<br>💶 Prix total : ${euro(price)}<br>📦 Taille : ${size} — Étage : ${floor} — 🕒 ${when};
      }catch(e){ result.textContent = "Erreur lors du calcul. Vérifiez les adresses."; }
    });

    $("#payCash").addEventListener("click", async ()=>{
      if(!lastCalc) return alert("Calculez d’abord le prix.");
      await telegram(🧾 Commande (espèces)\nDe: ${lastCalc.from}\nÀ: ${lastCalc.to}\n${lastCalc.km.toFixed(2)} km, ${lastCalc.price.toFixed(2)} €);
      alert("Commande confirmée (paiement en espèces).");
    });

    $("#payCard").addEventListener("click", async ()=>{
      if(!lastCalc) return alert("Calculez d’abord le prix.");
      await telegram(🧾 Commande (carte)\nDe: ${lastCalc.from}\nÀ: ${lastCalc.to}\n${lastCalc.km.toFixed(2)} km, ${lastCalc.price.toFixed(2)} €);
      window.open(REVOLUT_LINK, "_blank");
    });

    $("#from").value = "2 Rue Beaussier, Toulon";
    $("#to").value = "241 Rue Le Corbusier, La Seyne-sur-Mer";
  </script>
</body>
</html>
