<script>
  const PRICE_PER_KM = 0.9;
  const PRICE_FLOOR = 0.3;
  const PRICE_URGENT = 3.0;
  const REVOLUT_LINK = "https://checkout.revolut.com/pay/10d5b369-d7f0-43cb-a810-af4c7afe9d27";

  const euro = n => (Math.round(n * 100) / 100).toFixed(2).replace('.', ',') + " €";
  const $ = s => document.querySelector(s);

  // === Remplir la liste d’heures ===
  (function fillTimes() {
    const sel = $("#time");
    const now = new Date();
    for (let i = 0; i < 36; i++) {
      const t = new Date(now.getTime() + i * 30 * 60000);
      const hh = String(t.getHours()).padStart(2, "0");
      const mm = String(t.getMinutes()).padStart(2, "0");
      const dd = String(t.getDate()).padStart(2, "0");
      const mo = String(t.getMonth() + 1).padStart(2, "0");
      const yyyy = t.getFullYear();
      const label = ${dd}.${mo}.${yyyy}, ${hh}:${mm};
      const opt = document.createElement("option");
      opt.textContent = label;
      sel.appendChild(opt);
    }
  })();

  async function geocode(q) {
    const url = https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}&accept-language=fr;
    const res = await fetch(url);
    const js = await res.json();
    if (!js.length) throw new Error("Adresse introuvable");
    return { lat: +js[0].lat, lon: +js[0].lon };
  }

  async function route(lat1, lon1, lat2, lon2) {
    const url = https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson;
    const res = await fetch(url);
    const js = await res.json();
    if (!js.routes.length) throw new Error("Itinéraire introuvable");
    return { km: js.routes[0].distance / 1000, geojson: js.routes[0].geometry };
  }

  let map;
  function showMap(lat1, lon1, lat2, lon2, geojson) {
    if (!map) {
      map = L.map("map");
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    }
    L.geoJSON(geojson, { style: { color: "#6c4cff", weight: 5 } }).addTo(map);
    map.fitBounds([[lat1, lon1], [lat2, lon2]]);
    $("#map").style.display = "block";
  }

  let lastCalc = null;

  $("#calc").onclick = async () => {
    const from = $("#from").value.trim();
    const to = $("#to").value.trim();
    const size = $("#size").value;
    const floor = +$("#floor").value;
    const urgent = $("#urgent").checked;
    const when = $("#time").value;

    if (!from || !to) return alert("Veuillez saisir les deux adresses.");

    $("#result").style.display = "block";
    $("#result").innerHTML = "Calcul en cours...";

    try {
      const [A, B] = await Promise.all([geocode(from), geocode(to)]);
      const { km, geojson } = await route(A.lat, A.lon, B.lat, B.lon);
      const kmRound = Math.max(1, Math.round(km * 100) / 100);

      let price = kmRound * PRICE_PER_KM;
      price += floor * PRICE_FLOOR;
      if (urgent) price += PRICE_URGENT;

      lastCalc = { from, to, km: kmRound, price, size, floor, urgent, when };

      $("#result").innerHTML = 
        🚚 <b>Distance :</b> ${kmRound.toFixed(2)} km<br>
        💶 <b>Prix total :</b> ${euro(price)}<br>
        📦 <b>Taille :</b> ${size}<br>
        🏢 <b>Étage :</b> ${floor === 0 ? "RDC" : floor + "ᵉ"}<br>
        ${urgent ? "🚨 <b>Urgent :</b> Oui<br>" : ""}
        🕒 <b>Heure :</b> ${when}
      ;

      showMap(A.lat, A.lon, B.lat, B.lon, geojson);
    } catch (err) {
      $("#result").innerHTML = "Erreur : " + err.message;
    }
  };

  $("#payCard").onclick = () => {
    if (!lastCalc) return alert("Calculez d'abord le prix.");
    window.open(REVOLUT_LINK, "_blank");
  };

  $("#payCash").onclick = () => {
    if (!lastCalc) return alert("Calculez d'abord le prix.");
    alert("Commande enregistrée pour paiement en espèces ✅");
  };

  $("#from").value = "2 Rue Beaussier, Toulon";
  $("#to").value = "241 Rue Le Corbusier, La Seyne-sur-Mer";
</script>
