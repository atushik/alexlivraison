<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alex Livraison üöóüö¥‚Äç‚ôÇÔ∏è</title>

  <!-- Leaflet pour la carte (aucune cl√© n√©cessaire) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg:#33006f;
      --bg2:#5f0fb6;
      --card:#ffffff;
      --primary:#5f0fb6;
      --primary-pressed:#4e0c95;
      --text:#1f1f1f;
      --muted:#6b6b6b;
      --ok:#0ea35a;
      --warn:#eab308;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      color:var(--text);
      background: radial-gradient(1000px 600px at 50% -100px, var(--bg2), var(--bg));
      min-height:100vh;
    }
    .container{max-width:680px;margin:0 auto;padding:28px 16px 80px}
    .title{color:#fff;font-weight:800;font-size:42px;letter-spacing:.3px;display:flex;gap:10px;align-items:center}
    .card{
      background:var(--card);
      border-radius:20px;
      padding:22px;
      box-shadow: 0 12px 40px rgba(0,0,0,.18);
      margin-top:18px;
    }
    .label{
      text-align:center;
      color:#5b5b5b;
      font-weight:700;
      font-size:20px;
      margin:6px 0 10px;
    }
    input, select{
      width:100%;
      height:54px;
      font-size:18px;
      padding:0 16px;
      border:1px solid #e6e6e6;
      border-radius:14px;
      background:#fff;
      color:var(--text);
      outline:none;
    }
    input:focus, select:focus{border-color:#c8a8ff; box-shadow:0 0 0 3px rgba(95,15,182,.12)}
    .row{margin:10px 0 16px}
    .btn{
      width:100%;
      height:58px;
      border-radius:16px;
      font-size:20px;
      font-weight:800;
      color:#fff;
      background:var(--primary);
      border:none;
      display:flex;align-items:center;justify-content:center;gap:10px;
      box-shadow: 0 14px 30px rgba(95,15,182,.35);
      cursor:pointer;
      transition:.15s transform ease,.15s background ease;
    }
    .btn:active{transform:translateY(1px); background:var(--primary-pressed)}
    .btn-outline{
      background:#ddd; color:#222; box-shadow:none; font-weight:700;
    }
    .note{color:#e9d8ff;text-align:center;margin-top:18px;line-height:1.45}
    .footer{color:#f0e7ff;text-align:center;margin-top:16px}
    .badge{
      margin-top:14px;
      padding:12px 14px;
      border-radius:14px;
      font-weight:700;
      text-align:center;
    }
    .badge.ok{background:#e7f8f0;color:#056a3a;border:1px solid #b6efd6}
    .badge.warn{background:#fff7e6;color:#8a6200;border:1px solid #ffe4a3}
    .result{
      background:#fff; border-radius:16px; padding:14px; margin-top:14px;
      border:1px dashed #d9c7ff; color:#2b2b2b; line-height:1.45; font-weight:600
    }
    #map{height:320px;margin-top:18px;border-radius:16px;overflow:hidden;border:1px solid #eee}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="container">
    <div class="title">Alex Livraison <span>üöóüö¥‚Äç‚ôÇÔ∏è</span></div>

    <div class="card">
      <div class="label">Adresse de d√©part</div>
      <div class="row">
        <input id="from" placeholder="Ex : 2 Rue Beaussier, Toulon" />
      </div>

      <div class="label">Adresse de destination</div>
      <div class="row">
        <input id="to" placeholder="Ex : 241 Rue Le Corbusier, La Seyne" />
      </div>

      <div class="label">Taille du colis üì¶</div>
      <div class="row">
        <select id="size">
          <option value="S">Petit (S)</option>
          <option value="M">Moyen (M)</option>
          <option value="L">Grand (L)</option>
          <option value="XL">Tr√®s grand (XL)</option>
        </select>
      </div>

      <div class="label">Heure de livraison souhait√©e</div>
      <div class="row">
        <select id="time"></select>
      </div>

      <div id="banner" class="badge hidden"></div>

      <div class="row">
        <button id="calc" class="btn">üßÆ Calculer le prix</button>
      </div>
      <div class="row">
        <button id="payCard" class="btn">üí≥ Paiement par carte</button>
      </div>
      <div class="row">
        <button id="payCash" class="btn btn-outline">üí∑ Paiement en esp√®ces</button>
      </div>

      <div id="result" class="result hidden"></div>
      <div id="map" class="hidden"></div>
    </div>

    <p class="note">
      üö≤ Livraison locale 24h/24 et 7j/7 ‚Äî Var (Toulon, La Seyne, Ollioules, etc.)
    </p>
    <p class="footer">üíú ¬© 2025 Alex Livraison</p>
  </div>

  <script>
    // === CONFIGURATION ===
    const PRICE_PER_KM = 0.9;
    const REVOLUT_LINK = "https://checkout.revolut.com/pay/10d5b369-d7f0-43cb-a810-af4c7afe9d27";
    const TG_TOKEN = "8003065650:AAGJH_PRNHQ7jVDm9q96G6zlHt-IXkxKHnA";
    const TG_CHAT_ID = "7129872491";

    // === OUTILS ===
    const $ = sel => document.querySelector(sel);
    const banner = $("#banner");
    const resultBox = $("#result");
    const mapBox = $("#map");
    function showBanner(type, text){
      banner.className = "badge " + (type === "ok" ? "ok" : "warn");
      banner.textContent = text;
      banner.classList.remove("hidden");
      setTimeout(()=>banner.classList.add("hidden"), 5000);
    }
    function euro(n){ return (Math.round(n*100)/100).toFixed(2).replace(".", ",") + " ‚Ç¨"; }

    // === HEURES ===
    (function fillTimes(){
      const sel = $("#time");
      sel.innerHTML = "";
      const now = new Date();
      for(let i=0;i<36;i++){
        const t = new Date(now.getTime()+i*30*60000);
        const hh = String(t.getHours()).padStart(2,"0");
        const mm = String(t.getMinutes()).padStart(2,"0");
        const dd = String(t.getDate()).padStart(2,"0");
        const mo = String(t.getMonth()+1).padStart(2,"0");
        const yyyy = t.getFullYear();
        const label = ${dd}.${mo}.${yyyy}, ${hh}:${mm};
        const opt = document.createElement("option");
        opt.value = label; opt.textContent = label;
        sel.appendChild(opt);
      }
    })();

    // === CARTE ===
    let map, routeLayer, markerA, markerB;
    function ensureMap(lat1, lon1, lat2, lon2, geojson){
      if(!map){
        map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution:'¬© OpenStreetMap'
        }).addTo(map);
      }
      if(routeLayer){ routeLayer.remove(); }
      if(markerA){ markerA.remove(); }
      if(markerB){ markerB.remove(); }

      const line = L.geoJSON(geojson, {style:{color:'#6c4cff', weight:6, opacity:.7}});
      line.addTo(map);
      routeLayer = line;

      markerA = L.marker([lat1, lon1]).addTo(map);
      markerB = L.marker([lat2, lon2]).addTo(map);

      const b = L.latLngBounds([[lat1,lon1],[lat2,lon2]]);
      map.fitBounds(b.pad(0.25));
      mapBox.classList.remove("hidden");
    }

    // === OSM : g√©ocodage + itin√©raire ===
    async function geocode(query){
      const url = https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(query)}&accept-language=fr;
      const res = await fetch(url, {headers:{'User-Agent':'alexlivraison-demo'}});
      if(!res.ok) throw new Error("Erreur Nominatim");
      const json = await res.json();
      if(!json.length) throw new Error("Adresse introuvable");
      return { lat: +json[0].lat, lon: +json[0].lon, disp: json[0].display_name };
    }

    async function route(lat1, lon1, lat2, lon2){
      const url = https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson;
      const res = await fetch(url);
      if(!res.ok) throw new Error("Erreur OSRM");
      const json = await res.json();
      if(!json.routes || !json.routes.length) throw new Error("Itin√©raire introuvable");
      const r = json.routes[0];
      return { km: r.distance/1000, geojson: r.geometry };
    }

    // === TELEGRAM ===
    async function notifyTelegram(text){
      try{
        const url = https://api.telegram.org/bot${TG_TOKEN}/sendMessage;
        const body = new URLSearchParams({ chat_id: TG_CHAT_ID, text });
        await fetch(url, { method:'POST', body });
      }catch(e){}
    }

    // === LOGIQUE ===
    let lastCalc = null;

    $("#calc").addEventListener("click", async ()=>{
      const from = $("#from").value.trim();
      const to   = $("#to").value.trim();
      const size = $("#size").value;
      const when = $("#time").value;

      if(!from || !to){
        showBanner("warn","Merci de saisir les deux adresses.");
        return;
      }
      resultBox.classList.remove("hidden");
      resultBox.textContent = "Calcul en cours‚Ä¶";

      try{
        const [A,B] = await Promise.all([geocode(from), geocode(to)]);
        const {km, geojson} = await route(A.lat, A.lon, B.lat, B.lon);
        const kmRound = Math.max(1, Math.round(km*100)/100);
        const price = Math.round(kmRound * PRICE_PER_KM * 100)/100;

        lastCalc = {from, to, km: kmRound, price, size, when};

        ensureMap(A.lat, A.lon, B.lat, B.lon, geojson);
        resultBox.innerHTML =
          üöö <b>Distance estim√©e :</b> ${kmRound.toFixed(2)} km<br>+
          üí∂ <b>Prix estim√© :</b> ${euro(price)}<br>+
          üì¶ <b>Taille :</b> ${size} ‚Äî üïí <b>${when}</b>;
        showBanner("ok","Tarif calcul√© ‚úîÔ∏è");

      }catch(err){
        resultBox.classList.remove("hidden");
        resultBox.textContent = "Probl√®me‚Ä¶ V√©rifiez les adresses.";
        showBanner("warn","Erreur de calcul. R√©essayez.");
      }
    });

    $("#payCash").addEventListener("click", async ()=>{
      if(!lastCalc){ showBanner("warn","Veuillez d‚Äôabord calculer le prix."); return; }
      showBanner("ok","Commande activ√©e ‚úÖ Paiement en esp√®ces.");
      await notifyTelegram(
        üßæ Nouvelle commande (Esp√®ces)\nDe: ${lastCalc.from}\n√Ä: ${lastCalc.to}\nDistance: ${lastCalc.km.toFixed(2)} km\nPrix: ${lastCalc.price.toFixed(2)} ‚Ç¨\nTaille: ${lastCalc.size}\nHeure: ${lastCalc.when}
      );
    });

    $("#payCard").addEventListener("click", async ()=>{
      if(!lastCalc){ showBanner("warn","Veuillez d‚Äôabord calculer le prix."); return; }
      showBanner("ok","Commande activ√©e ‚úÖ Continuez vers le paiement.");
      await notifyTelegram(
        üßæ Nouvelle commande (Carte)\nDe: ${lastCalc.from}\n√Ä: ${lastCalc.to}\nDistance: ${lastCalc.km.toFixed(2)} km\nPrix: ${lastCalc.price.toFixed(2)} ‚Ç¨\nTaille: ${lastCalc.size}\nHeure: ${lastCalc.when}
      );

      try{
        await navigator.clipboard.writeText(lastCalc.price.toFixed(2));
        alert(Montant copi√©: ${lastCalc.price.toFixed(2)} ‚Ç¨\nCollez-le sur la page de paiement si n√©cessaire.);
      }catch(e){}
      window.open(REVOLUT_LINK, "_blank", "noopener");
    });

    $("#from").value = "2 Rue Beaussier, Toulon";
    $("#to").value   = "241 Rue Le Corbusier, La Seyne-sur-Mer";
  </script>
</body>
</html>
