<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AlexLivraison</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    :root{--bg1:#32006b;--bg2:#7a2cf5;--violet:#6b23ff;--ok:#4caf50}
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;color:#222;background:linear-gradient(180deg,var(--bg1),var(--bg2));background-attachment:fixed}
    .container{max-width:720px;margin:0 auto;padding:20px}
    h1{color:#fff;text-align:center;margin:12px 0 18px}
    .card{background:#fff;border-radius:14px;padding:20px;box-shadow:0 8px 28px rgba(0,0,0,.25)}
    label{display:block;margin-top:12px;font-weight:700}
    input,select,button{width:100%;padding:12px;border-radius:10px;border:1px solid #d6d6d6;font-size:16px;margin-top:6px}
    input:focus,select:focus{outline:2px solid #dcd2ff;border-color:#c7bbff}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    .service{border:1px solid #d6d6d6;border-radius:10px;padding:10px;display:flex;gap:8px;align-items:center}
    .service input{width:auto;margin:0}
    button{border:none;cursor:pointer}
    #calc{background:var(--violet);color:#fff}
    #payCard{background:var(--ok);color:#fff}
    #payCash{background:#efefef}
    #result{display:none;background:#f6f4ff;border:1px dashed #bcb3ff;border-radius:10px;margin-top:12px;padding:12px}
    #map{display:none;height:320px;border-radius:12px;margin-top:12px}
    .footer{color:#e9dcff;text-align:center;margin-top:18px;font-size:14px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hint{font-size:12px;color:#666;margin-top:4px}
  </style>
</head>
<body>
  <div class="container">
    <h1>üöó AlexLivraison üö¥üèª‚Äç‚ôÇÔ∏è</h1>
    <div class="card">
      <label>Adresse de d√©part</label>
      <input id="from" placeholder="2 Rue Beaussier, Toulon"/>
      <label>Adresse de destination</label>
      <input id="to" placeholder="241 Rue Le Corbusier, La Seyne-sur-Mer"/>
      <div class="row2">
        <div>
          <label>Taille du colis</label>
          <select id="size">
            <option value="S">Petit (S)</option>
            <option value="M" selected>Moyen (M)</option>
            <option value="L">Grand (L)</option>
            <option value="XL">Tr√®s grand (XL)</option>
          </select>
        </div>
        <div>
          <label>√âtage (optionnel)</label>
          <select id="floor">
            <option value="0">RDC / 1er (0 ‚Ç¨)</option>
            <option value="2">2e‚Äì5e (+2 ‚Ç¨)</option>
            <option value="2.5">6e‚Äì10e (+2,5 ‚Ç¨)</option>
            <option value="3">11e‚Äì15e (+3 ‚Ç¨)</option>
          </select>
        </div>
      </div>
      <label>Services additionnels</label>
      <div class="grid">
        <label class="service"><input type="checkbox" class="srv" data-fee="2"> Colis fragile (+2 ‚Ç¨)</label>
        <label class="service"><input type="checkbox" class="srv" data-fee="3"> Livraison urgente (+3 ‚Ç¨)</label>
        <label class="service"><input type="checkbox" class="srv" data-fee="1"> Attente 5 min (+1 ‚Ç¨)</label>
        <label class="service"><input type="checkbox" class="srv" data-fee="2"> Attente 10 min (+2 ‚Ç¨)</label>
      </div>
      <label>Heure de livraison souhait√©e</label>
      <input id="time" type="datetime-local"/>
      <label>T√©l√©phone client</label>
      <input id="phone" type="tel" inputmode="tel" placeholder="+33 6 12 34 56 78"/>
      <div class="hint">Format recommand√© : international (+33‚Ä¶)</div>
      <button id="calc">üßÆ Calculer le prix</button>
      <button id="payCard">üí≥ Paiement par carte</button>
      <button id="payCash">üí∂ Paiement en esp√®ces</button>
      <div id="result"></div>
      <div id="map"></div>
    </div>
    <div class="footer">¬© 2025 AlexLivraison</div>
  </div>
  <script>
    const PRICE_PER_KM=0.9;
    const SIZE_FEES={S:0,M:0.5,L:1.0,XL:1.5};
    const REVOLUT_FALLBACK="https://checkout.revolut.com/pay/10d5b369-d7f0-43cb-a810-af4c7afe9d27";
    const BACKEND="https://alexlivraison-api.onrender.com";
    const $=s=>document.querySelector(s);
    const resBox=$("#result");
    const mapBox=$("#map");
    let lastCalc=null;
    function euro(v){return v.toFixed(2).replace(".",",")+" ‚Ç¨"}
    $("#from").value="2 Rue Beaussier, Toulon";
    $("#to").value="241 Rue Le Corbusier, La Seyne-sur-Mer";
    (function(){
      const t=new Date(Date.now()+30*60000);t.setSeconds(0,0);t.setMinutes(Math.round(t.getMinutes()/5)*5);
      const pad=n=>String(n).padStart(2,"0");
      $("#time").value=${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}T${pad(t.getHours())}:${pad(t.getMinutes())};
    })();
    async function geocode(q){
      const r=await fetch(https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)},{headers:{"Accept-Language":"fr"}});
      if(!r.ok)throw new Error("geo");
      const j=await r.json();
      if(!j.length)throw new Error("addr");
      return{lat:+j[0].lat,lon:+j[0].lon}
    }
    async function route(lat1,lon1,lat2,lon2){
      const r=await fetch(https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson);
      if(!r.ok)throw new Error("route");
      const j=await r.json();
      return{km:j.routes[0].distance/1000,geo:j.routes[0].geometry}
    }
    let map=null,routeLayer=null;
    function showMap(lat1,lon1,lat2,lon2,geo){
      if(!map){map=L.map("map");L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}).addTo(map)}
      if(routeLayer)routeLayer.remove();
      routeLayer=L.geoJSON(geo,{style:{color:"#6b23ff",weight:5,opacity:.85}}).addTo(map);
      map.fitBounds([[lat1,lon1],[lat2,lon2]]);
      mapBox.style.display="block"
    }
    async function notifyTelegram(payload){
      try{await fetch(${BACKEND}/notify,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})}catch(e){}
    }
    async function createCheckout(amount,note){
      try{
        const r=await fetch(${BACKEND}/pay,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount,currency:"EUR",note})});
        if(!r.ok)throw new Error("pay");
        const j=await r.json();
        if(j&&j.url)return j.url;
        throw new Error("no-url")
      }catch(e){return null}
    }
    async function doCalc(){
      const from=$("#from").value.trim();
      const to=$("#to").value.trim();
      const time=$("#time").value.trim();
      const phone=$("#phone").value.trim();
      if(!from||!to){alert("Veuillez saisir les adresses.");return}
      if(!time){alert("Veuillez indiquer l'heure souhait√©e.");return}
      if(!phone){alert("Veuillez indiquer le t√©l√©phone du client.");return}
      const size=$("#size").value;
      const floorFee=parseFloat($("#floor").value);
      let extras=0;document.querySelectorAll(".srv").forEach(x=>{if(x.checked)extras+=parseFloat(x.dataset.fee)});
      resBox.style.display="block";resBox.textContent="Calcul en cours‚Ä¶";
      try{
        const A=await geocode(from);const B=await geocode(to);
        const rt=await route(A.lat,A.lon,B.lat,B.lon);
        const dist=Math.round(rt.km*100)/100;
        const price=dist*PRICE_PER_KM+SIZE_FEES[size]+floorFee+extras;
        lastCalc={from,to,dist,price,size,floorFee,extras,time,phone};
        resBox.innerHTML=<b>Distance:</b> ${dist.toFixed(2)} km<br><b>Prix estim√©:</b> ${euro(price)}<br><b>Heure souhait√©e:</b> ${new Date(time).toLocaleString("fr-FR")};
        showMap(A.lat,A.lon,B.lat,B.lon,rt.geo)
      }catch(e){resBox.textContent="Erreur lors du calcul. V√©rifiez les adresses."}
    }
    $("#calc").addEventListener("click",doCalc);
    $("#payCash").addEventListener("click",async()=>{
      if(!lastCalc){alert("Calculez d'abord le prix.");return}
      alert("Commande enregistr√©e. Paiement en esp√®ces.");
      await notifyTelegram({method:"cash",from:lastCalc.from,to:lastCalc.to,size:lastCalc.size,time:lastCalc.time,phone:lastCalc.phone,distance_km:lastCalc.dist,total_eur:+lastCalc.price.toFixed(2)})
    });
    $("#payCard").addEventListener("click",async()=>{
      if(!lastCalc){alert("Calculez d'abord le prix.");return}
      await notifyTelegram({method:"card",from:lastCalc.from,to:lastCalc.to,size:lastCalc.size,time:lastCalc.time,phone:lastCalc.phone,distance_km:lastCalc.dist,total_eur:+lastCalc.price.toFixed(2)});
      const amount=+lastCalc.price.toFixed(2);
      const note=AlexLivraison ${lastCalc.from} ‚Üí ${lastCalc.to};
      const url=await createCheckout(amount,note);
      if(url){window.open(url,"_blank","noopener")}
      else{try{await navigator.clipboard.writeText(amount.toFixed(2))}catch(e){} window.open(REVOLUT_FALLBACK,"_blank","noopener")}
    });
  </script>
</body>
</html>
