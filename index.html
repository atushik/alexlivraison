<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AlexLivraison</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{--bg1:#32006b;--bg2:#7a2cf5;}
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Arial,Helvetica,sans-serif;color:#222;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));background-attachment:fixed;
    }
    .container{max-width:720px;margin:0 auto;padding:20px}
    h1{color:#fff;text-align:center;margin:10px 0 20px}
    .card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,.2)}
    label{display:block;margin-top:12px;font-weight:700}
    input,select{width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;margin-top:6px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .service{border:1px solid #ccc;border-radius:10px;padding:8px}
    button{width:100%;padding:14px;border:none;border-radius:10px;font-size:16px;margin-top:10px;cursor:pointer}
    #calc{background:#6b23ff;color:#fff}
    #payCard{background:#4caf50;color:#fff}
    #payCash{background:#e9e9e9}
    #result{display:none;background:#f6f4ff;border:1px dashed #aaa;border-radius:10px;margin-top:10px;padding:10px}
    #map{display:none;height:300px;border-radius:10px;margin-top:10px}
    .footer{color:#e9dcff;text-align:center;margin-top:18px}
  </style>
</head>
<body>
  <div class="container">
    <h1>üöó AlexLivraison üö¥üèª‚Äç‚ôÇÔ∏è</h1>

    <div class="card">
      <label>Adresse de d√©part</label>
      <input id="from" placeholder="2 Rue Beaussier, Toulon">

      <label>Adresse de destination</label>
      <input id="to" placeholder="241 Rue Le Corbusier, La Seyne-sur-Mer">

      <label>Taille du colis</label>
      <select id="size">
        <option value="S">Petit (S)</option>
        <option value="M" selected>Moyen (M)</option>
        <option value="L">Grand (L)</option>
        <option value="XL">Tr√®s grand (XL)</option>
      </select>

      <label>√âtage (optionnel)</label>
      <select id="floor">
        <option value="0">RDC / 1er (0 ‚Ç¨)</option>
        <option value="2">2e‚Äì5e (+2 ‚Ç¨)</option>
        <option value="2.5">6e‚Äì10e (+2,5 ‚Ç¨)</option>
        <option value="3">11e‚Äì15e (+3 ‚Ç¨)</option>
      </select>

      <label>Services additionnels</label>
      <div class="grid">
        <label class="service"><input type="checkbox" class="srv" data-fee="2"> Colis fragile (+2 ‚Ç¨)</label>
        <label class="service"><input type="checkbox" class="srv" data-fee="3"> Livraison urgente (+3 ‚Ç¨)</label>
        <label class="service"><input type="checkbox" class="srv" data-fee="1"> Attente 5 min (+1 ‚Ç¨)</label>
        <label class="service"><input type="checkbox" class="srv" data-fee="2"> Attente 10 min (+2 ‚Ç¨)</label>
      </div>

      <label>Heure de livraison souhait√©e</label>
      <select id="time"></select>

      <button id="calc">üßÆ Calculer le prix</button>
      <button id="payCard">üí≥ Paiement par carte</button>
      <button id="payCash">üí∂ Paiement en esp√®ces</button>

      <div id="result"></div>
      <div id="map"></div>
    </div>

    <div class="footer">¬© 2025 AlexLivraison</div>
  </div>

  <script>
    // --- Config ---
    var PRICE_PER_KM = 0.9;
    var SIZE_FEES = { S: 0, M: 0.5, L: 1.0, XL: 1.5 };
    var REVOLUT_LINK = "https://checkout.revolut.com/pay/10d5b369-d7f0-43cb-a810-af4c7afe9d27";

    // --- Helpers ---
    function $(s){ return document.querySelector(s); }
    function euro(v){ return v.toFixed(2).replace(".", ",") + " ‚Ç¨"; }

    var res = $("#result");
    var mapDiv = $("#map");
    var lastCalc = null;

    // Fill time options (30-min steps next 24h)
    (function(){
      var sel = $("#time");
      var now = new Date();
      for(var i=0;i<48;i++){
        var t = new Date(now.getTime() + i*30*60000);
        var dd = String(t.getDate()).padStart(2,"0");
        var mo = String(t.getMonth()+1).padStart(2,"0");
        var hh = String(t.getHours()).padStart(2,"0");
        var mm = String(t.getMinutes()).padStart(2,"0");
        var label = dd + "/" + mo + " " + hh + ":" + mm;
        var o = document.createElement("option");
        o.value = label; o.textContent = label;
        sel.appendChild(o);
      }
    })();

    // --- Geocoding + routing (OSM/OSRM) ---
    async function geocode(q){
      var url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(q);
      var r = await fetch(url, { headers: { "Accept-Language":"fr" }});
      if(!r.ok) throw new Error("geo");
      var j = await r.json();
      if(!j.length) throw new Error("addr");
      return { lat: +j[0].lat, lon: +j[0].lon };
    }

    async function route(lat1, lon1, lat2, lon2){
      var url = "https://router.project-osrm.org/route/v1/driving/" + lon1 + "," + lat1 + ";" + lon2 + "," + lat2 + "?overview=full&geometries=geojson";
      var r = await fetch(url);
      if(!r.ok) throw new Error("route");
      var j = await r.json();
      return { km: j.routes[0].distance/1000, geo: j.routes[0].geometry };
    }

    // --- Map (Leaflet) ---
    var map = null, routeLayer = null;
    function showMap(lat1, lon1, lat2, lon2, geo){
      if(!map){
        map = L.map("map");
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "¬© OpenStreetMap" }).addTo(map);
      }
      if(routeLayer){ routeLayer.remove(); }
      routeLayer = L.geoJSON(geo, { style: { color:"#6b23ff", weight:5, opacity:0.8 } }).addTo(map);
      map.fitBounds([[lat1,lon1],[lat2,lon2]]);
      mapDiv.style.display = "block";
    }

    // --- Calculation ---
    async function doCalc(){
      var from = $("#from").value.trim();
      var to   = $("#to").value.trim();
      if(!from || !to){ alert("Veuillez saisir les adresses."); return; }

      var size = $("#size").value;
      var floorFee = parseFloat($("#floor").value);
      var extras = 0;
      var srv = document.querySelectorAll(".srv");
      for(var i=0;i<srv.length;i++){ if(srv[i].checked) extras += parseFloat(srv[i].dataset.fee); }

      res.style.display = "block";
      res.textContent = "Calcul en cours‚Ä¶";

      try{
        var A = await geocode(from);
        var B = await geocode(to);
        var rt = await route(A.lat, A.lon, B.lat, B.lon);
        var dist = Math.round(rt.km*100)/100;
        var price = dist*PRICE_PER_KM + SIZE_FEES[size] + floorFee + extras;
        lastCalc = { dist: dist, price: price };

        res.innerHTML =
          "<b>Distance:</b> " + dist.toFixed(2) + " km<br>" +
          "<b>Prix estim√©:</b> " + euro(price);

        showMap(A.lat, A.lon, B.lat, B.lon, rt.geo);
      }catch(e){
        res.textContent = "Erreur lors du calcul. V√©rifiez les adresses.";
      }
    }

    $("#calc").addEventListener("click", doCalc);

    $("#payCash").addEventListener("click", function(){
      if(!lastCalc){ alert("Calculez d'abord le prix."); return; }
      alert("Paiement en esp√®ces: " + euro(lastCalc.price));
    });

    $("#payCard").addEventListener("click", function(){
      if(!lastCalc){ alert("Calculez d'abord le prix."); return; }
      try{ navigator.clipboard.writeText(lastCalc.price.toFixed(2)); }catch(e){}
      window.open(REVOLUT_LINK, "_blank", "noopener");
    });

    // defaults
    $("#from").value = "2 Rue Beaussier, Toulon";
    $("#to").value = "241 Rue Le Corbusier, La Seyne-sur-Mer";
  </script>
</body>
</html>
