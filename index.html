<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üöóAlexLivraisonüö¥üèª‚Äç‚ôÇÔ∏è ‚Äì Livraison locale 24/7</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

  <style>
    :root{
      --violet:#5f0fb6; --violet2:#7a3cf6; --bg:#1b0a4a; --bg2:#2a0b75; --text:#111;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text);
      min-height:100vh; overflow-x:hidden;
      background: radial-gradient(1400px 900px at 15% -200px, var(--violet2) 0, var(--bg2) 45%, var(--bg) 100%) fixed;
      position:relative;
    }
    /* –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –ª—ë–≥–∫–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω */
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.4;
      background-image:
        radial-gradient(rgba(255,255,255,.05) 2px, transparent 2px),
        radial-gradient(rgba(255,255,255,.04) 1px, transparent 1px);
      background-position: 0 0, 20px 20px; background-size: 40px 40px, 40px 40px;
    }
    /* –ü–ª–∞–≤–∞—é—â–∏–µ –∏–∫–æ–Ω–∫–∏ */
    .bg-icons{position:fixed; inset:0; pointer-events:none; overflow:hidden}
    .bg-icons span{
      position:absolute; font-size:42px; opacity:.18; filter:drop-shadow(0 6px 12px rgba(0,0,0,.35));
      animation: float 22s linear infinite;
    }
    @keyframes float{
      0%{ transform: translateY(0) translateX(0) rotate(0deg); }
      50%{ transform: translateY(-20px) translateX(10px) rotate(3deg); }
      100%{ transform: translateY(0) translateX(0) rotate(0deg); }
    }

    .container{max-width:760px;margin:0 auto;padding:32px 16px 100px;position:relative}
    .title{
      color:#fff; font-weight:900; font-size:44px; letter-spacing:.3px; text-align:center;
      text-shadow:0 8px 40px rgba(0,0,0,.5), 0 0 18px rgba(122,60,246,.55);
      margin:8px 0 6px;
    }
    .title .brand{
      background:linear-gradient(135deg,#fff,#e9d9ff); -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .subtitle{color:#e9d8ff; text-align:center; margin:0 0 10px; font-weight:600}

    .card{
      background:#fff; border-radius:22px; padding:22px;
      box-shadow:0 24px 70px rgba(0,0,0,.28); margin-top:18px;
    }
    label{font-weight:800; color:#362c68; margin:10px 0 6px; display:flex; align-items:center; gap:8px}
    .tip{font-size:12px;color:#6b6b6b}
    input, select{
      width:100%; height:52px; font-size:16px; padding:0 14px; border:1px solid #e7e7f5; border-radius:14px; outline:none;
    }
    input:focus, select:focus{box-shadow:0 0 0 3px rgba(127,94,255,.18); border-color:#d0c7ff}
    .row{margin:8px 0 12px}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:640px){ .two{grid-template-columns:1fr} }

    .btn{
      width:100%; height:56px; border-radius:14px; border:none; cursor:pointer;
      color:#fff; background:linear-gradient(135deg,var(--violet2),var(--violet)); font-weight:900; font-size:18px;
      box-shadow:0 14px 30px rgba(95,15,182,.35); margin-top:10px;
      transition:transform .05s ease, filter .2s;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#eef; color:#241a63; border:1px solid #dad5ff; box-shadow:none}

    .result{
      background:#f7f6ff; border:1px dashed #cbbaff; border-radius:14px; padding:12px;
      font-weight:800; color:#2a195e; margin-top:12px
    }
    #map{height:320px;margin-top:16px;border-radius:16px;overflow:hidden;border:1px solid #eee}

    .note,.footer{color:#e9d8ff; text-align:center; margin-top:18px}
    .footer{font-size:14px}
  </style>
</head>
<body>
  <!-- –ü–ª–∞–≤–∞—é—â–∏–µ –∏–∫–æ–Ω–∫–∏ (–ª—ë–≥–∫–∞—è –∞–Ω–∏–º–∞—Ü–∏—è) -->
  <div class="bg-icons" aria-hidden="true">
    <span style="left:6%; top:20%; animation-duration:24s">üöó</span>
    <span style="left:82%; top:18%; animation-duration:26s">üì¶</span>
    <span style="left:70%; top:72%; animation-duration:23s">üö¥üèª‚Äç‚ôÇÔ∏è</span>
    <span style="left:14%; top:70%; animation-duration:27s">üì¶</span>
    <span style="left:50%; top:10%; animation-duration:25s">üöó</span>
  </div>

  <div class="container">
    <h1 class="title">üöó<span class="brand">AlexLivraison</span>üö¥üèª‚Äç‚ôÇÔ∏è</h1>
    <p class="subtitle">Livraison locale 24h/24 et 7j/7 ‚Äî Var (Toulon, La Seyne, Ollioules, etc.)</p>

    <div class="card">
      <label title="Adresse o√π l‚Äôon r√©cup√®re le colis">Adresse de d√©part</label>
      <div class="row"><input id="from" placeholder="Ex : 2 Rue Beaussier, Toulon"></div>

      <label title="Adresse o√π livrer le colis">Adresse de destination</label>
      <div class="row"><input id="to" placeholder="Ex : 241 Rue Le Corbusier, La Seyne"></div>

      <div class="two">
        <div>
          <label title="La taille du colis influe le tarif">Taille du colis üì¶</label>
          <select id="size" title="S, M, L, XL ‚Äì majoration selon volume">
            <option value="S">Petit (S)</option>
            <option value="M" selected>Moyen (M)</option>
            <option value="L">Grand (L)</option>
            <option value="XL">Tr√®s grand (XL)</option>
          </select>
        </div>
        <div>
          <label title="S√©lectionnez l‚Äô√©tage si la livraison n√©cessite une mont√©e">√âtage (optionnel)</label>
          <select id="floor" title="+2‚Äì3 ‚Ç¨ selon l‚Äô√©tage">
            <option value="0">Rez-de-chauss√©e / 1er (0 ‚Ç¨)</option>
            <option value="2">2·µâ √©tage (+2.00 ‚Ç¨)</option>
            <option value="3">3·µâ √©tage (+2.50 ‚Ç¨)</option>
            <option value="4">4·µâ √©tage (+3.00 ‚Ç¨)</option>
            <option value="5">5·µâ √©tage (+3.00 ‚Ç¨)</option>
            <option value="6">6·µâ √©tage (+3.00 ‚Ç¨)</option>
            <option value="7">7·µâ √©tage (+3.00 ‚Ç¨)</option>
            <option value="8">8·µâ √©tage (+3.00 ‚Ç¨)</option>
            <option value="9">9·µâ √©tage (+3.00 ‚Ç¨)</option>
            <option value="10">10·µâ √©tage (+3.00 ‚Ç¨)</option>
            <option value="11">11·µâ √©tage (+3.00 ‚Ç¨)</option>
            <option value="12">12·µâ √©tage (+3.00 ‚Ç¨)</option>
            <option value="13">13·µâ √©tage (+3.00 ‚Ç¨)</option>
            <option value="14">14·µâ √©tage (+3.00 ‚Ç¨)</option>
            <option value="15">15·µâ √©tage (+3.00 ‚Ç¨)</option>
          </select>
          <div class="tip">+2‚Äì3 ‚Ç¨ selon l‚Äô√©tage</div>
        </div>
      </div>

      <div class="two">
        <div>
          <label>Heure de livraison</label>
          <select id="time"></select>
        </div>
        <div style="display:flex; align-items:end">
          <label style="display:flex; align-items:center; gap:10px; margin:0">
            <input type="checkbox" id="urgent" style="width:18px; height:18px"> Livraison urgente (+3 ‚Ç¨)
          </label>
        </div>
      </div>

      <button id="calc" class="btn">üßÆ Calculer le prix</button>
      <div id="result" class="result" style="display:none"></div>
      <div id="map" style="display:none"></div>

      <div class="two">
        <button id="payCard" class="btn">üí≥ Paiement par carte</button>
        <button id="payCash" class="btn secondary">üí∂ Paiement en esp√®ces</button>
      </div>
    </div>

    <p class="footer">üíú Nous livrons vos commandes jusqu'√† votre porte üíú<br>¬© 2025 Alex Livraison</p>
  </div>

  <script>
    // ===== Config (–ø–æ–º–µ–Ω—è–π URL, –µ—Å–ª–∏ Render –¥—Ä—É–≥–æ–π) =====
    const API_BASE = "https://alexlivraison-api.onrender.com";

    const PRICE_PER_KM = 0.9;
    const MIN_PRICE = 3.0;
    const NIGHT_FEE = 2.0;   // >=22:00 ou <06:00
    const URGENT_FEE = 3.0;  // option urgente
    const SIZE_MULT = { S:1.0, M:1.3, L:1.6, XL:2.0 };

    function floorSurcharge(floor){
      const f = Number(floor);
      if (f <= 1) return 0;
      if (f === 2) return 2.0;
      if (f === 3) return 2.5;
      if (f >= 4 && f <= 15) return 3.0;
      return 0;
    }

    const $ = s => document.querySelector(s);
    let map, layer;
    const resultEl = $("#result");
    const mapEl = $("#map");

    // –í—Ä–µ–º—è (–∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç, –Ω–∞ 18 —à–∞–≥–æ–≤ –≤–ø–µ—Ä—ë–¥)
    (function fillTimes(){
      const sel = $("#time"), now = new Date();
      for(let i=0;i<36;i++){
        const t = new Date(now.getTime()+i*30*60000);
        const label = t.toLocaleDateString("fr-FR")+" "+String(t.getHours()).padStart(2,"0")+":"+String(t.getMinutes()).padStart(2,"0");
        const opt = document.createElement("option");
        opt.value = label; opt.textContent = label; sel.appendChild(opt);
      }
    })();

    async function geocode(q){
      const r = await fetch("https://nominatim.openstreetmap.org/search?format=json&limit=1&q="+encodeURIComponent(q));
      const j = await r.json();
      if(!j.length) throw new Error("Adresse introuvable");
      return { lat:+j[0].lat, lon:+j[0].lon };
    }

    async function route(A,B){
      const url = "https://router.project-osrm.org/route/v1/driving/"+A.lon+","+A.lat+";"+B.lon+","+B.lat+"?overview=full&geometries=geojson";
      const r = await fetch(url); const j = await r.json();
      const rt = j.routes && j.routes[0]; if(!rt) throw new Error("Itin√©raire introuvable");
      return { km: rt.distance/1000, geo: rt.geometry };
    }

    function ensureMap(geo, A, B){
      if(!map){
        map = L.map("map");
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{ attribution:"¬© OpenStreetMap" }).addTo(map);
      }
      if(layer) layer.remove();
      layer = L.geoJSON(geo, { style:{ color:"#7a3cf6", weight:6, opacity:0.85 } }).addTo(map);
      map.fitBounds([[A.lat,A.lon],[B.lat,B.lon]]);
      mapEl.style.display = "block";
    }

    function euros(n){ return (Math.round(n*100)/100).toFixed(2).replace(".", ",")+" ‚Ç¨"; }

    let lastCalc = null;

    $("#calc").addEventListener("click", async ()=>{
      const from = $("#from").value.trim();
      const to   = $("#to").value.trim();
      const size = $("#size").value;
      const floor= $("#floor").value;
      const when = $("#time").value;
      const urgent = $("#urgent").checked;

      if(!from || !to){ alert("Veuillez remplir les deux adresses."); return; }

      resultEl.style.display = "block";
      resultEl.textContent = "Calcul en cours‚Ä¶";

      try{
        const [A,B] = await Promise.all([geocode(from), geocode(to)]);
        const r = await route(A,B);
        const km = Math.max(1, Math.round(r.km*100)/100);

        let price = km * PRICE_PER_KM * (SIZE_MULT[size] || 1);
        const hour = Number(when.split(" ")[1]?.split(":")[0] || "12");
        if (hour >= 22 || hour < 6) price += NIGHT_FEE;
        if (urgent) price += URGENT_FEE;
        price += floorSurcharge(floor);
        if (price < MIN_PRICE) price = MIN_PRICE;

        lastCalc = { from, to, size, floor, urgent, when, km, price };

        ensureMap(r.geo, A, B);
        resultEl.innerHTML =
          "üöö Distance : <b>"+km.toFixed(2)+" km</b><br>"+
          "üí∂ Prix : <b>"+euros(price)+"</b><br>"+
          "üì¶ Taille : "+size+" ‚Äî üè¢ √âtage: "+(floor>1?floor+"e":"RDC/1er")+(urgent?" ‚Äî üö® Urgente":"")+"<br>"+
          "üïí "+when;
      }catch(e){
        resultEl.textContent = "Erreur lors du calcul. V√©rifiez les adresses.";
      }
    });

    async function notifyTelegram(text){
      try{
        await fetch(API_BASE + "/api/notify-telegram", {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ text })
        });
      }catch(e){}
    }

    $("#payCash").addEventListener("click", async ()=>{
      if(!lastCalc){ alert("Veuillez d‚Äôabord calculer le prix."); return; }
      await notifyTelegram(
        "üßæ Nouvelle commande (Esp√®ces)\n"+
        "De: "+lastCalc.from+"\n√Ä: "+lastCalc.to+
        "\nDistance: "+lastCalc.km.toFixed(2)+" km"+
        "\nPrix: "+lastCalc.price.toFixed(2)+" ‚Ç¨"+
        "\nTaille: "+lastCalc.size+" | √âtage: "+lastCalc.floor+(lastCalc.urgent?" | Urgente":"")+
        "\nHeure: "+lastCalc.when
      );
      alert("Commande confirm√©e ‚úÖ Paiement en esp√®ces.");
    });

    $("#payCard").addEventListener("click", async ()=>{
      if(!lastCalc){ alert("Veuillez d‚Äôabord calculer le prix."); return; }
      await notifyTelegram(
        "üßæ Nouvelle commande (Carte)\n"+
        "De: "+lastCalc.from+"\n√Ä: "+lastCalc.to+
        "\nDistance: "+lastCalc.km.toFixed(2)+" km"+
        "\nPrix: "+lastCalc.price.toFixed(2)+" ‚Ç¨"+
        "\nTaille: "+lastCalc.size+" | √âtage: "+lastCalc.floor+(lastCalc.urgent?" | Urgente":"")+
        "\nHeure: "+lastCalc.when
      );
      try{
        const r = await fetch(API_BASE + "/api/create-payment", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({
            amount_eur: Number(lastCalc.price.toFixed(2)),
            description: "Livraison: "+lastCalc.from+" ‚Üí "+lastCalc.to
          })
        });
        const data = await r.json();
        if (!r.ok  !data.url) throw new Error(data.error  "Pas d‚ÄôURL paiement");
        window.open(data.url, "_blank", "noopener");
      }catch(e){
        alert("Erreur de paiement. R√©essayez.");
      }
    });

    // Valeurs de test
    $("#from").value = "2 Rue Beaussier, Toulon";
    $("#to").value   = "241 Rue Le Corbusier, La Seyne-sur-Mer";
  </script>
</body>
</html>
