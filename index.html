<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🚗 AlexLivraison 🚴🏻‍♂️</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root {
      --violet: #5a00c5;
      --violet-dark: #3b007f;
      --white: #fff;
      --text: #222;
      --gray: #777;
    }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", system-ui, sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, #1a0033, #3c0078);
      background-image: url('https://i.imgur.com/1bGZrUQ.jpg');
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 28px 16px 80px;
      backdrop-filter: blur(10px);
      animation: fadeIn 1s ease;
    }

    .title {
      color: #fff;
      font-weight: 800;
      font-size: 40px;
      letter-spacing: .4px;
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 18px;
      text-shadow: 0 3px 6px rgba(0,0,0,.3);
    }

    .card {
      background: rgba(255,255,255,0.93);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      animation: slideUp 0.9s ease;
    }

    .label {
      text-align: center;
      font-weight: 700;
      font-size: 18px;
      margin: 8px 0 6px;
    }

    input, select {
      width: 100%;
      height: 50px;
      border-radius: 14px;
      border: 1px solid #ddd;
      font-size: 17px;
      padding: 0 14px;
      outline: none;
      transition: 0.2s border ease;
    }
    input:focus, select:focus { border-color: var(--violet); }

    .btn {
      width: 100%;
      height: 54px;
      border: none;
      border-radius: 14px;
      font-size: 18px;
      font-weight: 700;
      color: white;
      background: var(--violet);
      cursor: pointer;
      margin-top: 12px;
      box-shadow: 0 6px 20px rgba(90,0,197,.35);
      transition: 0.25s all ease;
      opacity: 0;
      transform: translateY(15px);
      animation: btnPop 1s forwards;
    }
    .btn:hover { transform: scale(1.02); }
    .btn:active { background: var(--violet-dark); transform: scale(0.98); }

    .btn-outline {
      background: #ddd;
      color: #000;
      box-shadow: none;
    }

    #result, #map {
      margin-top: 16px;
      border-radius: 14px;
      opacity: 0;
      animation: fadeIn 1s ease forwards;
    }

    #map { height: 320px; border: 1px solid #ccc; }

    .hidden { display: none; }
    .footer {
      text-align: center;
      color: #eee;
      margin-top: 20px;
      font-size: 14px;
      animation: fadeIn 2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes btnPop {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title">🚗 AlexLivraison 🚴🏻‍♂️</div>

    <div class="card">
      <div class="label">Adresse de départ</div>
      <input id="from" placeholder="Ex : 2 Rue Beaussier, Toulon" />

      <div class="label">Adresse de destination</div>
      <input id="to" placeholder="Ex : 241 Rue Le Corbusier, La Seyne" />

      <div class="label">Taille du colis 📦</div>
      <select id="size">
        <option value="S">Petit (S)</option>
        <option value="M">Moyen (M)</option>
        <option value="L">Grand (L)</option>
        <option value="XL">Très grand (XL)</option>
      </select>

      <div class="label">Étage (si applicable)</div>
      <select id="floor">
        <option value="0">Rez-de-chaussée</option>
        <option value="2">2e étage</option>
        <option value="5">5e étage</option>
        <option value="10">10e étage</option>
        <option value="15">15e étage</option>
      </select>

      <div class="label">Heure de livraison souhaitée</div>
      <select id="time"></select>

      <button id="calc" class="btn">🧮 Calculer le prix</button>
      <button id="payCard" class="btn">💳 Paiement par carte</button>
      <button id="payCash" class="btn btn-outline">💶 Paiement en espèces</button>

      <div id="result" class="hidden"></div>
      <div id="map" class="hidden"></div>
    </div>

    <p class="footer">
      🚲 Livraison locale 24h/24 et 7j/7 — Var (Toulon, La Seyne, Ollioules, etc.)<br>
      💜 © 2025 AlexLivraison
    </p>
  </div>

  <script>
    const PRICE_PER_KM = 0.9;
    const FLOOR_EXTRA = { "0": 0, "2": 2, "5": 2.5, "10": 3, "15": 3 };
    const SIZE_MULT = { "S": 1, "M": 1.2, "L": 1.4, "XL": 1.6 };
    const REVOLUT_LINK = "https://checkout.revolut.com/pay/10d5b369-d7f0-43cb-a810-af4c7afe9d27";
    const TG_TOKEN = "8003065650:AAGJH_PRNHQ7jVDm9q96G6zlHt-IXkxKHnA";
    const TG_CHAT_ID = "7129872491";

    const $ = s => document.querySelector(s);
    const euro = v => (Math.round(v*100)/100).toFixed(2)+" €";

    (function fillTimes(){
      const t = $("#time");
      const now = new Date();
      for (let i=0; i<36; i++){
        const d = new Date(now.getTime()+i*30*60000);
        const opt = document.createElement("option");
        opt.value = opt.textContent = d.toLocaleString("fr-FR", { dateStyle:"short", timeStyle:"short" });
        t.appendChild(opt);
      }
    })();

    async function geocode(q){
      const r = await fetch(https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1);
      const j = await r.json();
      if (!j.length) throw new Error("Adresse introuvable");
      return {lat:+j[0].lat, lon:+j[0].lon};
    }

    async function route(a,b){
      const r = await fetch(https://router.project-osrm.org/route/v1/driving/${a.lon},${a.lat};${b.lon},${b.lat}?overview=full&geometries=geojson);
      const j = await r.json();
      const km = j.routes[0].distance / 1000;
      return { km, geo:j.routes[0].geometry };
    }

    async function notifyTelegram(msg){
      const body = new URLSearchParams({ chat_id: TG_CHAT_ID, text: msg });
      await fetch(https://api.telegram.org/bot${TG_TOKEN}/sendMessage, { method: "POST", body });
    }

    let last = null;
    $("#calc").onclick = async ()=>{
      const from = $("#from").value.trim(), to = $("#to").value.trim();
      const size = $("#size").value, floor = $("#floor").value, when = $("#time").value;
      if (!from || !to){ alert("Merci de saisir les deux adresses"); return; }

      $("#result").classList.remove("hidden");
      $("#result").innerHTML = "🕒 Calcul en cours...";

      try {
        const [A,B] = await Promise.all([geocode(from), geocode(to)]);
        const {km, geo} = await route(A,B);
        const dist = Math.max(1, Math.round(km*100)/100);
        const base = dist * PRICE_PER_KM * SIZE_MULT[size] + FLOOR_EXTRA[floor];
        const price = Math.round(base*100)/100;

        last = {from,to,km:dist,price,size,floor,when};
        $("#result").innerHTML = 🚚 Distance : ${dist.toFixed(2)} km<br>💶 Prix : ${euro(price)}<br>📦 Taille : ${size} — 🏢 Étage : ${floor}<br>🕒 ${when};

        if (!window.map){
          window.map = L.map("map");
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:"© OSM"}).addTo(map);
        } else { map.eachLayer(l=>l.remove()); }
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:"© OSM"}).addTo(map);
        L.geoJSON(geo,{color:"#6c4cff",weight:5}).addTo(map);
        map.fitBounds([[A.lat,A.lon],[B.lat,B.lon]]);
        $("#map").classList.remove("hidden");
      } catch(e){
        $("#result").innerHTML = "⚠️ Erreur : adresse invalide.";
      }
    };

    $("#payCash").onclick = async ()=>{
      if (!last) return alert("Calculez d'abord le prix !");
      await notifyTelegram(🧾 Nouvelle commande (Espèces)\nDe: ${last.from}\nÀ: ${last.to}\nDistance: ${last.km} km\nPrix: ${last.price} €\nTaille: ${last.size}\nÉtage: ${last.floor}\nHeure: ${last.when});
      alert("Commande enregistrée ✅ Paiement en espèces.");
    };

    $("#payCard").onclick = async ()=>{
      if (!last) return alert("Calculez d'abord le prix !");
      await notifyTelegram(💳 Nouvelle commande (Carte)\nDe: ${last.from}\nÀ: ${last.to}\nDistance: ${last.km} km\nPrix: ${last.price} €\nTaille: ${last.size}\nÉtage: ${last.floor}\nHeure: ${last.when});
      window.open(REVOLUT_LINK, "_blank");
    };
  </script>
</body>
</html>
