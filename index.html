<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🚗 AlexLivraison 🚴🏻‍♂️</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root {
      --violet:#5f0fb6;
      --violet-dark:#4a0a8f;
    }
    *{box-sizing:border-box}
    body {
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      background:linear-gradient(135deg,#4e00b8,#2a006f);
      background-attachment:fixed;
      color:#222;
      min-height:100vh;
    }
    .container {max-width:680px;margin:0 auto;padding:28px 16px 80px}
    .title {color:#fff;text-align:center;font-size:38px;font-weight:800;margin:6px 0 14px}
    .card {background:#fff;border-radius:20px;padding:22px;box-shadow:0 10px 35px rgba(0,0,0,.25)}
    .label {font-weight:700;margin:12px 0 6px}
    input,select {
      width:100%;
      height:48px;
      font-size:16px;
      padding:0 12px;
      border:1px solid #ccc;
      border-radius:10px;
    }
    .services {
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:8px;
    }
    .services label {
      border:1px solid #ddd;
      border-radius:10px;
      padding:8px;
      background:#fafafa;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .btn {
      width:100%;
      height:54px;
      border:none;
      border-radius:14px;
      color:#fff;
      font-size:18px;
      font-weight:700;
      margin-top:12px;
      cursor:pointer;
    }
    .btn-main {background:var(--violet)}
    .btn-main:hover {background:var(--violet-dark)}
    .btn-alt {background:#e9e9e9;color:#222}
    #result {margin-top:14px;background:#fff;border-radius:10px;padding:10px;border:1px dashed #bbb;font-weight:600}
    #map {height:300px;margin-top:12px;border-radius:10px}
    .hidden {display:none}
    .foot {color:#fff;text-align:center;margin-top:20px;line-height:1.35}
  </style>
</head>
<body>
  <div class="container">
    <div class="title">🚗 AlexLivraison 🚴🏻‍♂️</div>

    <div class="card">
      <div class="label">Adresse de départ</div>
      <input id="from" placeholder="Ex : 2 Rue Beaussier, Toulon" />

      <div class="label">Adresse de destination</div>
      <input id="to" placeholder="Ex : 241 Rue Le Corbusier, La Seyne-sur-Mer" />

      <div class="label">Taille du colis 📦</div>
      <select id="size">
        <option value="S">Petit (S)</option>
        <option value="M">Moyen (M)</option>
        <option value="L">Grand (L)</option>
        <option value="XL">Très grand (XL)</option>
      </select>

      <div class="label">Étage (optionnel)</div>
      <select id="floor">
        <option value="0">RDC / 1er (0 €)</option>
        <option value="1">2e — 4e étage (+2 €)</option>
        <option value="2">5e — 10e étage (+3 €)</option>
        <option value="3">11e — 15e étage (+4 €)</option>
      </select>

      <div class="label">Services additionnels</div>
      <div class="services">
        <label><input type="checkbox" value="2" class="extra">Colis fragile (+2 €)</label>
        <label><input type="checkbox" value="3" class="extra">Livraison urgente (+3 €)</label>
        <label><input type="checkbox" value="1" class="extra">Attente 5 min (+1 €)</label>
        <label><input type="checkbox" value="2" class="extra">Attente 10 min (+2 €)</label>
      </div>

      <div class="label">Heure de livraison souhaitée</div>
      <select id="time"></select>

      <button id="calc" class="btn btn-main">🧮 Calculer le prix</button>
      <button id="payCard" class="btn btn-main">💳 Paiement par carte</button>
      <button id="payCash" class="btn btn-alt">💶 Paiement en espèces</button>

      <div id="result" class="hidden"></div>
      <div id="map" class="hidden"></div>
    </div>

    <p class="foot">💜 Nous livrons vos commandes jusqu’à votre porte<br>© 2025 Alex Livraison</p>
  </div>

<script>
  // Configuration
  var PRICE_PER_KM = 0.9;
  var REVOLUT_LINK = "https://checkout.revolut.com/pay/10d5b369-d7f0-43cb-a810-af4c7afe9d27";
  var TG_TOKEN = "8003065650:AAGJH_PRNHQ7jVDm9q96G6zlHt-IXkxKHnA";
  var TG_CHAT_ID = "7129872491";

  function $(s){ return document.querySelector(s); }
  function euro(n){ return n.toFixed(2).replace(".", ",") + " €"; }

  // Time selector
  (function(){
    var sel = $("#time");
    var now = new Date();
    for(var i=0;i<36;i++){
      var t = new Date(now.getTime() + i*30*60000);
      var label = t.toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
      var opt = document.createElement("option");
      opt.value = label;
      opt.textContent = label;
      sel.appendChild(opt);
    }
  })();

  async function geocode(q){
    var url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&accept-language=fr&q=" + encodeURIComponent(q);
    var res = await fetch(url, {headers:{'User-Agent':'alexlivraison'}});
    var js = await res.json();
    if(!js.length) throw new Error("Adresse introuvable");
    return {lat: parseFloat(js[0].lat), lon: parseFloat(js[0].lon)};
  }

  async function route(lat1,lon1,lat2,lon2){
    var url = "https://router.project-osrm.org/route/v1/driving/"+lon1+","+lat1+";"+lon2+","+lat2+"?overview=full&geometries=geojson";
    var res = await fetch(url);
    var js = await res.json();
    if(!js.routes || !js.routes.length) throw new Error("Itinéraire introuvable");
    var r = js.routes[0];
    return {km: r.distance/1000, geojson: r.geometry};
  }

  async function notifyTelegram(text){
    var url = "https://api.telegram.org/bot"+TG_TOKEN+"/sendMessage";
    var body = new URLSearchParams({chat_id: TG_CHAT_ID, text: text});
    try{ await fetch(url,{method:"POST",body:body}); }catch(e){}
  }

  var lastCalc = null;
  var map, routeLayer;

  $("#calc").addEventListener("click", async function(){
    var from = $("#from").value.trim();
    var to = $("#to").value.trim();
    var size = $("#size").value;
    var floor = parseInt($("#floor").value,10);
    var extras = document.querySelectorAll(".extra:checked");
    var when = $("#time").value;
    var resultBox = $("#result");
    var mapBox = $("#map");

    if(!from || !to){ alert("Veuillez saisir les deux adresses."); return; }
    resultBox.classList.remove("hidden");
    resultBox.textContent = "Calcul en cours...";

    try{
      var g = await Promise.all([geocode(from), geocode(to)]);
      var A = g[0], B = g[1];
      var r = await route(A.lat,A.lon,B.lat,B.lon);

      if(!map){
        map = L.map("map");
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}).addTo(map);
      }
      if(routeLayer){ routeLayer.remove(); }
      routeLayer = L.geoJSON(r.geojson,{style:{color:"#5f0fb6",weight:6,opacity:0.7}}).addTo(map);
      map.fitBounds([[A.lat,A.lon],[B.lat,B.lon]]);
      mapBox.classList.remove("hidden");

      var price = r.km * PRICE_PER_KM;
      if(size==="M") price += 1;
      if(size==="L") price += 2;
      if(size==="XL") price += 3;
      if(floor===1) price += 2;
      if(floor===2) price += 3;
      if(floor===3) price += 4;
      for(var i=0;i<extras.length;i++){ price += parseFloat(extras[i].value); }

      lastCalc = {from:from,to:to,km:r.km,price:price,size:size,floor:floor,when:when};

      resultBox.innerHTML =
        "🚚 Distance : " + r.km.toFixed(2) + " km<br>" +
        "💶 Prix total : " + euro(price) + "<br>" +
        "📦 Taille : " + size + " — Étage : " + floor + " — 🕒 " + when;
    }catch(err){
      resultBox.textContent = "Erreur lors du calcul. Vérifiez les adresses.";
    }
  });

  $("#payCash").addEventListener("click", async function(){
    if(!lastCalc){ alert("Calculez d’abord le prix."); return; }
    await notifyTelegram("🧾 Nouvelle commande (Espèces)\nDe: "+lastCalc.from+"\nÀ: "+lastCalc.to+"\n"+lastCalc.km.toFixed(2)+" km, "+lastCalc.price.toFixed(2)+" €");
    alert("Commande confirmée. Paiement en espèces.");
  });

  $("#payCard").addEventListener("click", async function(){
    if(!lastCalc){ alert("Calculez d’abord le prix."); return; }
    await notifyTelegram("🧾 Nouvelle commande (Carte)\nDe: "+lastCalc.from+"\nÀ: "+lastCalc.to+"\n"+lastCalc.km.toFixed(2)+" km, "+lastCalc.price.toFixed(2)+" €");
    window.open(REVOLUT_LINK, "_blank", "noopener");
  });

  $("#from").value = "2 Rue Beaussier, Toulon";
  $("#to").value   = "241 Rue Le Corbusier, La Seyne-sur-Mer";
</script>
</body>
</html>
