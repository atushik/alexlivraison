<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Partenaires • Pharmacies | AlexLivraison</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{--violet:#6b23ff;--violet-dark:#32006b;--green:#4caf50;--ring:#ffffff35}
html,body{height:100%;margin:0;padding:0;overflow-x:hidden}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#222;background:linear-gradient(180deg,#32006b,#7a2cf5);background-attachment:fixed}
*{box-sizing:border-box}
img{max-width:100%;height:auto;display:block}
.wrap{width:100%;max-width:1060px;margin:0 auto;padding:16px}
.topbar{position:sticky;top:0;z-index:50;width:100%;backdrop-filter:saturate(160%) blur(12px);background:linear-gradient(180deg,rgba(20,0,45,.86),rgba(20,0,45,.52));border-bottom:1px solid var(--ring)}
.topbar-inner{display:flex;align-items:center;gap:14px;justify-content:space-between;padding:12px 16px;color:#fff}
.brand{display:flex;align-items:center;gap:10px}
.brand img{width:120px;height:auto}
.btn{display:inline-block;padding:12px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:700}
.btn-primary{background:#6b23ff;color:#fff}
.btn-ghost{background:#ffffff14;color:#fff;border:1px solid #ffffff33}
.card{background:#fff;border-radius:14px;padding:18px;box-shadow:0 14px 40px rgba(0,0,0,.22);margin:14px 0}
.h1{color:#fff;margin:18px 0 8px 0;font-weight:900}
.h2{margin:0 0 12px 0;font-weight:900}
.muted{color:#000;font-weight:500}
label{display:block;margin-top:10px;font-weight:700}
input,select,textarea{width:100%;padding:12px;margin-top:6px;border-radius:10px;border:1px solid #cfd0d8;outline:none}
textarea{min-height:110px;resize:vertical}
input:focus,select:focus,textarea:focus{border-color:#9f8bff;box-shadow:0 0 0 3px #9f8bff33}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.lock{opacity:.5;pointer-events:none;filter:grayscale(20%)}
.row-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.sig-wrap{border:1px dashed #b6b4d6;border-radius:12px;overflow:hidden;background:#fff}
canvas#signature{width:100%;height:220px;display:block;touch-action:none}
.badge{display:inline-block;background:#eae6ff;color:#3a2a88;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800}
.notice{background:#13002b;color:#fff;border:1px solid #ffffff2e;border-radius:16px;padding:14px;text-align:center;margin-top:12px}
</style>
</head>
<body>
<div class="topbar">
  <div class="topbar-inner wrap">
    <div class="brand"><img src="logo.jpg" alt="AlexLivraison"></div>
    <div><a class="btn btn-ghost" href="index.html" target="_blank">Ouvrir le site</a></div>
  </div>
</div>
<main class="wrap">
  <h1 class="h1">Pharmacies • Portail Partenaire</h1>
  <section class="card">
    <h2 class="h2">Présentation</h2>
    <div class="muted">
      Livraison de produits de parapharmacie, hygiène, soins et bien-être. Assurez une livraison rapide et discrète à vos patients et clients.
    </div>
    <div class="row-actions">
      <span class="badge">Santé</span>
      <span class="badge">Discrétion</span>
      <span class="badge">Urgence</span>
    </div>
  </section>
  <section id="step1" class="card">
    <h2 class="h2">Formulaire de collaboration</h2>
    <div class="grid2">
      <div><label>Nom de l’officine</label><input id="f_enseigne"></div>
      <div><label>Catégorie</label><input id="f_cat" value="Pharmacies" readonly></div>
    </div>
    <div class="grid3">
      <div><label>Nom du pharmacien titulaire</label><input id="f_resp"></div>
      <div><label>SIREN</label><input id="f_siren"></div>
      <div><label>SIRET</label><input id="f_siret"></div>
    </div>
    <div class="grid2">
      <div><label>Adresse complète</label><input id="f_addr"></div>
      <div><label>Téléphone</label><input id="f_tel"></div>
    </div>
    <div class="grid2">
      <div><label>E-mail</label><input id="f_mail"></div>
      <div><label>Message</label><input id="f_msg"></div>
    </div>
    <div class="row-actions">
      <button id="btn_step1" class="btn btn-primary">Valider l’étape 1</button>
    </div>
  </section>
  <section id="step2" class="card lock">
    <h2 class="h2">Convention de Collaboration</h2>
    <div class="grid2">
      <div><label>Nom du signataire</label><input id="sign_name"></div>
      <div><label>Date</label><input id="sign_date" type="date"></div>
    </div>
    <div class="sig-wrap" style="margin-top:10px"><canvas id="signature"></canvas></div>
    <div class="row-actions">
      <button id="sig_clear" class="btn">Effacer la signature</button>
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="agree"> J’accepte la convention</label>
    </div>
    <div class="row-actions">
      <button id="gen_pdf" class="btn btn-primary">Signer et générer la convention (PDF)</button>
      <a id="dl_partner" class="btn" download="Convention_AlexLivraison_Pharmacie.pdf" style="display:none">Télécharger (Partenaire)</a>
      <a id="dl_alex" class="btn" download="Convention_AlexLivraison_Alex.pdf" style="display:none">Télécharger (AlexLivraison)</a>
    </div>
    <div class="notice">Après génération, vous pourrez télécharger la convention signée.</div>
  </section>
  <section id="step3" class="card lock">
    <h2 class="h2">Ajout de produits (Base Permanente)</h2>
    <form id="product-form" class="grid3">
      <div><label>Nom du produit</label><input id="p_name" placeholder="Ex: Vitamine C, Crème solaire..." required></div>
      <div><label>Prix (€)</label><input id="p_price" type="number" step="0.01" placeholder="9.90" required></div>
      <div><label>Photo</label><input id="p_photo" type="file" accept="image/*" required></div>
      <div style="grid-column:1/4"><label>Description</label><textarea id="p_desc" placeholder="Usage, composition, conseils..." required></textarea></div>
      <div style="grid-column:1/4"><button type="submit" class="btn btn-primary">Enregistrer le produit</button></div>
    </form>
    <div id="upload-status" style="margin-top:15px;font-weight:bold"></div>
  </section>
</main>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAWagPwv5Skh_EHfdcnFTYeG-xltRM7yPc",
    authDomain: "alex-livraison.firebaseapp.com",
    projectId: "alex-livraison",
    storageBucket: "alex-livraison.firebasestorage.app",
    messagingSenderId: "937475497279",
    appId: "1:937475497279:web:62dc9eba8e77a5113ec78a"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  const BOT_TOKEN="8003065650:AAGJH_PRNHQ7jVDm9q96G6zlHt-IXkxKHnA";
  const CHAT_ID="7129872491";

  const step1Btn=document.getElementById('btn_step1');
  const step2=document.getElementById('step2');
  const step3=document.getElementById('step3');
  const inputs=['f_enseigne','f_resp','f_siren','f_siret','f_addr','f_tel','f_mail'].map(id=>document.getElementById(id));
  
  step1Btn.onclick=()=>{
    for(const el of inputs){if(!el.value.trim()){alert('Veuillez compléter tous les champs obligatoires.');return}}
    step2.classList.remove('lock')
  };

  const signName=document.getElementById('sign_name');
  const signDate=document.getElementById('sign_date');
  signDate.valueAsDate=new Date();
  const canvas=document.getElementById('signature');
  const ctx=canvas.getContext('2d');
  let drawing=false;

  function resizeCanvas(){const r=canvas.getBoundingClientRect();canvas.width=r.width;canvas.height=220}
  window.addEventListener('resize',resizeCanvas);
  resizeCanvas();

  function pos(e){const rect=canvas.getBoundingClientRect();const t=e.touches?e.touches[0]:e;return{x:(t.clientX-rect.left),y:(t.clientY-rect.top)}}
  function start(e){drawing=true;const p=pos(e);ctx.beginPath();ctx.moveTo(p.x,p.y)}
  function move(e){if(!drawing)return;const p=pos(e);ctx.lineTo(p.x,p.y);ctx.lineWidth=2;ctx.lineCap='round';ctx.strokeStyle='#111';ctx.stroke()}
  function end(){drawing=false}

  canvas.addEventListener('mousedown',start);
  canvas.addEventListener('mousemove',move);
  canvas.addEventListener('mouseup',end);
  canvas.addEventListener('mouseleave',end);
  canvas.addEventListener('touchstart',e=>{start(e);e.preventDefault()},{passive:false});
  canvas.addEventListener('touchmove',e=>{move(e);e.preventDefault()},{passive:false});
  canvas.addEventListener('touchend',end);

  document.getElementById('sig_clear').onclick=()=>{ctx.clearRect(0,0,canvas.width,canvas.height)};
  const agree=document.getElementById('agree');
  const gen=document.getElementById('gen_pdf');
  const dlPartner=document.getElementById('dl_partner');
  const dlAlex=document.getElementById('dl_alex');

  gen.onclick=async()=>{
    for(const el of inputs){if(!el.value.trim()){alert('Remplissez d’abord le formulaire.');return}}
    if(!signName.value.trim()){alert('Renseignez le nom du signataire.');return}
    if(!agree.checked){alert('Veuillez accepter la convention.');return}
    
    const sigData=canvas.toDataURL('image/png');
    const {jsPDF}=window.jspdf;
    const doc=new jsPDF({unit:'pt',format:'a4'});
    const margin=48;let y=margin;
    doc.setFont('helvetica','bold');doc.setFontSize(18);
    doc.text('Convention de Collaboration - Pharmacie',margin,y);
    y+=30;
    doc.setFont('helvetica','');
    doc.setFontSize(12);
    const enseigne=document.getElementById('f_enseigne').value.trim();
    const cat=document.getElementById('f_cat').value.trim();
    const resp=document.getElementById('f_resp').value.trim();
    const siren=document.getElementById('f_siren').value.trim();
    const siret=document.getElementById('f_siret').value.trim();
    const addr=document.getElementById('f_addr').value.trim();
    const tel=document.getElementById('f_tel').value.trim();
    const mail=document.getElementById('f_mail').value.trim();
    
    const lines=[
      `Entre AlexLivraison (Atabek Zakirov) et ${enseigne} (${cat}).`,
      `Pharmacien titulaire: ${resp}`,
      `SIREN: ${siren} — SIRET: ${siret}`,
      `Adresse: ${addr}`,
      `Téléphone: ${tel} — E-mail: ${mail}`,
      'Objet: Livraison de produits de parapharmacie, hygiène et médicaments sans ordonnance.',
      'Offre spéciale: 5 livraisons gratuites lors de la signature.',
      'Engagement: partenariat d’une durée d’un an avec période d’essai de 2 semaines.',
      'Tarifs: barème en vigueur, facturation mensuelle.',
      'Engagements: confidentialité, respect des normes sanitaires et discrétion.',
      'Durée: à compter de la signature, préavis 15 jours pour résiliation.',
      'Signature électronique ci-dessous.'
    ];
    
    lines.forEach(t=>{const split=doc.splitTextToSize(t,520);doc.text(split,margin,y);y+=split.length*16});
    y+=10;
    doc.text(`Date: ${signDate.value}`,margin,y);y+=8;
    doc.text(`Signataire: ${signName.value}`,margin,y);y+=12;
    doc.addImage(sigData,'PNG',margin,y,220,110);
    y+=130;
    
    const pdfBlob=doc.output('blob');
    const url=URL.createObjectURL(pdfBlob);
    dlPartner.href=url;dlAlex.href=url;
    dlPartner.style.display='inline-block';
    dlAlex.style.display='inline-block';
    step3.classList.remove('lock');
    
    const formData=new FormData();
    formData.append('chat_id',CHAT_ID);
    formData.append('document',new File([pdfBlob],'Convention_Pharmacie.pdf',{type:'application/pdf'}));
    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendDocument`,{method:'POST',body:formData});
  };

  document.getElementById('product-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const status = document.getElementById('upload-status');
    const btn = e.target.querySelector('button');
    
    const name = document.getElementById('p_name').value;
    const price = parseFloat(document.getElementById('p_price').value);
    const desc = document.getElementById('p_desc').value;
    const file = document.getElementById('p_photo').files[0];
    const category = 'pharmacies'; 

    if(!file) return;

    btn.disabled = true;
    status.style.color = 'blue';
    status.textContent = "Téléchargement de l'image en cours...";

    try {
      const storageRef = storage.ref(`products/${Date.now()}_${file.name}`);
      const snapshot = await storageRef.put(file);
      const imageUrl = await snapshot.ref.getDownloadURL();

      status.textContent = "Enregistrement dans la base de données...";

      await db.collection('products').add({
        name: name,
        price: price,
        desc: desc,
        imageUrl: imageUrl,
        category: category,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      status.style.color = 'green';
      status.textContent = "Produit ajouté avec succès !";
      e.target.reset();

    } catch (error) {
      console.error(error);
      status.style.color = 'red';
      status.textContent = "Erreur: " + error.message;
    } finally {
      btn.disabled = false;
    }
  });
</script>
</body>
</html>
